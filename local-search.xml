<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Cacher and Blog</title>
    <link href="/2022/11/19/cacher-blog/"/>
    <url>/2022/11/19/cacher-blog/</url>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘é—²ç€æ²¡äº‹ï¼ŒåˆæŠŠ The Rust Book çœ‹äº†ä¸€éï¼Œ æŠŠç¬¬13ç« ä¸­çš„ <code>Cacher</code> å’Œç¬¬17ç« ä¸­çš„ <code>Blog</code> ä¾‹å­å®Œå–„äº†ä¸€ä¸‹ã€‚</p><h2 id="Cacher"><a href="#Cacher" class="headerlink" title="Cacher"></a>Cacher</h2><p>åœ¨åŸç‰ˆçš„åŸºç¡€ä¸Šè¿›è¡Œæ”¹è¿›ï¼š</p><ul><li>ä½¿ç”¨ <code>HashMap</code> å­˜å‚¨ <code>arg</code> åˆ° <code>value</code> çš„æ˜ å°„ï¼Œå¯¹ä¸åŒçš„ <code>arg</code> å‚æ•°ç¼“å­˜ä¸åŒçš„å€¼ï¼›</li><li>é—­åŒ…ä¸­ä½¿ç”¨æ³›å‹å‚æ•°ï¼Œå› æ­¤ <code>Cacher</code> è¿˜å¯ä»¥ç¼“å­˜å…¶ä»–ç±»å‹çš„å€¼ã€‚</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::collections::HashMap;<br><span class="hljs-keyword">use</span> std::hash::Hash;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cacher</span>&lt;T, U&gt;<br><span class="hljs-keyword">where</span><br>    T: <span class="hljs-title function_ invoke__">Fn</span>(U) <span class="hljs-punctuation">-&gt;</span> U,<br>    U: <span class="hljs-built_in">Clone</span> + <span class="hljs-built_in">Eq</span> + Hash,<br>&#123;<br>    calculation: T,<br>    value: HashMap&lt;U, U&gt;,<br>&#125;<br><br><span class="hljs-keyword">impl</span>&lt;T, U&gt; Cacher&lt;T, U&gt;<br><span class="hljs-keyword">where</span><br>    T: <span class="hljs-title function_ invoke__">Fn</span>(U) <span class="hljs-punctuation">-&gt;</span> U,<br>    U: <span class="hljs-built_in">Clone</span> + <span class="hljs-built_in">Eq</span> + Hash,<br>&#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(calculation: T) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">Self</span> &#123;<br>            calculation,<br>            value: HashMap::<span class="hljs-title function_ invoke__">new</span>(),<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">value</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, arg: U) <span class="hljs-punctuation">-&gt;</span> U &#123;<br>        <span class="hljs-keyword">self</span>.value<br>            .<span class="hljs-title function_ invoke__">entry</span>(arg.<span class="hljs-title function_ invoke__">clone</span>())<br>            .<span class="hljs-title function_ invoke__">or_insert_with</span>(|| (<span class="hljs-keyword">self</span>.calculation)(arg))<br>            .<span class="hljs-title function_ invoke__">clone</span>()<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Blog"><a href="#Blog" class="headerlink" title="Blog"></a>Blog</h2><p>åœ¨åŸç‰ˆçš„åŸºç¡€ä¸Šè¿›è¡Œå®Œå–„ï¼š</p><ul><li>å¢åŠ  <code>reject</code> æ–¹æ³•å°†åšæ–‡çš„çŠ¶æ€ä» <code>PendingReview</code> å˜å› <code>Draft</code>ï¼›</li><li>åœ¨å°†çŠ¶æ€å˜ä¸º <code>Published</code> ä¹‹å‰éœ€è¦ä¸¤æ¬¡ <code>approve</code> è°ƒç”¨ï¼›</li><li>åªå…è®¸åšæ–‡å¤„äº <code>Draft</code> çŠ¶æ€æ—¶å¢åŠ æ–‡æœ¬å†…å®¹ã€‚</li></ul><h3 id="çŠ¶æ€æ¨¡å¼"><a href="#çŠ¶æ€æ¨¡å¼" class="headerlink" title="çŠ¶æ€æ¨¡å¼"></a>çŠ¶æ€æ¨¡å¼</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Post</span> &#123;<br>    state: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> State&gt;&gt;,<br>    content: <span class="hljs-type">String</span>,<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Post</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">Self</span> &#123;<br>            state: <span class="hljs-title function_ invoke__">Some</span>(Box::<span class="hljs-title function_ invoke__">new</span>(Draft &#123;&#125;)),<br>            content: String::<span class="hljs-title function_ invoke__">new</span>(),<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">add_text</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, text: &amp;<span class="hljs-type">str</span>) &#123;<br>        <span class="hljs-keyword">self</span>.content<br>            .<span class="hljs-title function_ invoke__">push_str</span>(<span class="hljs-keyword">self</span>.state.<span class="hljs-title function_ invoke__">as_ref</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">add_text</span>(text));<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">content</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-type">str</span> &#123;<br>        <span class="hljs-keyword">self</span>.state.<span class="hljs-title function_ invoke__">as_ref</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">content</span>(<span class="hljs-keyword">self</span>)<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">request_review</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(s) = <span class="hljs-keyword">self</span>.state.<span class="hljs-title function_ invoke__">take</span>() &#123;<br>            <span class="hljs-keyword">self</span>.state = <span class="hljs-title function_ invoke__">Some</span>(s.<span class="hljs-title function_ invoke__">request_review</span>());<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">approve</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(s) = <span class="hljs-keyword">self</span>.state.<span class="hljs-title function_ invoke__">take</span>() &#123;<br>            <span class="hljs-keyword">self</span>.state = <span class="hljs-title function_ invoke__">Some</span>(s.<span class="hljs-title function_ invoke__">approve</span>());<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">reject</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(s) = <span class="hljs-keyword">self</span>.state.<span class="hljs-title function_ invoke__">take</span>() &#123;<br>            <span class="hljs-keyword">self</span>.state = <span class="hljs-title function_ invoke__">Some</span>(s.<span class="hljs-title function_ invoke__">reject</span>());<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">trait</span> <span class="hljs-title class_">State</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">request_review</span>(<span class="hljs-keyword">self</span>: <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> State&gt;;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">approve</span>(<span class="hljs-keyword">self</span>: <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> State&gt;;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">self</span>: <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> State&gt;;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">content</span>&lt;<span class="hljs-symbol">&#x27;a</span>&gt;(&amp;<span class="hljs-keyword">self</span>, _post: &amp;<span class="hljs-symbol">&#x27;a</span> Post) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">&#x27;a</span> <span class="hljs-type">str</span> &#123;<br>        <span class="hljs-string">&quot;&quot;</span><br>    &#125;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">add_text</span>&lt;<span class="hljs-symbol">&#x27;a</span>&gt;(&amp;<span class="hljs-keyword">self</span>, _text: &amp;<span class="hljs-symbol">&#x27;a</span> <span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">&#x27;a</span> <span class="hljs-type">str</span> &#123;<br>        <span class="hljs-string">&quot;&quot;</span><br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Draft</span> &#123;&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">State</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Draft</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">request_review</span>(<span class="hljs-keyword">self</span>: <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> State&gt; &#123;<br>        Box::<span class="hljs-title function_ invoke__">new</span>(PendingReview &#123;&#125;)<br>    &#125;<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">approve</span>(<span class="hljs-keyword">self</span>: <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> State&gt; &#123;<br>        <span class="hljs-keyword">self</span><br>    &#125;<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">self</span>: <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> State&gt; &#123;<br>        <span class="hljs-keyword">self</span><br>    &#125;<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">add_text</span>&lt;<span class="hljs-symbol">&#x27;a</span>&gt;(&amp;<span class="hljs-keyword">self</span>, text: &amp;<span class="hljs-symbol">&#x27;a</span> <span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">&#x27;a</span> <span class="hljs-type">str</span> &#123;<br>        text<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">PendingReview</span> &#123;&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">State</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">PendingReview</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">request_review</span>(<span class="hljs-keyword">self</span>: <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> State&gt; &#123;<br>        <span class="hljs-keyword">self</span><br>    &#125;<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">approve</span>(<span class="hljs-keyword">self</span>: <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> State&gt; &#123;<br>        Box::<span class="hljs-title function_ invoke__">new</span>(PrePublished &#123;&#125;)<br>    &#125;<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">self</span>: <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> State&gt; &#123;<br>        Box::<span class="hljs-title function_ invoke__">new</span>(Draft &#123;&#125;)<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">PrePublished</span> &#123;&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">State</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">PrePublished</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">request_review</span>(<span class="hljs-keyword">self</span>: <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> State&gt; &#123;<br>        <span class="hljs-keyword">self</span><br>    &#125;<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">approve</span>(<span class="hljs-keyword">self</span>: <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> State&gt; &#123;<br>        Box::<span class="hljs-title function_ invoke__">new</span>(Published &#123;&#125;)<br>    &#125;<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">self</span>: <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> State&gt; &#123;<br>        <span class="hljs-keyword">self</span><br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Published</span> &#123;&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">State</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Published</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">request_review</span>(<span class="hljs-keyword">self</span>: <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> State&gt; &#123;<br>        <span class="hljs-keyword">self</span><br>    &#125;<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">approve</span>(<span class="hljs-keyword">self</span>: <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> State&gt; &#123;<br>        <span class="hljs-keyword">self</span><br>    &#125;<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">content</span>&lt;<span class="hljs-symbol">&#x27;a</span>&gt;(&amp;<span class="hljs-keyword">self</span>, post: &amp;<span class="hljs-symbol">&#x27;a</span> Post) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">&#x27;a</span> <span class="hljs-type">str</span> &#123;<br>        &amp;post.content<br>    &#125;<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">self</span>: <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> State&gt; &#123;<br>        <span class="hljs-keyword">self</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="çŠ¶æ€ç¼–ç ä¸ºç±»å‹"><a href="#çŠ¶æ€ç¼–ç ä¸ºç±»å‹" class="headerlink" title="çŠ¶æ€ç¼–ç ä¸ºç±»å‹"></a>çŠ¶æ€ç¼–ç ä¸ºç±»å‹</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Post</span> &#123;<br>    content: <span class="hljs-type">String</span>,<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">DraftPost</span> &#123;<br>    content: <span class="hljs-type">String</span>,<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">PendingReviewPost</span> &#123;<br>    content: <span class="hljs-type">String</span>,<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">PrePublished</span> &#123;<br>    content: <span class="hljs-type">String</span>,<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Post</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> DraftPost &#123;<br>        DraftPost &#123;<br>            content: String::<span class="hljs-title function_ invoke__">new</span>(),<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">content</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-type">str</span> &#123;<br>        &amp;<span class="hljs-keyword">self</span>.content<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">DraftPost</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">add_text</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, text: &amp;<span class="hljs-type">str</span>) &#123;<br>        <span class="hljs-keyword">self</span>.content.<span class="hljs-title function_ invoke__">push_str</span>(text);<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">request_review</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> PendingReviewPost &#123;<br>        PendingReviewPost &#123;<br>            content: <span class="hljs-keyword">self</span>.content,<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">PendingReviewPost</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">approve</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> PrePublished &#123;<br>        PrePublished &#123;<br>            content: <span class="hljs-keyword">self</span>.content,<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> DraftPost &#123;<br>        DraftPost &#123;<br>            content: <span class="hljs-keyword">self</span>.content,<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">PrePublished</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">approve</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> Post &#123;<br>        Post &#123;<br>            content: <span class="hljs-keyword">self</span>.content,<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>rust</tag>
      
      <tag>note</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åœ¨ Windows ä¸Šå®‰è£… Rust</title>
    <link href="/2022/09/17/rust-install-windows/"/>
    <url>/2022/09/17/rust-install-windows/</url>
    
    <content type="html"><![CDATA[<h2 id="Step1ï¼šå®‰è£…-Windows-terminal"><a href="#Step1ï¼šå®‰è£…-Windows-terminal" class="headerlink" title="Step1ï¼šå®‰è£… Windows terminal"></a>Step1ï¼šå®‰è£… Windows terminal</h2><p>æ‰“å¼€ Windows åº”ç”¨å•†åº—ï¼Œæœç´¢ terminal å¹¶é€‰æ‹©ç¬¬ä¸€ä¸ªæœç´¢ç»“æœï¼Œç„¶åç‚¹å‡»ä¸‹è½½å³å¯ï¼š</p><img src="/2022/09/17/rust-install-windows/%E5%9B%BE1.png" class=""><h2 id="Step2ï¼šå®‰è£…-Chocolatey"><a href="#Step2ï¼šå®‰è£…-Chocolatey" class="headerlink" title="Step2ï¼šå®‰è£… Chocolatey"></a>Step2ï¼šå®‰è£… Chocolatey</h2><p>ä»¥ç®¡ç†å‘˜çš„èº«ä»½æ‰“å¼€ Windows terminalï¼Œç„¶åè¾“å…¥ä¸‹é¢çš„å‘½ä»¤ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">Set</span>-ExecutionPolicy Bypass -Scope Process -Force; [<span class="hljs-keyword">System</span>.Net.ServicePointManager]::SecurityProtocol = [<span class="hljs-keyword">System</span>.Net.ServicePointManager]::SecurityProtocol -bor <span class="hljs-number">3072</span>; iex ((<span class="hljs-built_in">New</span>-<span class="hljs-keyword">Object</span> <span class="hljs-keyword">System</span>.Net.WebClient).DownloadString(<span class="hljs-string">&#x27;https://community.chocolatey.org/install.ps1&#x27;</span>))<br></code></pre></td></tr></table></figure><p>å®‰è£…å®Œæˆåè¾“å…¥ <code>choco -v</code> æ£€æŸ¥ç‰ˆæœ¬ï¼Œå¦‚æœè¾“å‡ºäº†å…·ä½“çš„ç‰ˆæœ¬å·åˆ™è¡¨ç¤ºå®‰è£…æˆåŠŸã€‚</p><h2 id="Step3ï¼šå®‰è£…-mingw"><a href="#Step3ï¼šå®‰è£…-mingw" class="headerlink" title="Step3ï¼šå®‰è£… mingw"></a>Step3ï¼šå®‰è£… mingw</h2><p>ä»¥ç®¡ç†å‘˜çš„èº«ä»½æ‰“å¼€ Windows terminalï¼Œç„¶åè¾“å…¥ä¸‹é¢çš„å‘½ä»¤ï¼š</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">choco <span class="hljs-keyword">install</span> mingw -y<br></code></pre></td></tr></table></figure><p>å®‰è£…å®Œæˆåè¾“å…¥ <code>gcc --version</code> å’Œ <code>g++ --version</code>ï¼Œå¦‚æœå‡ºç°å¦‚ä¸‹çš„è¾“å‡ºåˆ™è¡¨ç¤ºå®‰è£…æˆåŠŸï¼š</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">PS C:\Users\<span class="hljs-number">25864</span>&gt; gcc --version<br>gcc.exe (MinGW-W64 x86_64-posix-<span class="hljs-keyword">seh, </span><span class="hljs-keyword">built </span><span class="hljs-keyword">by </span><span class="hljs-keyword">Brecht </span>Sanders) <span class="hljs-number">11</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span><br>Copyright (C) <span class="hljs-number">2021</span> Free Software Foundation, Inc.<br>This is free software<span class="hljs-comment">; see the source for copying conditions.  There is NO</span><br>warranty<span class="hljs-comment">; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br><br>PS C:\Users\<span class="hljs-number">25864</span>&gt; g++ --version<br>g++.exe (MinGW-W64 x86_64-posix-<span class="hljs-keyword">seh, </span><span class="hljs-keyword">built </span><span class="hljs-keyword">by </span><span class="hljs-keyword">Brecht </span>Sanders) <span class="hljs-number">11</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span><br>Copyright (C) <span class="hljs-number">2021</span> Free Software Foundation, Inc.<br>This is free software<span class="hljs-comment">; see the source for copying conditions.  There is NO</span><br>warranty<span class="hljs-comment">; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br></code></pre></td></tr></table></figure><h2 id="Step4ï¼šå®‰è£…-Rust"><a href="#Step4ï¼šå®‰è£…-Rust" class="headerlink" title="Step4ï¼šå®‰è£… Rust"></a>Step4ï¼šå®‰è£… Rust</h2><p>æ‰“å¼€ Rust çš„å®˜ç½‘ï¼š<a href="https://www.rust-lang.org/zh-CN/tools/install">https://www.rust-lang.org/zh-CN/tools/install</a> ï¼Œç‚¹å‡»ä¸‹è½½ RUSTUP-INIT.EXEï¼ˆ64ä½ï¼‰ï¼š</p><img src="/2022/09/17/rust-install-windows/%E5%9B%BE2.png" class=""><p>æ‰“å¼€åˆšåˆšä¸‹è½½å®Œçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼š</p><img src="/2022/09/17/rust-install-windows/%E5%9B%BE3.png" class=""><p>é€‰æ‹© 3) Donâ€™t install the prerequisitesï¼š</p><img src="/2022/09/17/rust-install-windows/%E5%9B%BE4.png" class=""><p>é€‰æ‹© 2) Customize installationï¼š</p><img src="/2022/09/17/rust-install-windows/%E5%9B%BE5.png" class=""><p>æ¥ä¸‹æ¥ä¼šè¾“å…¥å››ä¸ªå¯é€‰é¡¹ï¼š</p><img src="/2022/09/17/rust-install-windows/%E5%9B%BE6.png" class=""><p>ç„¶åè¾“å…¥ 1 å³å¯å¼€å§‹å®‰è£…ã€‚</p><h2 id="Step5ï¼šéªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸ"><a href="#Step5ï¼šéªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸ" class="headerlink" title="Step5ï¼šéªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸ"></a>Step5ï¼šéªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸ</h2><p>æ‰“å¼€ Windows terminalï¼Œè¾“å…¥ <code>rustc --version --verbose</code>ï¼Œå¦‚æœå‡ºç°å¦‚ä¸‹è¾“å‡ºåˆ™è¡¨ç¤ºå®‰è£…æˆåŠŸï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust">PS C:\Users\<span class="hljs-number">25864</span>&gt; rustc --version --verbose<br>rustc <span class="hljs-number">1.65</span>.<span class="hljs-number">0</span>-<span class="hljs-title function_ invoke__">nightly</span> (<span class="hljs-number">95</span>a992a68 <span class="hljs-number">2022</span>-<span class="hljs-number">09</span>-<span class="hljs-number">16</span>)<br>binary: rustc<br>commit-hash: <span class="hljs-number">95</span>a992a68694d8bf3959bd2c0ac27ce9e9208b59<br>commit-date: <span class="hljs-number">2022</span>-<span class="hljs-number">09</span>-<span class="hljs-number">16</span><br>host: x86_64-pc-windows-gnu<br>release: <span class="hljs-number">1.65</span>.<span class="hljs-number">0</span>-nightly<br>LLVM version: <span class="hljs-number">15.0</span>.<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>æœ€åé€šè¿‡å®‰è£…ä¸€ä¸ª Rust å‘½ä»¤è¡Œå·¥å…·æ¥æŸ¥çœ‹ Cargo æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚åœ¨ Windows terminal ä¸­è¾“å…¥ <code>cargo install onefetch</code>ï¼Œå¦‚æœå‡ºç°å¦‚ä¸‹è¾“å‡ºåˆ™è¡¨ç¤º Cargo èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs rust"> ......<br> ......<br> Compiling ansi_term v0.<span class="hljs-number">12.1</span><br> Compiling owo-colors v3.<span class="hljs-number">5.0</span><br> Compiling zstd v0.<span class="hljs-number">11.2</span>+zstd.<span class="hljs-number">1.5</span>.<span class="hljs-number">2</span><br> Compiling askalono v0.<span class="hljs-number">4.6</span><br> Compiling git2 v0.<span class="hljs-number">14.4</span><br> Compiling onefetch v2.<span class="hljs-number">12.0</span><br>  Finished release [optimized] <span class="hljs-title function_ invoke__">target</span>(s) <span class="hljs-keyword">in</span> <span class="hljs-number">5</span>m <span class="hljs-number">59</span>s<br>Installing C:\Users\<span class="hljs-number">25864</span>\.cargo\bin\onefetch.exe<br> Installed package `onefetch v2.<span class="hljs-number">12.0</span>` (executable `onefetch.exe`)<br></code></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://chocolatey.org/install#individual">https://chocolatey.org/install#individual</a></li><li><a href="https://www.rust-lang.org/zh-CN/tools/install">https://www.rust-lang.org/zh-CN/tools/install</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>rust</category>
      
    </categories>
    
    
    <tags>
      
      <tag>rust</tag>
      
      <tag>windows</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Sharded Key/Value Service</title>
    <link href="/2022/09/02/Sharded-Key-Value-Service/"/>
    <url>/2022/09/02/Sharded-Key-Value-Service/</url>
    
    <content type="html"><![CDATA[<p>6.824 çš„ LAB 4 çš„å†…å®¹æ˜¯æ„å»ºä¸€ä¸ªåˆ†ç‰‡çš„åˆ†å¸ƒå¼ KV å­˜å‚¨ç³»ç»Ÿã€‚åˆ†ç‰‡æ˜¯ Key&#x2F;Value å¯¹çš„å­é›†ã€‚ä¾‹å¦‚ï¼Œæ‰€æœ‰ä»¥ â€œaâ€ å¼€å¤´çš„ Key å¯èƒ½æ˜¯ä¸€ä¸ªåˆ†ç‰‡ï¼Œæ‰€æœ‰ä»¥ â€œbâ€ å¼€å¤´çš„ Key å¯èƒ½æ˜¯å¦ä¸€ä¸ªåˆ†ç‰‡ã€‚åˆ†ç‰‡çš„ç›®çš„æ˜¯è·å–æ›´å¥½çš„æ€§èƒ½ï¼Œæ¯ä¸ªå‰¯æœ¬ç»„åªè´Ÿè´£å‡ ä¸ªåˆ†ç‰‡çš„ puts å’Œ getsï¼Œå½“è®¿é—®çš„åˆ†ç‰‡å¤„äºä¸åŒçš„å‰¯æœ¬ç»„æ—¶ï¼Œè¿™äº›æ“ä½œå°±å¯ä»¥å¹¶è¡Œåœ°æ‰§è¡Œã€‚å› æ­¤ï¼Œç³»ç»Ÿçš„æ€»ååé‡ä¸å‰¯æœ¬ç»„çš„æ•°é‡æˆæ­£æ¯”ã€‚</p><p>åˆ†ç‰‡ KV å­˜å‚¨ç³»ç»ŸåŒ…æ‹¬ä¸¤ä¸ªä¸»è¦ç»„ä»¶ï¼š</p><ul><li>ä¸€ç»„å‰¯æœ¬ç»„ã€‚æ¯ä¸ªå‰¯æœ¬ç»„è´Ÿè´£åˆ†ç‰‡çš„ä¸€ä¸ªå­é›†ï¼Œå¹¶ç”±å°‘æ•°ä½¿ç”¨ Raft å¤åˆ¶åˆ†ç‰‡çš„æœåŠ¡å™¨ç»„æˆï¼›</li><li>åˆ†ç‰‡æ§åˆ¶å™¨ã€‚åˆ†ç‰‡æ§åˆ¶å™¨å†³å®šä¸€ä¸ªå‰¯æœ¬ç»„è´Ÿè´£å“ªäº›åˆ†ç‰‡ï¼Œè¿™ä¸ªä¿¡æ¯è¢«ç§°ä¸ºé…ç½®ã€‚å®¢æˆ·ç«¯è¯¢é—®åˆ†ç‰‡æ§åˆ¶å™¨æ‰¾åˆ° Key å¯¹åº”çš„å‰¯æœ¬ç»„ï¼Œå‰¯æœ¬ç»„è¯¢é—®åˆ†ç‰‡æ§åˆ¶å™¨æ‰¾åˆ°è¦æœåŠ¡çš„åˆ†ç‰‡ã€‚æ•´ä¸ªç³»ç»Ÿæœ‰ä¸€ä¸ªå•ä¸€çš„åˆ†ç‰‡æ§åˆ¶å™¨ï¼Œä½¿ç”¨ Raft    ä½œä¸ºå®¹é”™æœåŠ¡å®ç°ã€‚</li></ul><p>LAB 4 å®éªŒçš„ä¸»è¦æŒ‘æˆ˜å°†æ˜¯å¤„ç†é‡æ–°é…ç½®â€”â€”å°†åˆ†ç‰‡åˆ†é…ç»™å‰¯æœ¬ç»„çš„æ›´æ”¹ã€‚åœ¨ä¸€ä¸ªå‰¯æœ¬ç»„ä¸­ï¼Œæ‰€æœ‰çš„æœåŠ¡å™¨å¿…é¡»å°±ä½•æ—¶åº”ç”¨æ–°çš„é…ç½®è¾¾æˆä¸€è‡´ã€‚ä¾‹å¦‚ï¼ŒPut å¯èƒ½ä¸é‡æ–°é…ç½®åŒæ—¶åˆ°è¾¾ï¼Œå¯¼è‡´å‰¯æœ¬ç»„ä¸å†è´Ÿè´£å¯¹åº”çš„ Keyã€‚å‰¯æœ¬ç»„ä¸­çš„æœåŠ¡å™¨å¿…é¡»å°± Put å‘ç”Ÿåœ¨é‡æ–°é…ç½®ä¹‹å‰è¿˜æ˜¯ä¹‹åè¾¾æˆä¸€è‡´ã€‚å¦‚æœä¹‹å‰ï¼ŒPut åº”è¯¥ç”Ÿæ•ˆï¼Œåˆ†ç‰‡çš„æ–°æ‰€æœ‰è€…åº”è¯¥çœ‹åˆ°å®ƒçš„æ•ˆæœï¼›å¦‚æœä¹‹åï¼ŒPut å°†ä¸ä¼šç”Ÿæ•ˆï¼Œå®¢æˆ·ç«¯å¿…é¡»åœ¨æ–°æ‰€æœ‰è€…å¤„é‡æ–°å°è¯•ã€‚</p><p>é‡æ–°é…ç½®è¿˜éœ€è¦å‰¯æœ¬ç»„ä¹‹é—´çš„äº¤äº’ã€‚ä¾‹å¦‚ï¼Œåœ¨é…ç½® 10 ä¸­ï¼Œå‰¯æœ¬ç»„ G1 å¯èƒ½è´Ÿè´£åˆ†ç‰‡ S1ã€‚åœ¨é…ç½® 11 ä¸­ï¼Œå‰¯æœ¬ç»„ G2 å¯èƒ½è´Ÿè´£åˆ†ç‰‡ S1ã€‚åœ¨ä» 10 åˆ° 11 çš„é‡æ–°é…ç½®è¿‡ç¨‹ä¸­ï¼ŒG1 å’Œ G2 å¿…é¡»ä½¿ç”¨ RPC å°†åˆ†ç‰‡ S1 ä» G1 ç§»åŠ¨åˆ° G2ã€‚</p><h2 id="LAB-4A"><a href="#LAB-4A" class="headerlink" title="LAB 4A"></a>LAB 4A</h2><p>LAB 4A çš„å†…å®¹æ˜¯å®ç°åˆ†ç‰‡æ§åˆ¶å™¨ï¼Œæ”¯æŒæ·»åŠ æ–°çš„å‰¯æœ¬ç»„ã€æ¸…é™¤å‰¯æœ¬ç»„ä»¥åŠåœ¨å‰¯æœ¬ç»„ä¹‹é—´ç§»åŠ¨åˆ†ç‰‡ã€‚LAB 4A çš„å®ç°éå¸¸ç®€å•ï¼Œé™¤äº†æ²¡æœ‰ä½¿ç”¨å¿«ç…§ä¹‹å¤–ï¼Œè·Ÿ LAB 3 çš„å®ç°éå¸¸ç›¸ä¼¼ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“åˆ›å»ºæ–°çš„é…ç½®æ—¶ï¼Œä¸è¦æŠŠä¹‹å‰çš„é…ç½®çš„ <code>Groups</code> èµ‹å€¼ç»™æ–°çš„é…ç½®ï¼ˆå› ä¸º <code>Groups</code> æ˜¯å¼•ç”¨ç±»å‹ï¼‰ï¼Œå®ç°å®Œåè·‘ä¸€ä¸‹æµ‹è¯•ï¼š</p><img src="/2022/09/02/Sharded-Key-Value-Service/%E5%9B%BE1.png" class=""><h2 id="LAB-4B"><a href="#LAB-4B" class="headerlink" title="LAB 4B"></a>LAB 4B</h2><p>LAB 4B çš„å†…å®¹æ˜¯å®ç°åˆ†ç‰‡ KV å­˜å‚¨ç³»ç»Ÿï¼Œä¸ºä½¿ç”¨å®¢æˆ·ç«¯æ¥å£çš„åº”ç”¨ç¨‹åºæä¾›å¯çº¿æ€§åŒ–çš„æ¥å£ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹ Getã€Put å’Œ Append æ–¹æ³•çš„å®Œæ•´åº”ç”¨ç¨‹åºè°ƒç”¨å¿…é¡»ä»¥ç›¸åŒçš„é¡ºåºå½±å“æ‰€æœ‰å‰¯æœ¬ã€‚ Get åº”è¯¥çœ‹åˆ°æœ€è¿‘çš„ Put&#x2F;Append å†™å…¥åˆ°åŒä¸€ä¸ª Key çš„å€¼ã€‚å³ä½¿ Gets å’Œ Puts ä¸é…ç½®æ›´æ”¹å‡ ä¹åŒæ—¶åˆ°è¾¾ï¼Œä¹Ÿå¿…é¡»å¦‚æ­¤ã€‚</p><p>æ¯ä¸ª shardkv æœåŠ¡å™¨éƒ½ä½œä¸ºå‰¯æœ¬ç»„çš„ä¸€éƒ¨åˆ†è¿è¡Œã€‚æ¯ä¸ªå‰¯æœ¬ç»„ä¸ºæŸäº›åˆ†ç‰‡çš„ Key æä¾› Getã€Put å’Œ Append æ“ä½œã€‚</p><h3 id="Hint"><a href="#Hint" class="headerlink" title="Hint"></a>Hint</h3><p>æˆ‘å†™å®Œç¬¬ä¸€ç‰ˆä»£ç ååªé€šè¿‡äº†å‰é¢ä¸‰ä¸ªæµ‹è¯•ï¼Œç¬¬å››ä¸ªæµ‹è¯•ä¸€ç›´æŠ¥é”™ Get æ“ä½œè¿”å›äº†é”™è¯¯çš„å€¼ã€‚æˆ‘åå¤æ£€æŸ¥äº†ä»£ç éƒ½æ²¡æ‰¾åˆ°ä»€ä¹ˆé—®é¢˜ï¼Œäºæ˜¯å°±å»ä»”ç»†çœ‹äº†ä¸€ä¸‹å®éªŒç»™çš„æç¤ºï¼Œç»ˆäºå‘ç°äº†é—®é¢˜çš„æ‰€åœ¨ã€‚</p><p>æç¤ºé‡Œé¢ç»™å‡ºäº†éå¸¸å…³é”®çš„ä¿¡æ¯ï¼šâ€Process re-configurations one at a time, in order.â€ï¼Œå³åº”è¯¥æŒ‰ç…§é¡ºåºä¸€æ¬¡å¤„ç†ä¸€ä¸ªé‡æ–°é…ç½®ã€‚åœ¨æˆ‘ä¹‹å‰çš„å®ç°ä¸­å‰¯æœ¬ç»„çš„ Leader ä»¥100MSçš„é¢‘ç‡å‘åˆ†ç‰‡æ§åˆ¶å™¨è¯¢é—®æœ€æ–°é…ç½®ï¼Œå¦‚æœé…ç½®å·å¤§äºå½“å‰çš„é…ç½®ï¼Œé‚£ä¹ˆå°±å¼€å§‹è¿›è¡Œåˆ†ç‰‡è¿ç§»ï¼Œåœ¨åˆ†ç‰‡è¿ç§»å®Œæˆåè¿›åŒ–åˆ°æ–°çš„é…ç½®ã€‚ä½†è¿™æ ·æ˜¯æœ‰é—®é¢˜çš„ï¼Œå‡è®¾æœ‰å¦‚ä¸‹çš„åœºæ™¯ï¼š</p><img src="/2022/09/02/Sharded-Key-Value-Service/%E5%9B%BE4.png" class=""><br><p>Server 1 å’Œ Server 2 åˆå§‹çŠ¶æ€éƒ½æ˜¯é…ç½®1ï¼Œæ­¤æ—¶ Server 2 å‘åˆ†ç‰‡æ§åˆ¶å™¨è¯¢é—®æœ€æ–°çš„é…ç½®ï¼Œåˆ†ç‰‡æ§åˆ¶å™¨è¿”å›äº†é…ç½®3ã€‚Server 2 æ ¹æ®é…ç½®3å‘ Server 1 å‘é€åˆ†ç‰‡2çš„è¯·æ±‚ï¼Œä½†æ˜¯ Server 1 ä¸æ‹¥æœ‰åˆ†ç‰‡2ï¼Œäºæ˜¯ Server 1ä¼šè¿”å›ç©ºæ•°æ®æˆ–è€…æ— ç”¨çš„åƒåœ¾æ•°æ®ï¼ŒServer 2 ä¼šæŠŠè¿”å›çš„åƒåœ¾æ•°æ®ä¿å­˜èµ·æ¥ï¼Œä¹‹åå¦‚æœæœ‰å®¢æˆ·ç«¯å‘ Server 2 å‘é€ Get è¯·æ±‚ï¼Œé‚£ä¹ˆ Server 2 å°±ä¼šè¿”å›é”™è¯¯çš„å€¼ã€‚</p><p>åŸå› æ˜¯å‰¯æœ¬ç»„æ²¡æœ‰æŒ‰ç…§é¡ºåºå¤„ç†é‡æ–°é…ç½®ï¼ŒServer 2 ä¸åº”è¯¥è·³è¿‡é…ç½®2ç›´æ¥åˆ°è¾¾é…ç½®3ï¼Œè€Œæ˜¯è¦å…ˆåˆ°è¾¾é…ç½®2ï¼Œå†åˆ°è¾¾é…ç½®3ã€‚</p><p>ä½†å³ä½¿è¿™æ ·è¿˜éœ€è¦é¢å¤–çš„åˆ¤æ–­æ‰èƒ½ä¿è¯æ­£ç¡®æ€§ï¼Œå‡è®¾å‰¯æœ¬ç»„æŒ‰ç…§é¡ºåºä¸€æ¬¡å¤„ç†ä¸€ä¸ªé‡æ–°é…ç½®ï¼Œæœ‰å¦‚ä¸‹çš„åœºæ™¯ï¼š</p><img src="/2022/09/02/Sharded-Key-Value-Service/%E5%9B%BE3.png" class=""><br><p>Server 1 åˆå§‹çŠ¶æ€æ˜¯é…ç½®1ï¼ŒServer 2 åˆå§‹çŠ¶æ€æ˜¯é…ç½®2ã€‚æ­¤æ—¶ Server 2 å‘åˆ†ç‰‡æ§åˆ¶å™¨è¯¢é—®æœ€æ–°çš„é…ç½®ï¼Œåˆ†ç‰‡æ§åˆ¶å™¨è¿”å›äº†é…ç½®3ã€‚Server 2 æ ¹æ®é…ç½®3å‘ Server 1 å‘é€åˆ†ç‰‡2çš„è¯·æ±‚ï¼Œä½†æ˜¯ Server 1 ä¸æ‹¥æœ‰åˆ†ç‰‡2ï¼Œäºæ˜¯ Server 1ä¼šè¿”å›ç©ºæ•°æ®æˆ–è€…æ— ç”¨çš„åƒåœ¾æ•°æ®ï¼ŒServer 2 ä¼šæŠŠè¿”å›çš„åƒåœ¾æ•°æ®ä¿å­˜èµ·æ¥ï¼Œä¹‹åå¦‚æœæœ‰å®¢æˆ·ç«¯å‘ Server 2 å‘é€ Get è¯·æ±‚ï¼Œé‚£ä¹ˆ Server 2 å°±ä¼šè¿”å›é”™è¯¯çš„å€¼ã€‚</p><p>åŸå› æ˜¯ Server 2 çš„é…ç½®é«˜äº Server 1ï¼ŒServer 1åˆ°è¾¾é…ç½®2åæ‰ä¼šæ‹¥æœ‰åˆ†ç‰‡2ã€‚å› æ­¤å½“ä¸€ä¸ª Server æ¥æ”¶åˆ°è¯·æ±‚åˆ†ç‰‡çš„ RPC æ—¶ï¼Œéœ€è¦å…ˆåˆ¤æ–­è¯·æ±‚åˆ†ç‰‡çš„é…ç½®å·æ˜¯å¦é«˜äºæœ¬æœåŠ¡å™¨å½“å‰çš„é…ç½®ï¼Œå¦‚æœé«˜äºåˆ™è¿”å›ä¸€ä¸ªé”™è¯¯æç¤ºå‘Šè¯‰å¯¹æ–¹ä½ è¦æ±‚çš„åˆ†ç‰‡çš„é…ç½®å¤ªé«˜äº†ï¼Œå¦åˆ™å°±å¯ä»¥å®‰å…¨åœ°æŠŠåˆ†ç‰‡å‘é€ç»™å¯¹æ–¹ã€‚</p><h3 id="Bug"><a href="#Bug" class="headerlink" title="Bug"></a>Bug</h3><p>å†è¯´ä¸€è¯´åœ¨å®ç° LAB 4B çš„è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€ä¸ªå° Bugã€‚åœ¨æˆ‘çš„ä¹‹å‰çš„å®ç°ä¸­ï¼Œæ¯å½“æœåŠ¡å™¨è¿”å›ä¸€ä¸ªåˆ†ç‰‡ç»™è¯·æ±‚æ–¹æ—¶ï¼Œéƒ½ä¼šç›´æ¥æŠŠè¿™ä¸ªåˆ†ç‰‡å¯¹åº”çš„ GID è®¾ç½®ä¸º0ï¼Œè¡¨ç¤ºä¸å†æ‹¥æœ‰è¿™ä¸ªåˆ†ç‰‡ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *ShardKV)</span></span> doShard(command *Op) NotifyMsg &#123;<br><span class="hljs-comment">// ....</span><br>    <span class="hljs-comment">// ....</span><br><span class="hljs-keyword">for</span> _, shard := <span class="hljs-keyword">range</span> command.Shards &#123;<br><span class="hljs-comment">// ....</span><br>        <span class="hljs-comment">// ....</span><br>kv.config.Shards[shard] = <span class="hljs-number">0</span><br>&#125;<br><br><span class="hljs-keyword">return</span> notifyMsg<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†è¿™æ ·åšæ˜¯æœ‰é—®é¢˜çš„ï¼Œå‡è®¾æœ‰å¦‚ä¸‹çš„åœºæ™¯ï¼š</p><img src="/2022/09/02/Sharded-Key-Value-Service/%E5%9B%BE5.png" class=""><br><p>Server 1 å·²ç»åˆ°è¾¾äº†é…ç½®2ï¼ŒServer 2 åˆ°è¾¾äº†é…ç½®1ã€‚æ­¤æ—¶ Server 2 å‘åˆ†ç‰‡æ§åˆ¶å™¨è¯¢é—®æœ€æ–°çš„é…ç½®ï¼Œåˆ†ç‰‡æ§åˆ¶å™¨è¿”å›äº†é…ç½®2ï¼ŒServer 2 æ ¹æ®é…ç½®2å‘ Server 1 å‘é€åˆ†ç‰‡1çš„è¯·æ±‚ï¼ŒServer 1å°±æŠŠåˆ†ç‰‡1çš„æ•°æ®è¿”å›ç»™ Server 2ï¼Œå¹¶ç›´æ¥æŠŠ <code>kv.config.Shards[1]</code> è®¾ç½®ä¸º0ã€‚</p><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå½“ Server 1 æƒ³è¦åˆ°è¾¾é…ç½® 3 æ—¶ éœ€è¦åˆ†ç‰‡1çš„æ•°æ®ï¼Œä½†æ˜¯ Server 1å·²ç»æŠŠ <code>kv.config.Shards[1]</code> ç½®ä¸º0äº†ï¼Œå› æ­¤ Server 1 æ— æ³•çŸ¥é“ç°åœ¨æ˜¯è°æ‹¥æœ‰åˆ†ç‰‡1ã€‚</p><p>è§£å†³æ–¹æ³•å¾ˆç®€å•ï¼ŒåŠ ä¸€ä¸ªé¢å¤–çš„åˆ¤æ–­å³å¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> kv.config.Shards[shard] == kv.gid &#123;<br>kv.config.Shards[shard] = <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœ Server 1 å·²ç»åˆ°äº†é…ç½®2ï¼Œåˆ™ä¸æŠŠ <code>kv.config.Shards[shard]</code> è®¾ç½®ä¸º0ã€‚</p><h3 id="Challenge-1"><a href="#Challenge-1" class="headerlink" title="Challenge 1"></a>Challenge 1</h3><p>æŒ‘æˆ˜1æ˜¯åƒåœ¾çŠ¶æ€æ”¶é›†ï¼Œå³å½“ä¸€ä¸ªå‰¯æœ¬ç»„å¤±å»å¯¹åˆ†ç‰‡çš„æ‰€æœ‰æƒæ—¶ï¼Œå‰¯æœ¬ç»„åº”è¯¥æŠŠç›¸åº”çš„åˆ†ç‰‡æ•°æ®åˆ é™¤ã€‚</p><p>æœ€ç®€å•çš„åŠæ³•æ˜¯ï¼Œåœ¨ä¸€ä¸ªå‰¯æœ¬ç»„è¿”å›åˆ†ç‰‡ç»™è¯·æ±‚è€…åå°±ç«‹é©¬æŠŠè¿™ä¸ªåˆ†ç‰‡çš„æ•°æ®åˆ æ‰ã€‚ä½†è¿™æ ·æ˜¯æœ‰é—®é¢˜çš„ï¼Œç”±äºç½‘ç»œçš„ä¸å¯é æ€§ï¼Œè¯·æ±‚è€…å¯èƒ½æ²¡æœ‰æ”¶åˆ°è¿”å›çš„åˆ†ç‰‡æ•°æ®ï¼Œä¹‹åè¿™ä¸ªè¯·æ±‚è€…å°±ä¼šé‡è¯•ï¼Œä½†æ­¤æ—¶å‰¯æœ¬ç»„å·²ç»æŠŠè¿™ä¸ªåˆ†ç‰‡åˆ æ‰äº†ï¼Œè¯·æ±‚è€…ä¸å¯èƒ½å†æ‹¿åˆ°è¿™ä¸ªåˆ†ç‰‡äº†ã€‚</p><p>è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œå‰¯æœ¬ç»„è¿”å›åˆ†ç‰‡ç»™è¯·æ±‚è€…åä¸ç«‹å³åˆ æ‰è¿™ä¸ªåˆ†ç‰‡ã€‚åœ¨è¯·æ±‚è€…è®¾ç½®å¥½åˆ†ç‰‡åï¼Œå†å‘é€æ¶ˆæ¯ç»™åˆ†ç‰‡çš„åŸæ¥çš„æŒæœ‰è€…ï¼šå‘Šè¯‰å®ƒè¿™ä¸ªåˆ†ç‰‡æˆ‘å·²ç»æ‹¿åˆ°äº†ï¼Œä½ å¯ä»¥æŠŠè¿™ä¸ªåˆ†ç‰‡çš„æ•°æ®åˆ æ‰äº†ã€‚è¿™æ ·å‰¯æœ¬ç»„å°±èƒ½å®‰å…¨åœ°åˆ é™¤æ‰åˆ†ç‰‡äº†ã€‚</p><p>å½“ç„¶ï¼Œè¿™é‡Œé¢è¿˜æœ‰ä¸€äº›ç»†èŠ‚æ€§çš„åˆ¤æ–­ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ã€‚</p><h3 id="Challenge-2"><a href="#Challenge-2" class="headerlink" title="Challenge 2"></a>Challenge 2</h3><p>æŒ‘æˆ˜2æ˜¯åœ¨é…ç½®æ›´æ”¹æœŸé—´èƒ½å¤Ÿå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼š</p><ul><li>åœ¨é…ç½®æ›´æ”¹æœŸé—´ï¼Œå¦‚æœä¸€ä¸ªåˆ†ç‰‡æ²¡æœ‰æ”¶åˆ°å½±å“ï¼Œé‚£ä¹ˆå‘é€åˆ°è¿™ä¸ªåˆ†ç‰‡çš„è¯·æ±‚èƒ½å¤Ÿç»§ç»­æ‰§è¡Œï¼›</li><li>åœ¨é…ç½®æ›´æ”¹æœŸé—´ï¼Œå½“å‰¯æœ¬ç»„æ”¶åˆ°å®ƒéœ€è¦çš„ä¸€ä¸ªåˆ†ç‰‡æ—¶ï¼Œè¿™ä¸ªå‰¯æœ¬ç»„å¯ä»¥ç«‹é©¬ä¸ºè¿™ä¸ªåˆ†ç‰‡æä¾›æœåŠ¡ã€‚</li></ul><p>ç¬¬ä¸€ä¸ªé—®é¢˜å¾ˆç®€å•ï¼Œåªè¦ä¸åœ¨é…ç½®æ›´æ”¹æœŸé—´ç¦ç”¨å®¢æˆ·ç«¯è¯·æ±‚å°±å¯ä»¥é€šè¿‡è¿™ä¸ªæµ‹è¯•ã€‚</p><p>å¯¹äºç¬¬äºŒä¸ªé—®é¢˜ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯ï¼šåœ¨å‰¯æœ¬ç»„å¾—åˆ°ä¸€ä¸ªåˆ†ç‰‡åï¼Œå°±åˆ›å»ºä¸€ä¸ªè®¾ç½®åˆ†ç‰‡çš„æ“ä½œæäº¤åˆ° Raft ä¸­ï¼Œå½“è¿™ä¸ªæ“ä½œè¢«å¤åˆ¶åˆ°å¤šæ•°èŠ‚ç‚¹åï¼Œå°±æ‰§è¡Œè¿™ä¸ªæ“ä½œï¼ŒæŠŠåˆ†ç‰‡ä¿å­˜åˆ°æœåŠ¡å™¨çŠ¶æ€ä¸­ï¼Œä¹‹åå°±å¯ä»¥ä¸ºè¿™ä¸ªåˆ†ç‰‡æä¾›æœåŠ¡äº†ã€‚è¿™æ ·å°±ä¸éœ€è¦ç­‰å¾…åˆ°è¾¾æ–°çš„é…ç½®å°±å¯ä»¥ä¸ºæ–°çš„åˆ†ç‰‡æä¾›æœåŠ¡äº†ã€‚</p><p>è§£å†³å®Œæ‰€æœ‰çš„ Bug å¹¶å®ç°ä¸¤ä¸ªæŒ‘æˆ˜åï¼Œè·‘ä¸€ä¸‹æµ‹è¯•ï¼š</p><img src="/2022/09/02/Sharded-Key-Value-Service/%E5%9B%BE2.png" class=""><h2 id="éš¾åº¦æ’åº"><a href="#éš¾åº¦æ’åº" class="headerlink" title="éš¾åº¦æ’åº"></a>éš¾åº¦æ’åº</h2><p>ç»ˆäºæŠŠ 6.824 çš„æ‰€æœ‰ LAB éƒ½åšå®Œäº†ï¼Œç»“åˆæˆ‘è‡ªå·±å®ç° LAB çš„ç»å†ç»™è¿™4ä¸ª LAB çš„éš¾åº¦åšä¸€ä¸ªæ’åºå§ï¼š</p><ol><li>LAB 2ã€‚LAB 2 çš„éš¾åº¦æœ€é«˜ï¼Œæˆ‘è®¤ä¸ºä¸»è¦æ˜¯æ¯”è¾ƒéš¾ Debugï¼Œæµ‹è¯•æŠ¥é”™åå¾ˆå¤šæ—¶å€™éƒ½æœ‰ä¸Šä¸‡è¡Œçš„æ—¥å¿—ï¼Œé™¤äº†çœ‹æ—¥å¿—ä»¥å¤–æ²¡æœ‰ä»€ä¹ˆå¥½çš„ Debug æ–¹æ³•ã€‚æˆ‘åœ¨åš LAB 2A çš„æ—¶å€™å‚è€ƒäº† Github ä¸Šçš„ä¸€ä¸ª Raft çš„å¼€æºå®ç°ï¼Œä¸»è¦æ˜¯çœ‹ä¸€ä¸‹éœ€è¦å®šä¹‰å“ªäº›å­—æ®µå’Œæ–¹æ³•ï¼Œå› ä¸ºæˆ‘åˆšå¼€å§‹åšçš„æ—¶å€™å®Œå…¨ä¸çŸ¥é“ä»å“ªå„¿ä¸‹æ‰‹ğŸ˜¥ã€‚ç„¶å 2Bã€2Cã€2D éƒ½æ˜¯æˆ‘å®Œå…¨ç‹¬ç«‹å®Œæˆçš„ï¼›</li><li>LAB 4ã€‚LAB 4 çš„éš¾åº¦æ¯” LAB 2 çš„éš¾åº¦ä½ä¸€ç‚¹ï¼Œä½†æ˜¯è¿œé«˜äº LAB 3 å’Œ LAB 1 çš„éš¾åº¦ã€‚LAB 4A å’Œ 4B çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯æˆ‘è‡ªå·±ç‹¬ç«‹å®Œæˆçš„ï¼ŒåŒ…æ‹¬ 4B çš„æœ€åä¸¤ä¸ªæŒ‘æˆ˜ç»ƒä¹ ã€‚LAB 4 çš„ç¬¬ä¸€ç‰ˆä»£ç æˆ‘å¾ˆå¿«å°±å†™å®Œäº†ï¼Œä½†æ˜¯åªèƒ½é€šè¿‡å‰3ä¸ªæµ‹è¯•ï¼Œç›´åˆ°çœ‹åˆ° â€œProcess re-configurations one at a time, in order.â€ æç¤ºæ‰ç›´åˆ°è‡ªå·±å“ªå„¿é”™äº†ï¼Œä¹‹ååªæ”¹åŠ¨å‡ è¡Œä»£ç å°±é€šè¿‡äº†å‰é¢çš„æµ‹è¯•ã€‚å†ä¹‹åå°±æ…¢æ…¢åœ°æƒ³è¦æ€ä¹ˆå®ç°æœ€åçš„ä¸¤ä¸ªæŒ‘æˆ˜ç»ƒä¹ ï¼Œç»è¿‡æ€è€ƒåä¹Ÿæ˜¯é¡ºåˆ©åœ°å®Œæˆäº†ä»£ç ï¼›</li><li>LAB 3ã€‚LAB 3 çš„éš¾åº¦æœ¬æ¥æŒºä½çš„ï¼Œä½†æ˜¯æˆ‘åœ¨ LAB 3A å¡äº†æ¥è¿‘ä¸€å¤©ï¼ŒåŸå› æ˜¯æˆ‘æŠŠ LAB 3 çš„æ¶æ„æé”™äº†ï¼ˆå…·ä½“å¯è§ä¹‹å‰çš„æ–‡ç« ï¼‰ï¼Œæˆ‘çœ‹äº†ä¸€ä¸‹åˆ«äººçš„å®ç°æ€è·¯åæ‰çŸ¥é“è‡ªå·±ç«Ÿç„¶çŠ¯äº†è¿™ä¹ˆä½çº§é”™è¯¯ï¼Œä¹‹åæ”¹äº†10æ¥è¡Œä»£ç å°±é€šè¿‡æ‰€æœ‰æµ‹è¯•äº†ãƒ½(âœ¿ï¾Ÿâ–½ï¾Ÿ)ãƒï¼›</li><li>LAB 1ã€‚LAB 1 çš„éš¾åº¦æœ€ä½ï¼Œæˆ‘æ„Ÿè§‰ LAB 1 å°±ç›¸å½“äºè¿™é—¨è¯¾çš„çƒ­èº«ç»ƒä¹ ï¼Œå®ç°é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¤æ‚çš„äº¤äº’ï¼ŒDebug ä¹Ÿæ¯”è¾ƒç®€å•ã€‚</li></ol><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://pdos.csail.mit.edu/6.824/">MIT 6.824</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>distributed system</category>
      
    </categories>
    
    
    <tags>
      
      <tag>distributed</tag>
      
      <tag>Fault-tolerant</tag>
      
      <tag>Key/Value Service</tag>
      
      <tag>Shard</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fault-tolerant Key/Value Serviceï¼ˆäºŒï¼‰</title>
    <link href="/2022/08/22/Fault-tolerant-Key-Value-Service-2/"/>
    <url>/2022/08/22/Fault-tolerant-Key-Value-Service-2/</url>
    
    <content type="html"><![CDATA[<h2 id="å…·æœ‰å¿«ç…§åŠŸèƒ½çš„Key-x2F-Value-service"><a href="#å…·æœ‰å¿«ç…§åŠŸèƒ½çš„Key-x2F-Value-service" class="headerlink" title="å…·æœ‰å¿«ç…§åŠŸèƒ½çš„Key&#x2F;Value service"></a>å…·æœ‰å¿«ç…§åŠŸèƒ½çš„Key&#x2F;Value service</h2><p>LAB 3Båœ¨LAB 3Açš„åŸºç¡€ä¸Šå¢åŠ äº†å¿«ç…§çš„åŠŸèƒ½ï¼Œéšç€Key&#x2F;ValueæœåŠ¡çš„è¿è¡Œï¼Œå…¶åº•å±‚çš„Raftæ—¥å¿—ä¼šè¶Šæ¥è¶Šå¤šï¼Œå½“è¶…è¿‡æŸä¸€é˜ˆå€¼æ—¶ï¼ŒKey&#x2F;ValueæœåŠ¡å°±éœ€è¦åˆ›å»ºä¸€ä¸ªå¿«ç…§ï¼Œç„¶åæŠŠå¿«ç…§ä¼ ç»™Raftï¼ŒRaftæ”¶åˆ°å¿«ç…§åå°±èƒ½å¤Ÿä¸¢å¼ƒå¿«ç…§ç‚¹ä¹‹å‰çš„æ—¥å¿—äº†ã€‚</p><p>Key&#x2F;ValueæœåŠ¡ä¹Ÿå¿…é¡»åœ¨å´©æºƒé‡å¯åä»ç„¶èƒ½å¤Ÿè¿‡æ»¤é‡å¤è¯·æ±‚ï¼Œè¿™æ„å‘³ç€LAB 3Aä¸­ç”¨æ¥å®ç°è¿‡æ»¤é‡å¤è¯·åŠŸèƒ½çš„æ•°æ®ç»“æ„ä¹Ÿå¿…é¡»æŒä¹…åŒ–åˆ°å¿«ç…§ä¸­ã€‚è¿™æ ·ï¼Œå½“Key&#x2F;ValueæœåŠ¡é‡å¯åï¼ŒKey&#x2F;ValueæœåŠ¡ä¼šé¦–å…ˆè¯»å–æŒä¹…åŒ–å­˜å‚¨çš„å¿«ç…§ï¼Œæ¢å¤åœ¨å¿«ç…§ç‚¹çš„çŠ¶æ€å’Œå®¢æˆ·ç«¯è¯·æ±‚è®°å½•ï¼Œä¹‹åå†ä¸€æ¡æ¡æ‰§è¡Œå¿«ç…§ç‚¹ä¹‹åçš„æ—¥å¿—ï¼Œå› æ­¤å¿«ç…§ç‚¹ä¹‹åçš„é‡å¤æ“ä½œä»ç„¶å¯ä»¥è¢«è¿‡æ»¤ã€‚</p><h2 id="LAB-3B-ä¸­é‡åˆ°çš„é—®é¢˜"><a href="#LAB-3B-ä¸­é‡åˆ°çš„é—®é¢˜" class="headerlink" title="LAB 3B ä¸­é‡åˆ°çš„é—®é¢˜"></a>LAB 3B ä¸­é‡åˆ°çš„é—®é¢˜</h2><h3 id="Bug-1"><a href="#Bug-1" class="headerlink" title="Bug 1"></a>Bug 1</h3><p>ç¬¬ä¸€ä¸ªé‡åˆ°çš„é—®é¢˜æ˜¯ <code>TestSnapshotUnreliableRecoverConcurrentPartitionLinearizable3B</code> æµ‹è¯•æ²¡æœ‰é€šè¿‡ï¼Œé”™è¯¯ä¿¡æ¯ä¸­æ˜¾ç¤ºå®¢æˆ·ç«¯çš„å†™æ“ä½œä¸æ˜¯çº¿æ€§ä¸€è‡´çš„ã€‚</p><p>æˆªå–çš„é”™è¯¯æ—¥å¿—ç‰‡æ®µå¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ............</span><br><span class="hljs-number">188282</span> SNAP S4 receives snapshot: &amp;&#123;term: <span class="hljs-number">22</span> index: <span class="hljs-number">1576</span>&#125;<br><span class="hljs-number">188282</span> INFO S4 lastApplied: <span class="hljs-number">0</span>, kvTable: <span class="hljs-keyword">map</span>[], clientReqTable: <span class="hljs-keyword">map</span>[]<br><span class="hljs-number">188283</span> SNAP S4 applies a snapshot: &amp;&#123;term: <span class="hljs-number">22</span> index: <span class="hljs-number">1576</span>&#125;<br><span class="hljs-comment">// ............</span><br>nfo: wrote history visualization to /tmp/<span class="hljs-number">503826179.</span>html<br>--- FAIL: TestSnapshotUnreliableRecoverConcurrentPartitionLinearizable3B (<span class="hljs-number">29.60</span>s)<br>    test_test.<span class="hljs-keyword">go</span>:<span class="hljs-number">385</span>: history is not linearizable<br>FAIL<br>exit status <span class="hljs-number">1</span><br>FAIL<span class="hljs-number">6.824</span>/kvraft<span class="hljs-number">29.606</span>s<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ä¸­æ˜¾ç¤ºS4æ”¶åˆ°äº†Raftå‘æ¥çš„ä¸€ä¸ªç©ºçš„å¿«ç…§ï¼Œå¹¶ä¸”S4åº”ç”¨äº†è¿™ä¸ªå¿«ç…§ï¼Œè¿™å¯¼è‡´S4çš„çŠ¶æ€è¢«æ¸…ç©ºï¼Œå› æ­¤è¿åäº†çº¿æ€§ä¸€è‡´æ€§ã€‚</p><p>åœ¨æˆ‘çš„Raftå®ç°ä¸­ï¼Œå¿«ç…§ä¼šè¢«ä¿å­˜åœ¨Raftç»“æ„ä½“ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Raft <span class="hljs-keyword">struct</span> &#123;<br>    snapshot[]<span class="hljs-type">byte</span> <span class="hljs-comment">//æœ€è¿‘çš„å¿«ç…§</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ä¸Šå±‚çš„Serverä¼ é€’å¿«ç…§ç»™Raftæ—¶ï¼ŒRafté™¤äº†ä¼šæŠŠå¿«ç…§æŒä¹…åŒ–å­˜å‚¨èµ·æ¥ä¹‹å¤–ï¼Œè¿˜ä¼šæ›´æ–°è‡ªå·±çš„ <code>snapshot</code> å­—æ®µçš„å€¼ã€‚å½“ Leader å‘é€å¿«ç…§æ—¶ä¼šç›´æ¥å‘é€ <code>rf.snapshot</code> çš„å€¼è€Œä¸ä¼šå»è¯»å–æŒä¹…åŒ–å­˜å‚¨çš„å¿«ç…§ã€‚</p><p>ä½†æ˜¯åœ¨Raftåˆå§‹å¯åŠ¨æ—¶ï¼Œæˆ‘æ²¡æœ‰è¯»å–æŒä¹…åŒ–å­˜å‚¨çš„å¿«ç…§æ¥åˆå§‹åŒ– <code>rf.snapshot</code>ï¼Œè€Œè¿™å°±æ˜¯é—®é¢˜çš„æ‰€åœ¨ã€‚å½“ä¸€ä¸ªé‡æ–°å¯åŠ¨çš„èŠ‚ç‚¹è¢«å½“é€‰ä¸º Leader åï¼Œè¿™ä¸ªèŠ‚ç‚¹ä¼šå‘è½åäºå®ƒçš„å¿«ç…§ç‚¹çš„å…¶ä»–èŠ‚ç‚¹å‘é€å¿«ç…§ï¼Œè€Œæ­¤æ—¶å¿«ç…§æ˜¯ç©ºçš„ã€‚å½“å…¶ä»–èŠ‚ç‚¹æ”¶åˆ°è¿™ä¸ªå¿«ç…§åï¼Œå¦‚æœåº”ç”¨äº†è¿™ä¸ªå¿«ç…§ï¼Œå¤åˆ¶çŠ¶æ€æœºçš„çŠ¶æ€å°†ä¼šè¢«æ¸…ç©ºï¼Œæœ€ç»ˆå¯¼è‡´é”™è¯¯ã€‚</p><p>å› æ­¤ï¼Œéœ€è¦åœ¨åˆå§‹åŒ–Raftæ—¶è¯»å–æŒä¹…åŒ–å­˜å‚¨çš„å¿«ç…§æ¥è®¾ç½® <code>rf.snapshot</code> çš„å€¼ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Make</span><span class="hljs-params">(peers []*labrpc.ClientEnd, me <span class="hljs-type">int</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">// ....</span></span><br><span class="hljs-params"><span class="hljs-function">rf.snapshot = rf.persister.ReadSnapshot()</span></span><br><span class="hljs-comment">// ....</span><br><br><span class="hljs-keyword">return</span> rf<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="Bug-2"><a href="#Bug-2" class="headerlink" title="Bug 2"></a>Bug 2</h3><p>ç¬¬äºŒä¸ªé‡åˆ°çš„é—®é¢˜æ˜¯ <code>TestSnapshotUnreliable3B</code> æµ‹è¯•æ²¡æœ‰é€šè¿‡ã€‚è¿™ä¸ª Bug æ˜¯æˆ‘åœ¨ LAB 3 ä¸­é‡åˆ°çš„æœ€éš¾è§£å†³çš„ä¸€ä¸ªBugã€‚</p><p>èµ·åˆï¼Œæˆ‘åœ¨æµ‹è¯•æ—¶åŠ äº†ç«äº‰æ£€æµ‹å™¨ï¼š<code>go test --run TestSnapshotUnreliable3B--race</code>ï¼Œå¾—åˆ°äº†å¦‚ä¸‹çš„é”™è¯¯æ—¥å¿—ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ....</span><br>race: limit on <span class="hljs-number">8128</span> simultaneously alive goroutines is exceeded, dying<br>exit status <span class="hljs-number">66</span><br>FAIL<span class="hljs-number">6.824</span>/kvraft<span class="hljs-number">589.365</span>s<br></code></pre></td></tr></table></figure><p>é”™è¯¯æ—¥å¿—ä¸­æ˜¾ç¤ºå­˜åœ¨çš„Goç¨‹å¤ªå¤šäº†ï¼Œè¶…è¿‡äº†8128ä¸ªã€‚æˆ‘æ£€æŸ¥ä»£ç ä¹‹åï¼Œæ²¡æœ‰æ‰¾åˆ°å“ªé‡Œå‡ºäº†é—®é¢˜ï¼Œæ‰€ä»¥å°±å»æœäº†ä¸€ä¸‹çœ‹åˆ«äººæœ‰æ²¡æœ‰é‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Œæœ€ç»ˆåœ¨çŸ¥ä¹ä¸Šçœ‹åˆ°äº†ä¸€ç¯‡æ–‡ç« æœ‰è®²è¿™ä¸ªBugã€‚åœ¨é‚£ç¯‡æ–‡ç« ä¸­ä½œè€…æåˆ°æ˜¯å› ä¸ºå¿ƒè·³å¤ªè¿‡é¢‘ç¹å¯¼è‡´Goç¨‹å¼€çš„å¤ªå¤šï¼Œæœ€ç»ˆè¶…è¿‡äº†ç«äº‰æ£€æµ‹å™¨çš„ä¸Šé™ã€‚</p><p>å› æ­¤ï¼Œæˆ‘æŠŠå¿ƒè·³é—´éš”è®¾ç½®ä¸º200MSï¼ˆåŸæ¥æ˜¯100MSï¼‰å†å»æµ‹è¯•ï¼Œä½†æ˜¯è¿™ä¸ªé”™è¯¯è¿˜æ˜¯å‡ºç°äº†ï¼Œåªæ˜¯å‡ºç°é”™è¯¯æ¬¡æ•°æ¯”ä¹‹å‰å°‘äº†å¾ˆå¤šã€‚ä¹‹åï¼Œæˆ‘æŠŠç«äº‰æ£€æµ‹å™¨å»æ‰ï¼ˆ<code>go test --run TestSnapshotUnreliable3B</code>ï¼‰ï¼Œå†å¹¶å‘è·‘500æ¬¡æµ‹è¯•ï¼Œæœ€ç»ˆæœ‰ä¸€æ¬¡æµ‹è¯•å‘ç”Ÿäº†è¶…æ—¶æŠ¥é”™ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ....</span><br><span class="hljs-built_in">panic</span>: test timed out after <span class="hljs-number">10</span>m0s<br><br>goroutine <span class="hljs-number">79839</span> [running]:<br>testing.(*M).startAlarm.func1()<br>/usr/lib/<span class="hljs-keyword">go</span><span class="hljs-number">-1.13</span>/src/testing/testing.<span class="hljs-keyword">go</span>:<span class="hljs-number">1377</span> +<span class="hljs-number">0xdf</span><br>created by time.goFunc<br>/usr/lib/<span class="hljs-keyword">go</span><span class="hljs-number">-1.13</span>/src/time/sleep.<span class="hljs-keyword">go</span>:<span class="hljs-number">168</span> +<span class="hljs-number">0x44</span><br><span class="hljs-comment">// ....</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æˆ‘æ‰æ„è¯†åˆ°æœ‰å¯èƒ½å‘ç”Ÿäº†æ­»é”ï¼Œå½“ä¸€ä¸ªæœåŠ¡å™¨å‘ç”Ÿæ­»é”åï¼Œè¿™ä¸ªæœåŠ¡å™¨å°±ä¼šè¢«æ°¸ä¹…é˜»å¡ï¼Œåœ¨æµ‹è¯•è¶…æ—¶10åˆ†é’Ÿåå°±ä¼šå‘ç”Ÿpanicã€‚</p><p>æ²¡åŠæ³•ï¼Œåªèƒ½ç¡¬ç€å¤´çš®å»çœ‹è¿™å‡ ä¸‡è¡Œçš„æ—¥å¿—äº†&#x2F;(ã„’oã„’)&#x2F;~~ã€‚ç»è¿‡ä¸€é¡¿æ“ä½œåï¼Œç»ˆäºå®šä½åˆ°äº†å‘ç”Ÿé”™è¯¯çš„æ—¥å¿—ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-number">100223</span> INFO S2 success changes lastApplied from <span class="hljs-number">237</span> to <span class="hljs-number">238</span><br><span class="hljs-number">100223</span> SNAP S2 generates snapshot: &amp;&#123;index: <span class="hljs-number">238</span>&#125;<br></code></pre></td></tr></table></figure><p>æœåŠ¡å™¨S2åœ¨æ—¥å¿—ç´¢å¼•å·238å¤„æƒ³è¦ç”Ÿæˆä¸€ä¸ªå¿«ç…§ï¼Œä½†æ˜¯ä¹‹åæ²¡æœ‰æ‰“å°ç”Ÿæˆå¿«ç…§æˆåŠŸçš„æ—¥å¿—ã€‚æ­£å¸¸çš„ç”Ÿæˆå¿«ç…§å¾—æ—¥å¿—æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-number">102268</span> INFO S1 success changes lastApplied from <span class="hljs-number">247</span> to <span class="hljs-number">248</span><br><span class="hljs-number">102268</span> SNAP S1 generates snapshot: &amp;&#123;index: <span class="hljs-number">248</span>&#125;<br><span class="hljs-number">102270</span> INFO S1 generates snapshot success<br></code></pre></td></tr></table></figure><p>ç”Ÿæˆå¿«ç…§çš„å‡½æ•°å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *KVServer)</span></span> genSnapshot() &#123;<br>w := <span class="hljs-built_in">new</span>(bytes.Buffer)<br>e := labgob.NewEncoder(w)<br>    <br><span class="hljs-comment">// ....</span><br><br>data := w.Bytes()<br>kv.rf.Snapshot(kv.LastApplied, data)<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”Ÿæˆå¿«ç…§å®Œæ¯•åä¼šè°ƒç”¨Raftçš„<code>Snapshot</code>å‡½æ•°å¹¶æŠŠå¿«ç…§ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚<code>Snapshot</code> çš„å‡½æ•°å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> Snapshot(index <span class="hljs-type">int</span>, snapshot []<span class="hljs-type">byte</span>) &#123;<br><span class="hljs-comment">// Your code here (2D).</span><br>rf.mu.Lock()<br><span class="hljs-keyword">defer</span> rf.mu.Unlock()<br><br>    <span class="hljs-comment">//....</span><br>    <span class="hljs-comment">//....</span><br><br>rf.persister.SaveStateAndSnapshot(state, snapshot)<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨<code>Snapshot</code>å‡½æ•°ä¸­éœ€è¦é¦–å…ˆè·å–Raftçš„é”æ‰èƒ½ç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œæ‰€ä»¥æˆ‘åœ¨<code>rf.mu.Lock()</code>åé¢åŠ äº†ä¸€è¡Œæ—¥å¿—ä»¥ä¾¿äºDebugï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">rf.mu.Lock()<br>log.Printf(<span class="hljs-string">&quot;S%d acquire lock successful&quot;</span>)<br>rf.mu.Unlock()<br></code></pre></td></tr></table></figure><p>ä¹‹åï¼Œå†å¹¶å‘è·‘500æ¬¡æµ‹è¯•ã€‚æ£€æŸ¥å‡ºç°çš„é”™è¯¯çš„æµ‹è¯•æ—¥å¿—ï¼Œæˆ‘å‘ç°æŸä¸ªæœåŠ¡å™¨åœ¨æœ€åä¸€æ¬¡ç”Ÿæˆå¿«ç…§çš„æ—¶å€™æ²¡æœ‰æ‰“å°è¿™æ¡æ¶ˆæ¯ï¼Œè¿™è¯´æ˜ç›´åˆ°10åˆ†é’Ÿåæµ‹è¯•è¶…æ—¶è¿™ä¸ªæœåŠ¡å™¨ä¸€ç›´æ²¡æœ‰æ‹¿åˆ°é”ï¼Œå³è¿™ä¸ªæœåŠ¡å™¨æ‰§è¡Œ <code>rf.mu.Lock()</code> è¯­å¥è¢«é˜»å¡ä½äº†ã€‚</p><p>æˆ‘çŒœæµ‹è¿™å¾ˆå¯èƒ½æ˜¯æ­»é”é€ æˆçš„ï¼Œç»è¿‡ä¸€é¡¿ä»£ç ç­›æŸ¥ï¼Œç»ˆäºå®šä½åˆ°äº†é”™è¯¯ä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Raft ä¸­å®‰è£…å¿«ç…§RPCçš„handler</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> InstallSnapshot(args *InstallSnapshotArgs, reply *InstallSnapshotReply) &#123;<br><span class="hljs-comment">// ....</span><br>    rf.mu.Lock()<br>    <span class="hljs-keyword">defer</span> rf.mu.Unlock()<br><br>    msg := ApplyMsg&#123;&#125;<br>    rf.applyCh &lt;- msg<br>&#125;<br><br><span class="hljs-comment">// KvServer ä¸­ä¸€ä¸ªå•ç‹¬è¿è¡Œçš„Goç¨‹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *KVServer)</span></span> applyMsgToStateMachine() &#123;<br><span class="hljs-keyword">for</span> !kv.killed() &#123;<br>msg := &lt;-kv.applyCh<br>        <span class="hljs-comment">// ....</span><br><br><span class="hljs-keyword">if</span> msg.CommandValid &#123;<br><span class="hljs-comment">// ....</span><br>kv.genSnapshot()<br><span class="hljs-comment">// ....</span><br>&#125;<br>        <span class="hljs-comment">// ....</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‡è®¾è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼ŒS æ”¶åˆ°äº† Leader å‘æ¥çš„å¿«ç…§å¹¶æ‰§è¡Œ <code> rf.mu.Lock()</code>è·å–äº† Raft é”ï¼Œä¹‹å S åœ¨ä¼šæŠŠå¿«ç…§å‘é€ç»™ä¸Šå±‚ Key&#x2F;ValueæœåŠ¡ï¼š<code>rf.applyCh &lt;- msg</code>ã€‚</p><p>å¦‚æœ Key&#x2F;Value æœåŠ¡æ­£åœ¨æ‰§è¡Œ <code>kv.genSnapshot</code>ï¼Œé‚£ä¹ˆ Key&#x2F;Value æœåŠ¡ä¹Ÿä¼šå°è¯•è·å– Raft é”ï¼Œé‚£ä¹ˆ <code>rf.applyCh</code> å°±æ²¡æœ‰æ¥æ”¶æ–¹ã€‚ç”±äº <code>applyCh</code> æ˜¯åŒæ­¥ç®¡é“ï¼Œ<code>InstallSnapshot</code> RPCä¼šä¸€ç›´è¢«é˜»å¡ä½ä¸ä¼šé‡Šæ”¾ Raft é”ï¼Œæ‰€ä»¥ <code>kv.genSnapshot</code> ä¹Ÿæ— æ³•è·å– Raft é”ï¼Œå¯¼è‡´æ— æ³•ç”Ÿæˆå¿«ç…§ã€‚</p><p>è§£å†³æ–¹æ³•å¾ˆç®€å•ï¼ŒæŠŠå‘é€å¿«ç…§ç»™ä¸Šå±‚ Key&#x2F;ValueæœåŠ¡çš„æ“ä½œæ”¾åœ¨é”çš„å¤–é¢å³å¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> InstallSnapshot(args *InstallSnapshotArgs, reply *InstallSnapshotReply) &#123;<br><span class="hljs-comment">// ....</span><br>    rf.mu.Lock()<br>    msg := ApplyMsg&#123;&#125;<br>    rf.mu.Unlock()<br>    <br>    rf.applyCh &lt;- msg<br>&#125;<br></code></pre></td></tr></table></figure><p>è§£å†³å®Œæ‰€æœ‰çš„ Bug åï¼Œå¹¶å‘è·‘500æ¬¡æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼š</p><img src="/2022/08/22/Fault-tolerant-Key-Value-Service-2/%E5%9B%BE1.png" class=""><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://pdos.csail.mit.edu/6.824/">MIT 6.824</a></li><li><a href="https://raft.github.io/raft.pdf">Raft paper</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>distributed system</category>
      
    </categories>
    
    
    <tags>
      
      <tag>distributed</tag>
      
      <tag>Fault-tolerant</tag>
      
      <tag>Key/Value Service</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fault-tolerant Key/Value Serviceï¼ˆä¸€ï¼‰</title>
    <link href="/2022/08/19/Fault-tolerant-Key-Value-Service/"/>
    <url>/2022/08/19/Fault-tolerant-Key-Value-Service/</url>
    
    <content type="html"><![CDATA[<h2 id="LAB-3ï¼šåˆ†å¸ƒå¼KV"><a href="#LAB-3ï¼šåˆ†å¸ƒå¼KV" class="headerlink" title="LAB 3ï¼šåˆ†å¸ƒå¼KV"></a>LAB 3ï¼šåˆ†å¸ƒå¼KV</h2><p>6.824 LAB 3çš„å†…å®¹æ˜¯åŸºäºLAB 2å®ç°çš„Raftåº“æ„å»ºä¸€ä¸ªå®¹é”™çš„Key&#x2F;ValueæœåŠ¡ã€‚</p><p>å®¹é”™çš„Key&#x2F;ValueæœåŠ¡æ˜¯ä¸€ä¸ªå¤åˆ¶çŠ¶æ€æœºï¼Œç”±å¤šä¸ªä½¿ç”¨Raftè¿›è¡Œå¤åˆ¶çš„Key&#x2F;ValueæœåŠ¡å™¨ç»„æˆã€‚ç”±äºåº•å±‚ä½¿ç”¨Raftå®ç°å¤åˆ¶ï¼Œå› æ­¤åªè¦è¿‡åŠæœåŠ¡å™¨æ²¡æœ‰æ•…éšœå¹¶ä¸”èƒ½å¤Ÿäº’ç›¸é€šä¿¡ï¼Œé‚£ä¹ˆæ„å»ºçš„Key&#x2F;ValueæœåŠ¡å°±èƒ½å¤Ÿä¸€ç›´å¤„ç†å®¢æˆ·è¯·æ±‚ã€‚æ•´ä½“æ¶æ„å¦‚å›¾æ‰€ç¤ºï¼š</p><img src="/2022/08/19/Fault-tolerant-Key-Value-Service/%E5%9B%BE1.png" class=""><p>å®¢æˆ·ç«¯å¯ä»¥å‘Key&#x2F;ValueæœåŠ¡å‘é€ä¸‰ç§ä¸åŒçš„RPCï¼š</p><ul><li><p>Put(key, value)ï¼šæ›¿æ¢æ•°æ®åº“ä¸­æŸä¸€ç‰¹å®šKeyå¯¹åº”çš„Valueã€‚</p></li><li><p>Append(key, arg)ï¼šå°†argé™„åŠ åˆ°Keyå¯¹åº”çš„Valueä¸Šã€‚</p></li><li><p>Get(key)ï¼šè·å–Keyå¯¹åº”çš„Valueã€‚å¯¹äºä¸€ä¸ªä¸å­˜åœ¨çš„Keyï¼ŒGetåº”è¯¥è¿”å›ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ã€‚</p></li></ul><p>æ¯ä¸ªå®¢æˆ·ç«¯é€šè¿‡Clerkçš„Put&#x2F;Append&#x2F;Putæ–¹æ³•ä¸æœåŠ¡è¿›è¡Œé€šä¿¡ï¼ŒClerkè´Ÿè´£ç®¡ç†ä¸æœåŠ¡çš„RPCäº¤äº’ã€‚</p><p>LAB 3è¦æ±‚å®¢æˆ·ç«¯å¯¹Clerkçš„Get&#x2F;Put&#x2F;Appendæ–¹æ³•çš„è°ƒç”¨æ˜¯å¯çº¿æ€§åŒ–çš„ã€‚å¦‚æœä¸€æ¬¡è°ƒç”¨ä¸€ä¸ªï¼ŒGet&#x2F;Put&#x2F;Appendæ–¹æ³•åº”è¯¥è¡¨ç°å¾—åƒç³»ç»Ÿåªæœ‰ä¸€ä¸ªå‰¯æœ¬ä¸€æ ·ï¼Œå¹¶ä¸”æ¯æ¬¡è°ƒç”¨éƒ½åº”è¯¥è§‚å¯Ÿåˆ°å‰é¢çš„è°ƒç”¨åºåˆ—å¯¹çŠ¶æ€çš„ä¿®æ”¹ï¼ˆä¸€ä¸ªæ“ä½œåªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼‰ã€‚å¯¹äºå¹¶å‘è°ƒç”¨ï¼Œè¿”å›å€¼å’Œæœ€ç»ˆçŠ¶æ€å¿…é¡»ä¸æ“ä½œæŒ‰æŸç§é¡ºåºä¸€æ¬¡æ‰§è¡Œä¸€ä¸ªå¾—åˆ°çš„ç»“æœç›¸åŒã€‚å¦‚æœè°ƒç”¨åœ¨æ—¶é—´ä¸Šé‡å ï¼Œå°±æ˜¯å¹¶å‘çš„ï¼šä¾‹å¦‚ï¼Œå¦‚æœå®¢æˆ·ç«¯Xè°ƒç”¨Clerk.Put()ï¼Œå®¢æˆ·ç«¯Yè°ƒç”¨Clerk.Append()ï¼Œç„¶åå®¢æˆ·ç«¯Xçš„è°ƒç”¨è¿”å›ã€‚ä¸€ä¸ªè°ƒç”¨å¿…é¡»è§‚å¯Ÿåˆ°åœ¨è¯¥è°ƒç”¨å¼€å§‹ä¹‹å‰å·²ç»å®Œæˆçš„æ‰€æœ‰è°ƒç”¨çš„æ•ˆæœã€‚</p><h2 id="å®ç°çº¿æ€§ä¸€è‡´æ€§"><a href="#å®ç°çº¿æ€§ä¸€è‡´æ€§" class="headerlink" title="å®ç°çº¿æ€§ä¸€è‡´æ€§"></a>å®ç°çº¿æ€§ä¸€è‡´æ€§</h2><p>ç”±äºä½¿ç”¨Raftå®ç°å¤åˆ¶ï¼Œå†™æ“ä½œå·²ç»å®ç°äº†çº¿æ€§ä¸€è‡´æ€§ï¼Œå› ä¸ºæ‰€æœ‰çš„æœåŠ¡å™¨éƒ½ä¼šæŒ‰ç…§ç›¸åŒçš„é¡ºåºæ‰§è¡Œç›¸åŒçš„å†™æ“ä½œï¼š</p><img src="/2022/08/19/Fault-tolerant-Key-Value-Service/%E5%9B%BE2.png" class=""><p>å¯¹äºè¯»æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®¢æˆ·ç«¯çš„Getè¯·æ±‚åªå‘é€åˆ°Leaderï¼Œæ¥ç¡®ä¿ä¸€å®šèƒ½å¤Ÿè¯»åˆ°æœ€è¿‘å†™å…¥çš„å€¼ã€‚ä½†æ˜¯è¿™æ ·éœ€è¦é¢å¤–çš„æœºåˆ¶æ¥éªŒè¯è¿™ä¸ªLeaderæ˜¯å¦æ˜¯çœŸçš„Leaderï¼Œå› ä¸ºä¸€ä¸ªå›°åœ¨åˆ†åŒºä¸­çš„Leaderæ˜¯ä¸€ä¸ªå‡Leaderã€‚</p><p>å¯ä»¥æŠŠè¯»æ“ä½œä¹Ÿæäº¤åˆ°Raftæ—¥å¿—ä¸­ï¼Œè¿™æ ·æ‰€æœ‰çš„è¯»å†™æ“ä½œåœ¨æ‰€æœ‰çš„æœåŠ¡å™¨ä¸­éƒ½ä¼šæŒ‰ç…§ç›¸åŒçš„é¡ºåºæ‰§è¡Œï¼Œå¹¶ä¸”è¯»æ“ä½œä¸€å®šèƒ½å¤Ÿçœ‹åˆ°å®ƒä¹‹å‰çš„å†™æ“ä½œå†™å…¥çš„å€¼ã€‚è¿™ç§æ–¹æ³•çš„ç¼ºç‚¹æ˜¯æ€§èƒ½å·®ï¼Œä¸ºäº†æŠŠè¯»æ“ä½œçš„æ—¥å¿—å¤åˆ¶ç»™å¤§å¤šæ•°æœåŠ¡å™¨ï¼Œè‡³å°‘éœ€è¦å‘é€ä¸€è½®AppendEntries RPCï¼Œéœ€è¦èŠ±è´¹10MSä»¥ä¸Šçš„æ—¶é—´ã€‚</p><h2 id="è¿‡æ»¤é‡å¤è¯·æ±‚"><a href="#è¿‡æ»¤é‡å¤è¯·æ±‚" class="headerlink" title="è¿‡æ»¤é‡å¤è¯·æ±‚"></a>è¿‡æ»¤é‡å¤è¯·æ±‚</h2><p>å½“ä¸€ä¸ªå®¢æˆ·ç«¯å‘Key&#x2F;ValueæœåŠ¡å™¨å‘é€ä¸€ä¸ªè¯·æ±‚åï¼Œåœ¨è¶…æ—¶æ—¶é—´å†…è¿™ä¸ªæœåŠ¡å™¨å¯èƒ½æ‰§è¡Œä¸å®Œè¿™ä¸ªè¯·æ±‚ï¼ŒæœåŠ¡å™¨ä¼šè¿”å›ä¸€ä¸ªerrorç»™å®¢æˆ·ç«¯ï¼Œä¹‹åå®¢æˆ·ç«¯ä¼šé‡æ–°å‘é€è¿™ä¸ªè¯·æ±‚ã€‚å› æ­¤ï¼Œå®¢æˆ·ç«¯å¯èƒ½ä¼šå‘é€å¤šæ¡é‡å¤çš„è¯·æ±‚ç»™æœåŠ¡ç«¯ã€‚</p><p>è¿™ç§æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨éœ€è¦æœ‰èƒ½åŠ›è¿‡æ»¤æ‰é‡å¤çš„è¯·æ±‚ï¼Œç¡®ä¿æ¯ä¸ªè¯·æ±‚åªæ‰§è¡Œä¸€æ¬¡ã€‚å¦åˆ™ï¼ŒæœåŠ¡å™¨æ‰§è¡Œé‡å¤è¯·æ±‚å¯èƒ½ä¼šå¯¼è‡´çŠ¶æ€çš„é”™è¯¯æ›´æ”¹ï¼Œå¯¼è‡´è¿åçº¿æ€§ä¸€è‡´æ€§ã€‚</p><p>æ¯”å¦‚ï¼Œå®¢æˆ·ç«¯Xå‘æœåŠ¡å™¨å‘é€è¯·æ±‚ <code>Append(&quot;K&quot;, &quot;Hello&quot;)</code>ï¼Œä¹‹åç”±äºä¸€äº›åŸå› å®¢æˆ·ç«¯Xå†æ¬¡å‘é€è¯·æ±‚ <code>Append(&quot;K&quot;, &quot;Hello&quot;)</code>ï¼Œå¦‚æœæœåŠ¡å™¨ä¸è¿‡æ»¤æ‰é‡å¤çš„è¯·æ±‚ï¼Œé‚£ä¹ˆ <code>K</code> å¯¹åº”çš„ Value å°±ä¼šå˜ä¸º <code>HelloHello</code>ã€‚ä½†æ˜¯åœ¨å®¢æˆ·ç«¯çœ‹æ¥ï¼Œæˆ‘åªæƒ³è¦è¿½åŠ ä¸€ä¸ª <code>Hello</code>ï¼Œæœ€ç»ˆå´è¿½åŠ äº†ä¸¤ä¸ªï¼Œè¿™æ˜¾ç„¶ä¸ç¬¦åˆè¦æ±‚ã€‚</p><p>è§£å†³æ–¹æ³•æ˜¯åœ¨å®¢æˆ·ç«¯å­˜å‚¨ä¸€ä¸ªå®¢æˆ·ç«¯æ ‡è¯†ç¬¦å’Œè¯·æ±‚IDï¼Œå¹¶åœ¨æœåŠ¡ç«¯å­˜å‚¨ä¸€å¼ è¡¨ï¼Œè¡¨ä¸­çš„æ¯ä¸€é¡¹æ˜¯å®¢æˆ·ç«¯çš„æ ‡è¯†ç¬¦å’Œå¯¹åº”çš„è¯·æ±‚IDï¼Œè¯·æ±‚IDæ˜¯ä¸€ä¸ªä»1å¼€å§‹çš„é€’å¢æ•´æ•°ã€‚å®¢æˆ·ç«¯æ¯æ¬¡å‘é€è¯·æ±‚æ—¶éƒ½æŠŠè¯·æ±‚IDåŠ ä¸€ï¼Œç„¶åæŠŠå®¢æˆ·ç«¯æ ‡è¯†ç¬¦å’Œè¯·æ±‚IDé™„åŠ åˆ°å‘é€çš„è¯·æ±‚ä¸­ï¼›æœåŠ¡å™¨æ”¶åˆ°è¿™ä¸ªè¯·æ±‚åå¯ä»¥æŸ¥çœ‹è¿™ä¸ªå®¢æˆ·ç«¯å¯¹åº”çš„æœ€å¤§è¯·æ±‚IDï¼Œåªæœ‰å½“å‘é€è¿‡æ¥çš„è¯·æ±‚IDå¤§äºæœåŠ¡å™¨å­˜å‚¨çš„æœ€å¤§è¯·æ±‚IDæ‰æ‰§è¡Œè¿™ä¸ªè¯·æ±‚ï¼Œå¦è€…è¯´æ˜æ˜¯ä¸€ä¸ªé‡å¤çš„è¯·æ±‚ï¼Œç›´æ¥è¿”å›å³å¯ã€‚</p><h2 id="LAB-3Aä¸­é‡åˆ°çš„é—®é¢˜"><a href="#LAB-3Aä¸­é‡åˆ°çš„é—®é¢˜" class="headerlink" title="LAB 3Aä¸­é‡åˆ°çš„é—®é¢˜"></a>LAB 3Aä¸­é‡åˆ°çš„é—®é¢˜</h2><h3 id="æ¶æ„ç†è§£é”™è¯¯"><a href="#æ¶æ„ç†è§£é”™è¯¯" class="headerlink" title="æ¶æ„ç†è§£é”™è¯¯"></a>æ¶æ„ç†è§£é”™è¯¯</h3><p>åœ¨å®ç°LAB 3Açš„æ˜¯å¦é‡åˆ°çš„ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯æŠŠæ¶æ„ç†è§£é”™äº†ã€‚åœ¨æˆ‘åŸå…ˆçš„ç†è§£ä¸­ï¼Œç³»ç»Ÿä¸­åªå­˜åœ¨ä¸€ä¸ªClerkï¼Œç„¶åå­˜åœ¨å¤šä¸ªå®¢æˆ·ç«¯ï¼Œæ‰€æœ‰çš„å®¢æˆ·ç«¯éƒ½è°ƒç”¨åŒä¸€ä¸ªClerkçš„Put&#x2F;Append&#x2F;Getæ–¹æ³•ï¼Œå› æ­¤å¯¹Clerkçš„è°ƒç”¨æ˜¯å¹¶å‘çš„ï¼š</p><img src="/2022/08/19/Fault-tolerant-Key-Value-Service/%E5%9B%BE3.png" class=""><p>ä½†æ˜¯ï¼Œè¿™æ ·çš„è¯æ— æ³•çŸ¥é“æ˜¯è°è°ƒç”¨çš„Put&#x2F;Append&#x2F;Getæ–¹æ³•ï¼Œå› ä¸ºè¿™äº›æ–¹æ³•ä¸­æ²¡æœ‰å®¢æˆ·ç«¯IDè¿™ä¸ªå‚æ•°ã€‚æˆ‘åŸæ¥çš„æƒ³æ³•æ˜¯Clerkæ¯æ¬¡å‘é€è¯·æ±‚ä¹‹å‰å…ˆç”Ÿæˆä¸€ä¸ªéšæœºçš„è¯·æ±‚IDï¼Œä¹‹åå‘é€è¯·æ±‚æ—¶é™„å¸¦ä¸Šè¿™ä¸ªIDã€‚è¿™æ ·æœåŠ¡ç«¯åœ¨æ‰§è¡Œå®Œä¸€æ¡è¯·æ±‚åå°±å¯ä»¥æŠŠè¿™ä¸ªè¯·æ±‚IDå’Œæ‰§è¡Œç»“æœå­˜å‚¨åœ¨ä¸€æ¡è¡¨ä¸­ï¼Œä¹‹åå¦‚æœå®¢æˆ·ç«¯å‘é€äº†ä¸€æ¡é‡å¤çš„è¯·æ±‚ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ ¹æ®è¯·æ±‚IDç›´æ¥æŠŠç»“æœè¿”å›ï¼Œè€Œä¸éœ€è¦å†æ¬¡æ‰§è¡Œã€‚</p><p>è¿™ä¸ªæ–¹æ³•çš„é—®é¢˜éšç€è¯·æ±‚çš„æ‰§è¡Œï¼ŒæœåŠ¡ç«¯å­˜å‚¨çš„è¯·æ±‚IDå’Œæ‰§è¡Œç»“æœä¼šè¶Šæ¥è¶Šå¤šï¼Œè€Œä¸”æ²¡æœ‰ä»€ä¹ˆæœ‰æ•ˆçš„æ¸…ç†æ— ç”¨æ•°æ®çš„æ–¹æ³•ã€‚</p><p>æƒ³äº†åŠå¤©æ²¡å•¥å¥½çš„æ€è·¯ï¼Œæˆ‘å°±çœ‹äº†ä¸€ä¸‹åˆ«äººçš„LAB 3çš„å®ç°æ–‡æ¡£ï¼Œæ‰å‘ç°æˆ‘æŠŠLAB 3çš„æ¶æ„ç†è§£é”™äº†ã€‚æ­£ç¡®çš„æ¶æ„æ˜¯ï¼Œæœ‰å¤šä¸ªå®¢æˆ·ç«¯ï¼Œå¹¶ä¸”æ¯ä¸ªå®¢æˆ·ç«¯æœ‰è‡ªå·±çš„Clerkï¼Œæ¯ä¸ªå®¢æˆ·ç«¯é˜»å¡è°ƒç”¨è‡ªå·±çš„Clerkçš„Put&#x2F;Append&#x2F;Getæ–¹æ³•ï¼š</p><img src="/2022/08/19/Fault-tolerant-Key-Value-Service/%E5%9B%BE4.png" class=""><p>è¿™æ ·ï¼Œå°±èƒ½å¤Ÿä½¿ç”¨ä¸Šé¢æåˆ°çš„è¿‡æ»¤é‡å¤è¯·æ±‚çš„æ–¹æ³•äº†ã€‚</p><h3 id="Bug-1"><a href="#Bug-1" class="headerlink" title="Bug 1"></a>Bug 1</h3><p>ç¬¬ä¸€ä¸ªé‡åˆ°çš„é—®é¢˜æ˜¯æ¯æ¡è¯·æ±‚çš„æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œè¶…è¿‡äº†33msï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go">--- FAIL: TestSpeed3A (<span class="hljs-number">101.08</span>s)<br>    test_test.<span class="hljs-keyword">go</span>:<span class="hljs-number">419</span>: Operations completed too slowly <span class="hljs-number">100.480114</span>ms/op &gt; <span class="hljs-number">33.333333</span>ms/op<br>FAIL<br>exit status <span class="hljs-number">1</span><br>FAIL    <span class="hljs-number">6.824</span>/kvraft    <span class="hljs-number">101.086</span>s<br></code></pre></td></tr></table></figure><p>æˆ‘åå¤æ£€æŸ¥äº†LAB 3Açš„ä»£ç å®ç°ï¼Œéƒ½æ²¡æ‰¾åˆ°å•¥é—®é¢˜ï¼Œå»ç½‘ä¸Šæœäº†ä¸€ä¸‹æ‰å‘ç°æ˜¯LAB2çš„å®ç°ç­–ç•¥æœ‰é—®é¢˜ã€‚</p><p>åœ¨æˆ‘çš„LAB 2çš„å®ç°ä¸­ï¼Œå¿ƒè·³çš„é—´éš”æ˜¯100MSï¼Œå¹¶ä¸”åªåœ¨å¿ƒè·³çš„æ˜¯å¦æ‰å‘é€æ—¥å¿—ç»™å…¶ä»–çš„èŠ‚ç‚¹ã€‚å¦‚æœåªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å‘é€Put&#x2F;Append&#x2F;Getè¯·æ±‚ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨æŠŠè¿™ä¸ªè¯·æ±‚æäº¤ç»™Raftï¼ŒRaftéœ€è¦ç­‰å¾…100MSç„¶åå‘é€é™„åŠ æ—¥å¿—ç»™å…¶ä»–çš„èŠ‚ç‚¹ï¼Œä¹‹åæ‰èƒ½æäº¤æ‰§è¡Œè¿™ä¸ªè¯·æ±‚ï¼Œå½“æœåŠ¡å™¨æ‰§è¡Œå®Œè¿™ä¸ªè¯·æ±‚åè¿”å›å“åº”ç»™å®¢æˆ·ç«¯ï¼Œä¹‹åå®¢æˆ·ç«¯æ‰èƒ½ç»§ç»­å‘èµ·æ–°çš„è¯·æ±‚ã€‚å› æ­¤ï¼Œæ‰§è¡Œä¸€æ¡è¯·æ±‚è‡³å°‘éœ€è¦100MSï¼Œè¿™æ²¡æœ‰è¾¾åˆ°33MSçš„è¦æ±‚ã€‚</p><p>è§£å†³æ–¹æ³•å¾ˆç®€å•ï¼Œåœ¨Raftæ‰§è¡ŒStartæ–¹æ³•æ·»åŠ å®Œä¸€æ¡æ—¥å¿—åï¼Œå°±ç«‹é©¬å‘é€å¿ƒè·³ï¼Œè¿™æ ·å°±ä¸éœ€è¦ç­‰å¾…100MSäº†ã€‚</p><h3 id="Bug-2"><a href="#Bug-2" class="headerlink" title="Bug 2"></a>Bug 2</h3><p>ç¬¬äºŒä¸ªBugæ˜¯ä¸Goè¯­è¨€ç›¸å…³çš„ã€‚å¦‚æœå‘<code>nil</code>ç®¡é“å‘é€å€¼ä¼šå‘ç”Ÿæ­»é”ï¼Œå‘é€ç«¯Goç¨‹ä¼šè¢«æ°¸ä¹…é˜»å¡ã€‚æœ€å¼€å§‹æˆ‘çš„å®ç°æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">command.Ch &lt;- sendVal<br></code></pre></td></tr></table></figure><p>å¦‚æœå½“å‰çš„æœåŠ¡å™¨ä¸æ˜¯Leaderï¼Œé‚£ä¹ˆ<code>command.Ch</code>å°±ç­‰äº<code>nil</code>ï¼Œå› æ­¤åœ¨å‘é€å‰éœ€è¦åŠ ä¸€ä¸ªåˆ¤æ–­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> command.Ch != <span class="hljs-literal">nil</span> &#123;<br>    command.Ch &lt;- sendVal<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Bug-3"><a href="#Bug-3" class="headerlink" title="Bug 3"></a>Bug 3</h3><p>ç¬¬ä¸‰ä¸ªBugè¿˜æ˜¯ä¸Goè¯­è¨€ç›¸å…³çš„ã€‚å¯¹äºä¸€ä¸ªåŒæ­¥ç®¡é“ï¼Œåªæœ‰å½“æ¥æ”¶æ–¹å‡†å¤‡æ¥æ”¶çš„æ—¶å€™ï¼Œå‘é€æ–¹æ‰èƒ½å‘é€è¿‡å»ï¼Œå¦åˆ™å‘é€æ–¹ä¼šæ°¸ä¹…é˜»å¡ã€‚æœ€å¼€å§‹æˆ‘çš„å®ç°æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// æŸä¸ªå‡½æ•°</span><br><span class="hljs-keyword">if</span> command.Ch != <span class="hljs-literal">nil</span> &#123;<br>    command.Ch &lt;- sendVal<br>&#125;<br><br><br><span class="hljs-comment">// æŸä¸ªå‡½æ•°</span><br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> value := &lt;-waitCh:<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, value<br><span class="hljs-keyword">case</span> &lt;-time.After(kv.waitTimeOut):<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœåœ¨<code>kv.waitTimeOut</code>å†…è¿˜æ²¡æœ‰æ”¶åˆ°è¯·æ±‚å®Œæˆçš„é€šçŸ¥ï¼ŒæœåŠ¡å™¨ä¼šç›´æ¥è¿”å›ä¸€ä¸ªerrorç»™å®¢æˆ·ç«¯ã€‚ä¹‹åå½“è¯·æ±‚å®Œæˆåï¼Œæ‰§è¡Œ<code>command.Ch &lt;- sendVal</code>å°±ä¼šå‘ç”Ÿæ°¸ä¹…é˜»å¡ï¼Œå› ä¸ºæ­¤æ—¶å·²ç»æ²¡æœ‰æ¥æ”¶æ–¹äº†ã€‚</p><p>è§£å†³æ–¹æ³•æ˜¯ï¼Œåœ¨å‘é€ç«¯ä¹Ÿè®¾ç½®ä¸€ä¸ªè¶…æ—¶ï¼Œå¦‚æœåœ¨è¶…æ—¶æ—¶é—´å†…æ²¡æœ‰å‘é€æˆåŠŸå°±ç›´æ¥é€€å‡ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> command.Ch != <span class="hljs-literal">nil</span> &#123;<br>    <span class="hljs-keyword">select</span> &#123;<br>    <span class="hljs-keyword">case</span> command.Ch &lt;- sendVal:<br>    <span class="hljs-keyword">case</span> &lt;-time.After(time.Microsecond):<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è§£å†³å®Œæ‰€æœ‰Bugåï¼Œå¹¶å‘è·‘500æ¬¡æµ‹è¯•ï¼š</p><img src="/2022/08/19/Fault-tolerant-Key-Value-Service/%E5%9B%BE5.png" class=""><p>TestSpeed3Aæœ‰ä¸€æ¬¡æµ‹è¯•æ²¡æœ‰é€šè¿‡ï¼Œé”™è¯¯æ—¥å¿—ä¸­æ˜¾ç¤ºæ¯æ¡æ“ä½œèŠ±äº†37MSï¼Œæ²¡æœ‰è¾¾åˆ°33MS&#x2F;opçš„è¦æ±‚ï¼Œä½†æ˜¯è¿™ä¸ªé—®é¢˜åº”è¯¥å·²ç»åœ¨Bug 1ä¸­è¢«è§£å†³äº†ã€‚æµ‹è¯•æŠ¥å‘Šä¸­æ˜¾ç¤ºï¼ŒTestSpeed3Aå¹³å‡èŠ±è´¹äº†78.41ç§’æ‰å®Œæˆï¼Œä½†æ˜¯åœ¨å•ç‹¬æµ‹è¯•ä¸­åªèŠ±äº†10.9ç§’å°±å®Œæˆäº†ï¼š</p><img src="/2022/08/19/Fault-tolerant-Key-Value-Service/%E5%9B%BE7.png" class=""><p>æˆ‘å°±çŒœæµ‹å¯èƒ½æ˜¯æµ‹è¯•çš„æ—¶å€™å¼€çš„çº¿ç¨‹å¤ªå¤šå¯¼è‡´çš„ï¼Œæ¯•ç«Ÿæˆ‘çš„ç”µè„‘æ€§èƒ½ä¸å¤ªè¡Œã€‚é‚£ä¹ˆï¼Œåªå¼€5ä¸ªçº¿ç¨‹å¹¶å‘è·‘500æ¬¡TestSpeed3Aæµ‹è¯•ï¼š</p><img src="/2022/08/19/Fault-tolerant-Key-Value-Service/%E5%9B%BE6.png" class=""><p>æ‰€æœ‰çš„æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼Œå¹¶ä¸”å¹³å‡åªèŠ±è´¹äº†13.13ç§’ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://pdos.csail.mit.edu/6.824/">MIT 6.824</a></li><li><a href="https://raft.github.io/raft.pdf">Raft paper</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>distributed system</category>
      
    </categories>
    
    
    <tags>
      
      <tag>distributed</tag>
      
      <tag>Fault-tolerant</tag>
      
      <tag>Key/Value Service</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Raftï¼ˆäº”ï¼‰ï¼šæ—¥å¿—å‹ç¼©å’Œå¿«ç…§</title>
    <link href="/2022/08/08/Raft-5/"/>
    <url>/2022/08/08/Raft-5/</url>
    
    <content type="html"><![CDATA[<h2 id="ä¸ºä»€ä¹ˆéœ€è¦å¿«ç…§ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆéœ€è¦å¿«ç…§ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦å¿«ç…§ï¼Ÿ"></a>ä¸ºä»€ä¹ˆéœ€è¦å¿«ç…§ï¼Ÿ</h2><p>åœ¨ Raft ä¸­ï¼ŒLog å‹ç¼©å’Œå¿«ç…§è§£å†³çš„é—®é¢˜æ˜¯ï¼š</p><ul><li><p>èŠ‚çº¦å†…å­˜å’Œç£ç›˜çš„å­˜å‚¨ç©ºé—´ã€‚å¯¹äºä¸€ä¸ªé•¿æœŸè¿è¡Œçš„ç³»ç»Ÿï¼Œä¾‹å¦‚è¿è¡Œäº†å‡ å‘¨ï¼Œå‡ ä¸ªæœˆç”šè‡³å‡ å¹´ï¼Œå¦‚æœæŒ‰ç…§ Raft è®ºæ–‡å›¾2çš„è§„åˆ™ï¼Œé‚£ä¹ˆ Log ä¼šæ— é™å¢é•¿ã€‚æœ€åå¯èƒ½ä¼šæœ‰æ•°ç™¾ä¸‡æ¡ Logï¼Œä»è€Œéœ€è¦å¤§é‡çš„å†…å­˜æ¥å­˜å‚¨ã€‚å¦‚æœæŒä¹…åŒ–å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œæœ€ç»ˆä¼šæ¶ˆè€—ç£ç›˜çš„å¤§é‡ç©ºé—´ã€‚</p></li><li><p>å‡å°‘å´©æºƒé‡å¯åæ¢å¤åº”ç”¨ç¨‹åºçŠ¶æ€èŠ±è´¹çš„æ—¶é—´ã€‚å¦‚æœä¸€ä¸ªæœåŠ¡å™¨é‡å¯äº†ï¼Œå®ƒéœ€è¦é‡æ–°ä»å¤´å¼€å§‹æ‰§è¡Œè¿™æ•°ç™¾ä¸‡æ¡ Log æ¥é‡å»ºè‡ªå·±çš„çŠ¶æ€ã€‚å½“æ•…éšœé‡å¯ä¹‹åï¼Œéå†å¹¶æ‰§è¡Œæ•´ä¸ª Log çš„å†…å®¹å¯èƒ½è¦èŠ±è´¹å‡ ä¸ªå°æ—¶æ¥å®Œæˆã€‚è¿™åœ¨æŸç§ç¨‹åº¦ä¸Šæ¥è¯´æ˜¯æµªè´¹ï¼Œå› ä¸ºåœ¨é‡å¯ä¹‹å‰ï¼ŒæœåŠ¡å™¨å·²ç»æœ‰äº†ä¸€å®šçš„åº”ç”¨ç¨‹åºçŠ¶æ€ã€‚</p></li></ul><p>ä¸ºäº†åº”å¯¹ä¸Šé¢çš„é—®é¢˜ï¼ŒRaft æœ‰äº†å¿«ç…§çš„æ¦‚å¿µã€‚å¿«ç…§èƒŒåçš„æ€æƒ³æ˜¯ï¼Œå°†åº”ç”¨ç¨‹åºçŠ¶æ€çš„æ‹·è´å•ç‹¬å­˜å‚¨ä¸‹æ¥ã€‚</p><p>å¯¹äºå¤§å¤šæ•°çš„åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œåº”ç”¨ç¨‹åºçš„çŠ¶æ€è¿œå°äº Log çš„å¤§å°ã€‚æŸç§ç¨‹åº¦ä¸Šï¼Œåœ¨æŸäº›æ—¶é—´ç‚¹ï¼ŒLog å’Œåº”ç”¨ç¨‹åºçš„çŠ¶æ€æ˜¯å¯ä»¥äº’æ¢çš„ï¼Œå®ƒä»¬æ˜¯ç”¨æ¥è¡¨ç¤ºåº”ç”¨ç¨‹åºçŠ¶æ€çš„ä¸åŒäº‹ç‰©ã€‚ä½†æ˜¯ Log å¯èƒ½åŒ…å«å¤§é‡çš„é‡å¤çš„è®°å½•ï¼ˆä¾‹å¦‚KVå­˜å‚¨ä¸­å¯¹åŒä¸€ä¸ªé”®çš„é‡å¤èµ‹å€¼ï¼‰ï¼Œè¿™äº›è®°å½•ä½¿ç”¨äº† Log ä¸­çš„å¤§é‡çš„ç©ºé—´ï¼Œä½†æ˜¯å¯ä»¥å‹ç¼©ä¸ºè¡¨ç¤ºåº”ç”¨ç¨‹åºçŠ¶æ€çš„ä¸€æ¡è®°å½•ã€‚è¿™æ¡è®°å½•é€šå¸¸æ¯” Log å°çš„å¤šï¼Œè¿™å°±æ˜¯å¿«ç…§çš„èƒŒååŸç†ã€‚</p><h2 id="å¿«ç…§å®ç°ç­–ç•¥"><a href="#å¿«ç…§å®ç°ç­–ç•¥" class="headerlink" title="å¿«ç…§å®ç°ç­–ç•¥"></a>å¿«ç…§å®ç°ç­–ç•¥</h2><p>å½“ Raft è®¤ä¸ºå®ƒçš„ Log å¤ªå¤§ï¼Œä¾‹å¦‚å¤§äº1MBï¼Œ10MBæˆ–è€…ä»»æ„çš„é™åˆ¶ï¼ŒRaft ä¼šä» Log ä¸­é€‰å–ä¸€ä¸ªä¸å¿«ç…§å¯¹åº”çš„ç‚¹ï¼Œç„¶åè¦æ±‚åº”ç”¨ç¨‹åºåœ¨é‚£ä¸ªç‚¹çš„ä½ç½®åšä¸€ä¸ªå¿«ç…§ã€‚ä¹‹åï¼ŒRaft ä¼šæŒä¹…åŒ–å­˜å‚¨å¿«ç…§å¹¶ä¸¢å¼ƒå¿«ç…§ç‚¹ä¹‹å‰çš„æ—¥å¿—æ¡ç›®ã€‚</p><p>å½“ Raft æœåŠ¡å™¨å´©æºƒé‡å¯åï¼Œåº”ç”¨ç¨‹åºè¯»å–æŒä¹…åŒ–å­˜å‚¨çš„å¿«ç…§ï¼Œæ¢å¤åœ¨å¿«ç…§ç‚¹å¯¹åº”çš„çŠ¶æ€ã€‚</p><p>ä½†æ˜¯ï¼Œç”±äºä¸¢å¼ƒäº†å¿«ç…§ä¹‹å‰ Logï¼Œè¿™å¼•å…¥äº†å¤§é‡çš„å¤æ‚æ€§ã€‚å¦‚æœæœ‰çš„ Follower çš„ Log å¾ˆçŸ­ï¼Œæ¯” Leader çš„å¿«ç…§ç‚¹è¿˜çŸ­ï¼Œé‚£ä¹ˆ Leader å°±ä¸å¯èƒ½ä¸ Follower çš„æ—¥å¿—åŒ¹é…æˆåŠŸï¼Œå› æ­¤ Leader å°±æ— æ³•é€šè¿‡ AppendEntries çš„æ–¹å¼è®© Follower çš„ Log è¡¥é½è‡³ Leader çš„ Logã€‚</p><p>ä¸€ç§å¯èƒ½çš„è§£å†³æ–¹å¼æ˜¯ï¼Œå¦‚æœ Leader å‘ç°æœ‰ä»»ä½•ä¸€ä¸ª Follower çš„ Log è½åäº Leader å¿«ç…§çš„ç‚¹ï¼Œé‚£ä¹ˆ Leader å°±ä¸ä¸¢å¼ƒå¿«ç…§ä¹‹å‰çš„ Logã€‚ä½†æ˜¯å¦‚æœä¸€ä¸ª Follower å…³æœºäº†å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œé‚£ä¹ˆ Leader å°±ä¸èƒ½ç¡®è®¤è¿™ä¸ª Follower çš„ Log æ¡ç›®ï¼Œè¿™å°±æ„å‘³ç€ Leader ä¸èƒ½é€šè¿‡å¿«ç…§æ¥å‡å°‘è‡ªå·±çš„å­˜å‚¨æ¶ˆè€—ã€‚</p><p>Raft é€‰æ‹©çš„æ–¹æ³•æ˜¯ï¼ŒLeader å¯ä»¥ä¸¢å¼ƒ Follower éœ€è¦çš„ Logã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦æŸç§æœºåˆ¶èƒ½å¤Ÿå¤„ç† Follower Log çš„ç»“å°¾åˆ° Leader Log å¼€å§‹ä¹‹é—´ç¼ºå¤±çš„ Logï¼Œè§£å†³æ–¹æ³•æ˜¯ InstallSnapshot RPCã€‚</p><p>å½“ Follower æ”¶åˆ° AppendEntries RPC æ—¶ï¼Œå¦‚æœæ—¥å¿—ä¸åŒ¹é…åˆ™ä¼šè¿”å› falseã€‚Leader æ”¶åˆ° false è¿”å›åï¼Œä¼šå›é€€è‡ªå·±çš„ Logï¼Œç›´åˆ°æŸä¸ªç‚¹ä¸ºæ­¢ Leader å°†ä¸èƒ½å†å›é€€ï¼Œæ­¤æ—¶å®ƒå·²ç»åˆ°äº†è‡ªå·± Log çš„èµ·ç‚¹ã€‚è¿™æ—¶ï¼ŒLeader ä¼šå°†è‡ªå·±çš„å¿«ç…§å‘ç»™ Followerï¼Œä¹‹åé€šè¿‡ AppendEntries å°†åé¢çš„ Log å‘ç»™ Followerã€‚</p><p>å…·ä½“çš„ InstallSnapshot ç®—æ³•å¯ä»¥æŸ¥çœ‹ <a href="https://raft.github.io/raft.pdf">Raft paper</a>ï¼ˆç¬¬ä¸ƒèŠ‚ï¼‰ã€‚</p><h2 id="LAB-2D"><a href="#LAB-2D" class="headerlink" title="LAB 2D"></a>LAB 2D</h2><p>LAB 2D çš„å®ç°ä¸éš¾ï¼Œä½†æ˜¯å°ç»†èŠ‚æŒºå¤šçš„ã€‚è™½ç„¶å®ç°çš„è¿‡ç¨‹ä¸­é‡åˆ°äº†å¾ˆå¤šBugï¼Œä½†æ˜¯éƒ½å±äºé‚£ç§ä¸€çœ¼å°±èƒ½çŸ¥é“é—®é¢˜åœ¨å“ªå„¿çš„ç±»å‹ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸åˆ—ä¸¾äº†ã€‚</p><p>æœ€åï¼Œå¹¶å‘è·‘500æ¬¡æµ‹è¯•ï¼Œå…¨éƒ¨é¡ºåˆ©é€šè¿‡ï¼š</p><img src="/2022/08/08/Raft-5/Raft-%E5%9B%BE1.png" class=""><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><p><a href="https://pdos.csail.mit.edu/6.824/">MIT 6.824</a></p></li><li><p><a href="https://raft.github.io/raft.pdf">Raft paper</a></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>distributed system</category>
      
    </categories>
    
    
    <tags>
      
      <tag>distributed</tag>
      
      <tag>consistency</tag>
      
      <tag>paper</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Raftï¼ˆå››ï¼‰ï¼šæŒä¹…åŒ–å­˜å‚¨</title>
    <link href="/2022/08/06/Raft-4/"/>
    <url>/2022/08/06/Raft-4/</url>
    
    <content type="html"><![CDATA[<h2 id="Raft-æŒä¹…åŒ–"><a href="#Raft-æŒä¹…åŒ–" class="headerlink" title="Raft æŒä¹…åŒ–"></a>Raft æŒä¹…åŒ–</h2><p>Raft ä¸­æ‰€æœ‰æœåŠ¡å™¨éœ€è¦æŒä¹…åŒ–å­˜å‚¨çš„çŠ¶æ€ï¼š</p><table><thead><tr><th>å‚æ•°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>currentTerm</td><td>æœåŠ¡å™¨å·²çŸ¥æœ€æ–°çš„ä»»æœŸï¼ˆåœ¨æœåŠ¡å™¨é¦–æ¬¡å¯åŠ¨æ—¶åˆå§‹åŒ–ä¸º0ï¼Œå•è°ƒé€’å¢ï¼‰</td></tr><tr><td>votedFor</td><td>å½“å‰ä»»æœŸå†…æ”¶åˆ°é€‰ç¥¨çš„ candidateIdï¼Œå¦‚æœæ²¡æœ‰æŠ•ç»™ä»»ä½•å€™é€‰äººåˆ™ä¸ºç©º</td></tr><tr><td>log[]</td><td>æ—¥å¿—æ¡ç›®ï¼›æ¯ä¸ªæ¡ç›®åŒ…å«äº†ç”¨äºçŠ¶æ€æœºçš„å‘½ä»¤ï¼Œä»¥åŠé¢†å¯¼äººæ¥æ”¶åˆ°è¯¥æ¡ç›®æ—¶çš„ä»»æœŸï¼ˆåˆå§‹ç´¢å¼•ä¸º1ï¼‰</td></tr></tbody></table><p>å½“æœåŠ¡å™¨æ”¹å˜äº†è¢«æ ‡è®°ä¸ºæŒä¹…åŒ–çš„æŸä¸ªæ•°æ®æ—¶ï¼ŒæœåŠ¡å™¨åº”è¯¥å°†æ›´æ–°å†™å…¥åˆ°ç£ç›˜æˆ–å…¶ä»–æŒä¹…åŒ–å­˜å‚¨ä¸­ã€‚è¿™æ ·å½“æœåŠ¡å™¨æ•…éšœé‡å¯åï¼Œå°±å¯ä»¥ä»æŒä¹…åŒ–å­˜å‚¨ä¸­æ‰¾åˆ°ç›¸åº”çš„æ•°æ®å¹¶å°†å…¶åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œæ¢å¤ä¹‹å‰çš„çŠ¶æ€ã€‚</p><h3 id="currentTerm-æŒä¹…åŒ–"><a href="#currentTerm-æŒä¹…åŒ–" class="headerlink" title="currentTerm æŒä¹…åŒ–"></a>currentTerm æŒä¹…åŒ–</h3><p>currentTerm éœ€è¦è¢«æŒä¹…åŒ–å­˜å‚¨æ˜¯ä¸ºäº†ç¡®ä¿é€‰ä¸¾å®‰å…¨ç‰¹æ€§ï¼Œå³ä¸€ä¸ªä»»æœŸå†…æœ€å¤šåªæœ‰ä¸€ä¸ª Leader ä¼šè¢«é€‰ä¸¾å‡ºæ¥ã€‚</p><p>å‡è®¾ä¸€å…±æœ‰ä¸‰å°æœåŠ¡å™¨Aã€Bã€Cã€‚Aæ˜¯Leaderï¼ŒAæœ‰ä¸‰æ¡æ—¥å¿—ï¼Œå…¶ä»»æœŸå·åˆ†åˆ«ä¸º5ã€6ã€7ï¼›Bæœ‰ä¸€æ¡æ—¥å¿—ï¼Œä»»æœŸå·ä¸º5ï¼›Cæœ‰ä¸€æ¡æ—¥å¿—ï¼Œä»»æœŸå·ä¸º5ã€‚</p><p>è¿™æ—¶ï¼ŒAè¿˜æ²¡å¤åˆ¶æ—¥å¿—ç»™Bã€Cï¼Œç„¶åAã€Bã€Céƒ½å´©æºƒäº†ã€‚ä¹‹åBã€Cé‡å¯ï¼ŒBã€Céœ€è¦é€‰ä¸¾å‡ºä¸€ä¸ªLeaderï¼Œä½†æ˜¯ç”±äºæ²¡æœ‰æŒä¹…åŒ– currentTermï¼Œå› æ­¤Bã€Cä¸çŸ¥é“å½“å‰çš„ä»»æœŸå·æ˜¯å¤šå°‘ï¼Œä¸€ç§å¯èƒ½çš„æ–¹æ³•æ˜¯Bã€Cé€šè¿‡æŸ¥çœ‹è‡ªå·±çš„æœ€åä¸€æ¡æ—¥å¿—å‘ç°ä»»æœŸå·ä¸º5ï¼Œäºæ˜¯å°±ä¼šé€’å¢ä»»æœŸå·å¹¶åœ¨ä»»æœŸ6ä¸­é€‰å‡ºä¸€ä¸ªLeaderã€‚</p><p>ä½†æ˜¯6æ˜¯ä¸€ä¸ªæ—§çš„ä»»æœŸå·ï¼Œåœ¨ä¹‹å‰çš„è¿™ä¸ªä»»æœŸä¸­å·²ç»é€‰ä¸¾å‡ºäº†ä¸€ä¸ªLeaderäº†ï¼Œè¿™æ ·ä¸€ä¸ªä»»æœŸä¸­å°±é€‰å‡ºäº†ä¸¤ä¸ªLeaderï¼Œå› æ­¤è¿åäº†é€‰ä¸¾å®‰å…¨ç‰¹æ€§ã€‚</p><h3 id="votedFor-æŒä¹…åŒ–"><a href="#votedFor-æŒä¹…åŒ–" class="headerlink" title="votedFor æŒä¹…åŒ–"></a>votedFor æŒä¹…åŒ–</h3><p>votefFor éœ€è¦è¢«æŒä¹…åŒ–å­˜å‚¨ä¹Ÿæ˜¯ä¸ºäº†ç¡®ä¿é€‰ä¸¾å®‰å…¨ç‰¹æ€§ã€‚</p><p>å‡è®¾ä¸€å…±æœ‰ä¸‰å°æœåŠ¡å™¨Aã€Bã€Cã€‚Aæ”¶åˆ°äº†Bå‘æ¥çš„æŠ•ç¥¨è¯·æ±‚ï¼Œè¿™æ—¶Aæ£€æŸ¥å‘ç°è‡ªå·±çš„ votedFor ä¸ºç©ºï¼Œäºæ˜¯ç»™BæŠ•ç¥¨ã€‚</p><p>ç„¶åAé©¬ä¸Šå°±å´©æºƒé‡å¯äº†ï¼Œè¿™æ—¶æ”¶åˆ°Cå‘æ¥çš„æŠ•ç¥¨è¯·æ±‚ï¼Œç”±äº votedFor æ²¡æœ‰è¢«æŒä¹…åŒ–å­˜å‚¨ï¼Œå› æ­¤Bæ£€æŸ¥å‘ç°è‡ªå·±çš„ votedFor ä¸ºç©ºï¼Œç„¶åä¹Ÿä¼šç»™CæŠ•ç¥¨ã€‚è¿™æ ·Bã€Céƒ½æ”¶åˆ°äº†è¿‡åŠæ•°çš„æŠ•ç¥¨ï¼ŒBã€Céƒ½ä¼šæˆä¸º Leaderï¼Œè¿™å°±è¿åäº†é€‰ä¸¾å®‰å…¨ç‰¹æ€§ã€‚</p><h3 id="log-æŒä¹…åŒ–"><a href="#log-æŒä¹…åŒ–" class="headerlink" title="log[] æŒä¹…åŒ–"></a>log[] æŒä¹…åŒ–</h3><p>æ—¥å¿—éœ€è¦è¢«æŒä¹…åŒ–å­˜å‚¨æ˜¯å› ä¸ºåœ¨å´©æºƒé‡å¯åï¼Œåº”ç”¨ç¨‹åºå¯ä»¥æ ¹æ®ä¿å­˜çš„æ—¥å¿—æ¡ç›®æ¥é‡å»ºå´©æºƒå‰çš„è¿è¡ŒçŠ¶æ€ã€‚</p><p>å‡è®¾ç”±äºæ–­ç”µæˆ–è€…å…¶ä»–åŸå› å¯¼è‡´æ‰€æœ‰çš„æœåŠ¡å™¨å…¨éƒ½é‡å¯äº†ï¼Œè¿™æ—¶æ‰€æœ‰çš„æœåŠ¡å™¨éƒ½æ²¡æœ‰ä»»ä½•å…³äºä¹‹å‰çš„æ—¥å¿—æ¡ç›®ä¿¡æ¯ï¼Œè¿™æ ·çš„è¯å°±ä¸å¯èƒ½æ¢å¤åˆ°å´©æºƒå‰çš„è¿è¡ŒçŠ¶æ€äº†ã€‚</p><h2 id="LAB-2C-ä¸­é‡åˆ°çš„é—®é¢˜"><a href="#LAB-2C-ä¸­é‡åˆ°çš„é—®é¢˜" class="headerlink" title="LAB 2C ä¸­é‡åˆ°çš„é—®é¢˜"></a>LAB 2C ä¸­é‡åˆ°çš„é—®é¢˜</h2><p>æœ€åè¯´ä¸€è¯´ï¼Œåœ¨å®ç° 6.824 çš„ LAB 2C çš„è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸¤ä¸ª Bugã€‚</p><h3 id="Bug-1"><a href="#Bug-1" class="headerlink" title="Bug 1"></a>Bug 1</h3><p>é‡åˆ°çš„ç¬¬ä¸€ä¸ªBugçš„é”™è¯¯æ—¥å¿—å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs go">                                    S1 starts election                                                                                                                      <br>                                    S1 becomes Candidate                                                                                                                    <br>                                    S1 change term from <span class="hljs-number">40</span> to <span class="hljs-number">41</span>                                                                                                            <br>                                    S1 votes <span class="hljs-keyword">for</span> S1                                                                                                                         <br>S0 receives VoteRequestRpc from S1                                                                                                                                          <br>S0 becomes Follower                                                                                                                                                         <br>S0 changes term from <span class="hljs-number">40</span> to <span class="hljs-number">41</span>                                                                                                                                               <br>S0 votes <span class="hljs-keyword">for</span> S1                                                                                                                                                             <br>                                                                      S2 receives VoteRequestRpc from                                                                       <br>                                                                      S1                                                                                                    <br>                                                                      S2 changes term from <span class="hljs-number">40</span> to <span class="hljs-number">41</span>                                                                         <br>                                                                                                                                          S4 sends hearbeat                 <br>                                                                                                                                          ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚<br><br>                                                                                                        S3 starts election                                                  <br>                                                                                                        S3 change term from <span class="hljs-number">40</span> to <span class="hljs-number">41</span>                                        <br>                                                                                                        S3 votes <span class="hljs-keyword">for</span> S3                                                     <br>                                                                                                                                          S4 sends hearbeat                 <br>                                                                                                                                           ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚<br><br>S0 starts election                                                                                                                                                          <br>S0 becomes Candidate                                                                                                                                                        <br>S0 change term from <span class="hljs-number">41</span> to <span class="hljs-number">42</span>                                                                                                                                                <br>S0 votes <span class="hljs-keyword">for</span> S0                                                                                                                                                             <br>                                    S1 receives VoteRequestRpc from                                                                                                         <br>                                    S0                                                                                                                                      <br>                                    S1 becomes Follower                                                                                                                     <br>                                    S1 changes term from <span class="hljs-number">41</span> to <span class="hljs-number">42</span>                                                                                                           <br>                                    S1 votes <span class="hljs-keyword">for</span> S0                                                                                                                         <br>                                                                      S2 receives VoteRequestRpc from                                                                       <br>                                                                      S0                                                                                                    <br>                                                                      S2 changes term from <span class="hljs-number">41</span> to <span class="hljs-number">42</span>                                                                         <br>                                                                                                                                          S4 sends hearbeat                 <br>                                                                                                                                           ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚<br><br>                                                                                                        S3 starts election                                                  <br>                                                                                                        S3 change term from <span class="hljs-number">41</span> to <span class="hljs-number">42</span>                                        <br>                                                                                                        S3 votes <span class="hljs-keyword">for</span> S3                                                     <br>                                                                                                                                          S4 sends hearbeat                 <br>                                                                                                                                           ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚<br><br>                                    S1 starts election                                                                                                                      <br>                                    S1 becomes Candidate                                                                                                                    <br>                                    S1 change term from <span class="hljs-number">42</span> to <span class="hljs-number">43</span>                                                                                                            <br>                                    S1 votes <span class="hljs-keyword">for</span> S1                                                                                                                         <br>S0 receives VoteRequestRpc from S1                                                                                                                                          <br>S0 becomes Follower                                                                                                                                                         <br>S0 changes term from <span class="hljs-number">42</span> to <span class="hljs-number">43</span>                                                                                                                                               <br>                                                                      S2 receives VoteRequestRpc from                                                                       <br>                                                                      S1                                                                                                    <br>                                                                      S2 changes term from <span class="hljs-number">42</span> to <span class="hljs-number">43</span>                                                                         <br>S0 votes <span class="hljs-keyword">for</span> S1  <br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼ŒS0ã€S1å’ŒS2åœ¨ä¸€ä¸ªç½‘ç»œåˆ†åŒºä¸­ï¼ŒS3 å’Œ S4 åˆ†åˆ«åœ¨ä¸€ä¸ªç½‘ç»œåˆ†åŒºä¸­ã€‚S0ã€S1çš„æ—¥å¿—æ²¡æœ‰S2çš„æ—¥å¿—æ–°ã€‚</p><p>ä»æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒS1æ€»æ˜¯å…ˆå‘èµ·é€‰ä¸¾ï¼Œç„¶åS2æ”¶åˆ°S1çš„æŠ•ç¥¨è¯·æ±‚åä¼šè½¬åŒ–ä¸ºè·Ÿéšè€…ï¼ŒS2ä¼šé‡ç½®è‡ªå·±çš„é€‰ä¸¾è®¡æ—¶å™¨ï¼Œè¿™å°±å¯¼è‡´S2ä¸€ç›´æ— æ³•å‘èµ·é€‰ä¸¾æŠ•ç¥¨ã€‚</p><p>è§£å†³æ–¹æ³•æ˜¯ï¼Œåœ¨æ”¶åˆ°æŠ•ç¥¨è¯·æ±‚æ—¶ï¼Œå¦‚æœéœ€è¦è½¬åŒ–ä¸ºè·Ÿéšè€…ï¼Œåˆ™ä¸é‡ç½®é€‰ä¸¾è®¡æ—¶å™¨ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> args.Term &gt; rf.currentTerm &#123;<br>    rf.convertToFollower(args.Term, <span class="hljs-literal">false</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> convertToFollower(term <span class="hljs-type">int</span>, resetFlag <span class="hljs-type">bool</span>) &#123;<br>    <span class="hljs-comment">// .......</span><br>    <span class="hljs-comment">// .......</span><br>    <span class="hljs-keyword">if</span> resetFlag &#123;<br>        rf.electionStart = time.Now()<br>        rf.electionTimeout = rf.randomElectionTimeout()<br>    &#125;<br>    <span class="hljs-keyword">go</span> rf.ticker()<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œå³ä½¿S2åœ¨æ”¶åˆ°S1çš„æŠ•ç¥¨è¯·æ±‚åè½¬åŒ–ä¸ºè·Ÿéšè€…ï¼Œä¹Ÿä¸ä¼šé‡ç½®é€‰ä¸¾è¶…æ—¶è®¡æ—¶å™¨ï¼Œåœ¨ä¸€å®šæ—¶é—´åS2å°†èƒ½å¤Ÿå‘èµ·é€‰ä¸¾æŠ•ç¥¨ã€‚</p><h3 id="Bug-2"><a href="#Bug-2" class="headerlink" title="Bug 2"></a>Bug 2</h3><p>é‡åˆ°çš„ç¬¬äºŒä¸ªBugçš„é”™è¯¯æ—¥å¿—å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-number">018750</span> LEAD S2 sends hearbeat<br><span class="hljs-number">018750</span> INFO S2 sends hearbeat to S4: &amp;&#123;Term:<span class="hljs-number">4</span> LeaderId:<span class="hljs-number">2</span> PrevLogIndex:<span class="hljs-number">2</span> PrevLogTerm:<span class="hljs-number">3</span> Entries:[&#123;Command:<span class="hljs-number">2420</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">3</span>&#125; &#123;Command:<span class="hljs-number">6554</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">4</span>&#125; &#123;Command:<span class="hljs-number">6316</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">5</span>&#125; &#123;Command:<span class="hljs-number">648</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">6</span>&#125; &#123;Command:<span class="hljs-number">3226</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">7</span>&#125; &#123;Command:<span class="hljs-number">9916</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">8</span>&#125; &#123;Command:<span class="hljs-number">6121</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">9</span>&#125; &#123;Command:<span class="hljs-number">9155</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">10</span>&#125; &#123;Command:<span class="hljs-number">9102</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">11</span>&#125; &#123;Command:<span class="hljs-number">1911</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">12</span>&#125;] LeaderCommit:<span class="hljs-number">0</span>&#125;<br><span class="hljs-number">018752</span> INFO S2 sends hearbeat to S0: &amp;&#123;Term:<span class="hljs-number">4</span> LeaderId:<span class="hljs-number">2</span> PrevLogIndex:<span class="hljs-number">2</span> PrevLogTerm:<span class="hljs-number">3</span> Entries:[&#123;Command:<span class="hljs-number">2420</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">3</span>&#125; &#123;Command:<span class="hljs-number">6554</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">4</span>&#125; &#123;Command:<span class="hljs-number">6316</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">5</span>&#125; &#123;Command:<span class="hljs-number">648</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">6</span>&#125; &#123;Command:<span class="hljs-number">3226</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">7</span>&#125; &#123;Command:<span class="hljs-number">9916</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">8</span>&#125; &#123;Command:<span class="hljs-number">6121</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">9</span>&#125; &#123;Command:<span class="hljs-number">9155</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">10</span>&#125; &#123;Command:<span class="hljs-number">9102</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">11</span>&#125; &#123;Command:<span class="hljs-number">1911</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">12</span>&#125;] LeaderCommit:<span class="hljs-number">0</span>&#125;<br><span class="hljs-number">018753</span> INFO S2 sends hearbeat to S1: &amp;&#123;Term:<span class="hljs-number">4</span> LeaderId:<span class="hljs-number">2</span> PrevLogIndex:<span class="hljs-number">2</span> PrevLogTerm:<span class="hljs-number">3</span> Entries:[&#123;Command:<span class="hljs-number">2420</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">3</span>&#125; &#123;Command:<span class="hljs-number">6554</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">4</span>&#125; &#123;Command:<span class="hljs-number">6316</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">5</span>&#125; &#123;Command:<span class="hljs-number">648</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">6</span>&#125; &#123;Command:<span class="hljs-number">3226</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">7</span>&#125; &#123;Command:<span class="hljs-number">9916</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">8</span>&#125; &#123;Command:<span class="hljs-number">6121</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">9</span>&#125; &#123;Command:<span class="hljs-number">9155</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">10</span>&#125; &#123;Command:<span class="hljs-number">9102</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">11</span>&#125; &#123;Command:<span class="hljs-number">1911</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">12</span>&#125;] LeaderCommit:<span class="hljs-number">0</span>&#125;<br><span class="hljs-number">018754</span> INFO S2 sends hearbeat to S3: &amp;&#123;Term:<span class="hljs-number">4</span> LeaderId:<span class="hljs-number">2</span> PrevLogIndex:<span class="hljs-number">2</span> PrevLogTerm:<span class="hljs-number">3</span> Entries:[&#123;Command:<span class="hljs-number">2420</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">3</span>&#125; &#123;Command:<span class="hljs-number">6554</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">4</span>&#125; &#123;Command:<span class="hljs-number">6316</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">5</span>&#125; &#123;Command:<span class="hljs-number">648</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">6</span>&#125; &#123;Command:<span class="hljs-number">3226</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">7</span>&#125; &#123;Command:<span class="hljs-number">9916</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">8</span>&#125; &#123;Command:<span class="hljs-number">6121</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">9</span>&#125; &#123;Command:<span class="hljs-number">9155</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">10</span>&#125; &#123;Command:<span class="hljs-number">9102</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">11</span>&#125; &#123;Command:<span class="hljs-number">1911</span> Term:<span class="hljs-number">4</span> CommandIndex:<span class="hljs-number">12</span>&#125;] LeaderCommit:<span class="hljs-number">0</span>&#125;<br><span class="hljs-number">018764</span> VOTE S2 receives VoteRequestRpc from S3<br><span class="hljs-number">018764</span> INFO S2 becomes Follower<br><span class="hljs-number">018764</span> TERM S2 changes term from <span class="hljs-number">4</span> to <span class="hljs-number">5</span><br><span class="hljs-number">018866</span> VOTE S2 starts election<br><span class="hljs-number">018867</span> INFO S2 becomes Candidate<br><span class="hljs-number">018867</span> TERM S2 change term from <span class="hljs-number">5</span> to <span class="hljs-number">6</span><br><span class="hljs-number">018867</span> VOTE S2 votes <span class="hljs-keyword">for</span> S2<br><span class="hljs-number">018869</span> VOTE S1 receives VoteRequestRpc from S3<br><span class="hljs-number">018869</span> TERM S1 changes term from <span class="hljs-number">4</span> to <span class="hljs-number">5</span><br><span class="hljs-number">018870</span> VOTE S1 votes <span class="hljs-keyword">for</span> S3<br><span class="hljs-number">018988</span> INFO S3 receives AppendEntriesRpc from S2<br><span class="hljs-number">018988</span> INFO S3 reply AppendEntriesRpc from S2: &amp;Reply&#123;Term: <span class="hljs-number">5</span>, Success: <span class="hljs-literal">false</span>&#125;<br><span class="hljs-number">018992</span> VOTE S3 receives VoteRequestRpc from S2<br><span class="hljs-number">018992</span> INFO S3 becomes Follower<br><span class="hljs-number">018992</span> TERM S3 changes term from <span class="hljs-number">5</span> to <span class="hljs-number">6</span><br><span class="hljs-number">018992</span> VOTE S3 votes <span class="hljs-keyword">for</span> S2<br><span class="hljs-number">019029</span> VOTE S1 receives VoteRequestRpc from S2<br><span class="hljs-number">019029</span> TERM S1 changes term from <span class="hljs-number">5</span> to <span class="hljs-number">6</span><br><span class="hljs-number">019029</span> VOTE S1 votes <span class="hljs-keyword">for</span> S2<br><span class="hljs-number">019032</span> INFO S2 becomes Leader<br><span class="hljs-number">019032</span> LEAD S2 sends hearbeat<br><span class="hljs-number">019033</span> INFO S2 sends hearbeat to S4: &amp;&#123;Term:<span class="hljs-number">6</span> LeaderId:<span class="hljs-number">2</span> PrevLogIndex:<span class="hljs-number">12</span> PrevLogTerm:<span class="hljs-number">4</span> Entries:[] LeaderCommit:<span class="hljs-number">0</span>&#125;<br><span class="hljs-number">019035</span> INFO S1 receives AppendEntriesRpc from S2<br><span class="hljs-number">019035</span> INFO S1 reply AppendEntriesRpc from S2: &amp;Reply&#123;Term: <span class="hljs-number">6</span>, Success: <span class="hljs-literal">false</span>&#125;<br><span class="hljs-built_in">panic</span>: runtime <span class="hljs-type">error</span>: index out of <span class="hljs-keyword">range</span> [<span class="hljs-number">-1</span>]<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªç”±äºè´Ÿæ•°ç´¢å¼•å¯¼è‡´çš„è¿è¡Œå´©æºƒé”™è¯¯ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼ˆåœ¨ç¬¬20è¡Œå´©æºƒï¼‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go">rf.mu.Lock()<br><span class="hljs-comment">// å·²ç»ä¸æ˜¯é¢†å¯¼äººäº†ï¼Œç›´æ¥è¿”å›</span><br><span class="hljs-keyword">if</span> rf.role != LEADER &#123;<br>    rf.mu.Unlock()<br>    <span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-comment">// è·Ÿéšè€…èŠ‚ç‚¹å·²ç»è¢«Killäº†ï¼Œç›´æ¥è¿”å›</span><br><span class="hljs-keyword">if</span> reply.Term &lt; rf.currentTerm &#123;<br>    rf.mu.Unlock()<br>    <span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">if</span> reply.Term &gt; rf.currentTerm &#123;<br>    rf.convertToFollower(reply.Term, <span class="hljs-literal">true</span>)<br>    rf.mu.Unlock()<br>    <span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">if</span> !reply.Success &#123;<br>    <span class="hljs-keyword">if</span> reply.XTerm == <span class="hljs-number">-1</span> &#123;<br>        rf.nextIndex[peerId] = prevLogIndex - reply.XLen + <span class="hljs-number">1</span><br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> reply.XTerm == rf.log[reply.XIndex<span class="hljs-number">-1</span>].Term &#123;<br>        rf.nextIndex[peerId] = reply.XIndex + <span class="hljs-number">1</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        rf.nextIndex[peerId] = reply.XIndex<br>    &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// ....</span><br>    <span class="hljs-comment">// .....</span><br>&#125;<br>rf.mu.Unlock()<br></code></pre></td></tr></table></figure><p>åœ¨æˆ‘çš„å®ç°ä¸­åªæœ‰ä¸‰ç§æƒ…å†µ <code>reply.Success = false</code>ï¼š</p><ul><li><p>èŠ‚ç‚¹å·²ç»è¢«Killäº†ï¼Œè¿™æ—¶å€™ä¼šè¿”å› <code>reply.Term = 0</code></p></li><li><p>æ”¶åˆ°çš„å¿ƒè·³çš„ä»»æœŸå·æ¯”å½“å‰èŠ‚ç‚¹çš„ä»»æœŸå·å°ï¼Œè¿™æ—¶å€™ä¼šè¿”å› <code>reply.Term=XX</code></p></li><li><p>æ”¶åˆ°çš„å¿ƒè·³çš„<code>prevLogIndex</code>ä½ç½®çš„æ—¥å¿—ä¸åŒ¹é…ï¼Œè¿™æ—¶å€™ä¼šè¿”å› <code>reply.XTerm=-1</code> æˆ– <code>reply.XIndex=YY</code></p></li></ul><p>ç¬¬ä¸€ç§æƒ…å†µï¼Œç¬¬å…«è¡Œçš„ä»£ç ä¼šå°†å…¶æ’é™¤ã€‚ç¬¬äºŒç§æƒ…å†µï¼Œç¬¬åäºŒè¡Œä»£ç ä¼šå°†å…¶æ’é™¤ã€‚ç¬¬ä¸‰ç§æƒ…å†µï¼Œå¦‚æœè¦èµ°åˆ°ç¬¬20è¡Œï¼Œåˆ™åªèƒ½æ˜¯ <code>reply.XIndex=YY</code>ï¼Œä½†æ˜¯æˆ‘çš„å®ç°ä¸­ <code>YY</code> ä¸€å®šå¤§äº0ã€‚è¿™æ ·ï¼Œæ‰€æœ‰æƒ…å†µéƒ½æ’é™¤äº†ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p><p>é€šè¿‡è§‚å¯Ÿæ—¥å¿—å¯ä»¥å‘ç°ï¼Œåœ¨ç¬¬å››è¡Œï¼ŒS2ç»™S1å‘é€äº†ä¸€ä¸ªå¿ƒè·³ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">S2 sends hearbeat to S1: &amp;&#123;Term:<span class="hljs-number">4</span>, ......&#125;<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶S2çš„ä»»æœŸå·ä¸º4ã€‚ä»ç¬¬å››è¡Œåˆ°ç¬¬25è¡Œï¼ŒS2å…ˆæ˜¯å˜æˆäº†Followerï¼Œä¹‹ååˆåœ¨ä»»æœŸ6è¢«é€‰ä¸¾æˆä¸ºLeaderã€‚</p><p>åœ¨ç¬¬28è¡Œï¼ŒS1ç»ˆäºæ”¶åˆ°äº†S2å‘é€çš„å¿ƒè·³ï¼Œæ­¤æ—¶S1çš„ä¿å­˜çš„ä»»æœŸå·ä¸º6ï¼Œå› æ­¤å®ƒä¼šè¿”å› <code>Reply&#123;Term: 6, Success: false, XIndex=0&#125;</code>ã€‚è¿™æ˜¯å‰é¢æåˆ°çš„ç¬¬äºŒç§æƒ…å†µï¼Œä½†æ˜¯æ­¤æ—¶S2çš„ä»»æœŸå·ä¹Ÿå˜æˆäº†6ï¼Œå› æ­¤ç¬¬åäºŒè¡Œä»£ç å°±æ— æ³•æ’é™¤è¿™ç§æƒ…å†µã€‚æœ€ç»ˆä»£ç å°±ä¼šæ‰§è¡Œåˆ°ç¬¬20è¡Œï¼Œå¯¼è‡´è¿è¡Œæ—¶å´©æºƒã€‚</p><p>å¯è§ï¼Œè¿™æ˜¯ç”±äºç½‘ç»œå»¶è¿Ÿå¯¼è‡´çš„é”™è¯¯ï¼Œè§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨ç¬¬20è¡Œä»£ç ä¹‹å‰åœ¨åŠ ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœ<code>reply.XIndex=0</code>åˆ™ä¸æ‰§è¡Œåé¢çš„ä»£ç äº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> reply.XTerm == <span class="hljs-number">-1</span> &#123;<br>    rf.nextIndex[peerId] = prevLogIndex - reply.XLen + <span class="hljs-number">1</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> reply.XIndex != <span class="hljs-number">0</span> &#123;<br>    <span class="hljs-keyword">if</span> reply.XTerm == rf.log[reply.XIndex<span class="hljs-number">-1</span>].Term &#123;<br>        rf.nextIndex[peerId] = reply.XIndex + <span class="hljs-number">1</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        rf.nextIndex[peerId] = reply.XIndex<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è§£å†³å®Œä¸Šè¿°çš„ä¸¤ä¸ªBugåï¼Œå¹¶å‘è·‘500æ¬¡æµ‹è¯•ï¼Œå…¨éƒ¨é¡ºåˆ©é€šè¿‡ï¼š</p><img src="/2022/08/06/Raft-4/Raft-%E5%9B%BE1.png" class=""><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><p><a href="https://pdos.csail.mit.edu/6.824/">MIT 6.824</a></p></li><li><p><a href="https://raft.github.io/raft.pdf">Raft paper</a></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>distributed system</category>
      
    </categories>
    
    
    <tags>
      
      <tag>distributed</tag>
      
      <tag>consistency</tag>
      
      <tag>paper</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Raftï¼ˆä¸‰ï¼‰ï¼šæ—¥å¿—å¤åˆ¶</title>
    <link href="/2022/07/31/Raft-3/"/>
    <url>/2022/07/31/Raft-3/</url>
    
    <content type="html"><![CDATA[<h2 id="æ—¥å¿—å¤åˆ¶"><a href="#æ—¥å¿—å¤åˆ¶" class="headerlink" title="æ—¥å¿—å¤åˆ¶"></a>æ—¥å¿—å¤åˆ¶</h2><p>å…·ä½“çš„æ—¥å¿—å¤åˆ¶ç®—æ³•ï¼Œåœ¨ Raft è®ºæ–‡ä¸­è¯´çš„éå¸¸è¯¦ç»†ï¼š<a href="https://raft.github.io/raft.pdf">Raft paper</a>ï¼ˆç¬¬5èŠ‚ã€5.3èŠ‚ï¼‰ã€‚</p><p>åœ¨ LAB 2B çš„å®ç°ä¸­éœ€è¦æ–½åŠ é€‰ä¸¾é™åˆ¶ï¼š<a href="https://raft.github.io/raft.pdf">Raft paper</a>ï¼ˆç¬¬5.4.1èŠ‚ï¼‰ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒLeader åªèƒ½æäº¤å½“å‰ä»»æœŸå†…çš„æ—¥å¿—ï¼š<a href="https://raft.github.io/raft.pdf">Raft paper</a>ï¼ˆç¬¬5.4.2èŠ‚ï¼‰ã€‚</p><h2 id="æ—¥å¿—åŠ é€Ÿå›é€€"><a href="#æ—¥å¿—åŠ é€Ÿå›é€€" class="headerlink" title="æ—¥å¿—åŠ é€Ÿå›é€€"></a>æ—¥å¿—åŠ é€Ÿå›é€€</h2><p>åœ¨ <a href="https://raft.github.io/raft.pdf">Raft paper</a>ï¼ˆç¬¬5èŠ‚ï¼‰ä¸­æåˆ°ï¼Œå¦‚æœ Leader å‘ä¸€ä¸ª Follower è¿½åŠ æ—¥å¿—å¤±è´¥ï¼Œå°±è¡¨æ˜ Leader å’Œ Follower çš„æ—¥å¿—æœ‰å†²çªï¼Œåˆ™ Leader ä¼šå›é€€ä¸€ä¸ª Logï¼Œä¹‹åå†æ¬¡å‘è·Ÿéšè€…è¿½åŠ æ—¥å¿—ã€‚</p><p>å‡è®¾æœ‰è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œæˆ‘ä»¬æœ‰5ä¸ªæœåŠ¡å™¨ï¼Œæœ‰1ä¸ª Leaderï¼Œè¿™ä¸ª Leader å’Œå¦ä¸€ä¸ª Follower å›°åœ¨ä¸€ä¸ªç½‘ç»œåˆ†åŒºä¸­ã€‚è¿™ä¸ª Leader ä¸€ç›´å‘å®ƒå”¯ä¸€çš„ Follower å‘é€ AppendEntriesï¼Œå› ä¸ºæ²¡æœ‰è¿‡åŠæœåŠ¡å™¨ï¼Œæ‰€ä»¥æ²¡æœ‰ä¸€æ¡ Log ä¼š commitã€‚åœ¨å¦ä¸€ä¸ªæœ‰å¤šæ•°æœåŠ¡å™¨çš„ç½‘ç»œåˆ†åŒºä¸­ï¼Œç³»ç»Ÿä¼šé€‰å‡ºæ–°çš„ Leader å¹¶ç»§ç»­è¿è¡Œã€‚æ—§çš„ Leader å’Œå®ƒçš„ Follower å¯èƒ½ä¼šè®°å½•æ— é™å¤šçš„æ—§çš„ä»»æœŸçš„æœª commit çš„ Logã€‚å½“æ—§çš„ Leader å’Œå®ƒçš„ Follower é‡æ–°åŠ å…¥åˆ°é›†ç¾¤ä¸­æ—¶ï¼Œè¿™äº› Log éœ€è¦è¢«åˆ é™¤å¹¶è¦†ç›–ã€‚</p><p>å¦‚æœ Leader æ¯æ¬¡åªèƒ½åœ¨é™„åŠ æ—¥å¿—RPC å¤±è´¥åå›é€€ä¸€ä¸ª Log ç„¶åé‡è¯•çš„è¯ï¼Œå¯èƒ½ä¼šè€—è´¹å¤§é‡çš„æ—¶é—´ã€‚å› æ­¤ï¼Œéœ€è¦æŸäº›æ–¹æ³•æ¥åŠ é€Ÿæ—¥å¿—çš„å›é€€ã€‚</p><p>6.824 çš„è¯¾å ‚ä¸Šï¼ŒRobert æ•™æˆç»™å‡ºäº†ä¸€ä¸ªæ–¹æ³•ï¼šè®© Leader å¯ä»¥æ¯æ¬¡å›é€€ä¸€æ•´ä¸ªä»»æœŸçš„ Logï¼Œè€Œä¸æ˜¯åªå›é€€ä¸€ä¸ª Logã€‚</p><p>æˆ‘ä»¬å°†å¯èƒ½çš„åœºæ™¯åˆ†æˆ3ç±»ï¼Œåœ¨è¿™é‡Œå‡è®¾æˆ‘ä»¬åªæœ‰ä¸€ä¸ª Leader(S2)å’Œä¸€ä¸ª Follower(S1)ï¼ŒS2 è¦å‘é€ä¸€æ¡ä»»æœŸå·ä¸º6çš„ AppendEntries æ¶ˆæ¯ç»™ S1ï¼š</p><p>ï¼ˆ1ï¼‰åœºæ™¯ä¸€</p><p>S1æ²¡æœ‰ä»»æœŸ6çš„ Logï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å›é€€ä¸€æ•´ä¸ªä»»æœŸçš„ Logã€‚</p><img src="/2022/07/31/Raft-3/Raft-%E5%9B%BE1.png" class=""><p>ï¼ˆ2ï¼‰åœºæ™¯äºŒ</p><p>S1 æ”¶åˆ°äº†ä»»æœŸ4çš„æ—§ Leader çš„å¤šæ¡ Logï¼Œä½†æ˜¯ä½œä¸ºæ–° Leaderï¼ŒS2 åªæ”¶åˆ°äº†ä¸€æ¡ä»»æœŸ4çš„ Logã€‚æ‰€ä»¥è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦è¦†ç›– S1 ä¸­æœ‰å…³æ—§ Leader çš„ Logã€‚</p><img src="/2022/07/31/Raft-3/Raft-%E5%9B%BE2.png" class=""><p>ï¼ˆ3ï¼‰åœºæ™¯ä¸‰</p><p>S1 ä¸ S2 çš„ Log ä¸å†²çªï¼Œä½†æ˜¯ S1 ç¼ºå¤±äº†éƒ¨åˆ† S2 ä¸­çš„Logï¼Œè¿™é‡Œæˆ‘ä»¬å›é€€æ‰æ‰€æœ‰ç©ºç¼ºçš„ Logã€‚</p><img src="/2022/07/31/Raft-3/Raft-%E5%9B%BE3.png" class=""><p>å¯ä»¥è®© Follower åœ¨å›å¤ Leader çš„ AppendEntries æ¶ˆæ¯ä¸­ï¼Œæºå¸¦3ä¸ªé¢å¤–çš„å˜é‡ï¼Œæ¥åŠ é€Ÿæ—¥å¿—çš„æ¢å¤ï¼š</p><ul><li><p>XTermï¼šFollower ä¸ Leader å†²çªçš„ Log å¯¹åº”çš„ä»»æœŸå·ã€‚å¦‚æœ Follower åœ¨ PrevLogIndex ä½ç½®çš„ä»»æœŸå·ä¸ Leader ä¸åŒ¹é…ï¼Œå®ƒä¼šæ‹’ç» Leader çš„ AppendEntries æ¶ˆæ¯ï¼Œå¹¶å°†è‡ªå·±çš„ä»»æœŸå·æ”¾åœ¨ XTerm ä¸­ã€‚å¦‚æœ Follower åœ¨å¯¹åº”ä½ç½®æ²¡æœ‰ Logï¼Œé‚£ä¹ˆè¿™é‡Œä¼šè¿”å› -1ã€‚</p></li><li><p>XIndexï¼šFolower ä¸­ä»»æœŸå·ä¸º XTerm çš„ç¬¬ä¸€æ¡ Log çš„æ§½ä½å·ã€‚</p></li><li><p>XLenï¼šå¦‚æœ Follower åœ¨ PrevLogIndex ä½ç½®æ²¡æœ‰ Logï¼Œé‚£ä¹ˆ XTerm ä¼šè¿”å›-1ï¼ŒXLen è¡¨ç¤ºç©ºç™½çš„ Log æ§½ä½æ•°ã€‚</p></li></ul><p>Leader æ”¶åˆ°é”™è¯¯è¿”å›æ—¶ï¼Œå°±å¯ä»¥æ ¹æ®ä¸Šè¿°ä¿¡æ¯åŠ é€Ÿæ—¥å¿—å›é€€ï¼š</p><ul><li><p>åœºæ™¯ä¸€ï¼šS1 ä¼šè¿”å› XTerm&#x3D;5ï¼ŒXIndex&#x3D;2ã€‚S2 å‘ç°è‡ªå·±æ²¡æœ‰ä»»æœŸ5çš„æ—¥å¿—ï¼Œå®ƒä¼šå°† S1 çš„ nextIndex è®¾ç½®ä¸º XIndexï¼Œä¹Ÿå°±æ˜¯S1ä¸­ï¼Œä»»æœŸ5çš„ç¬¬ä¸€æ¡Logå¯¹åº”çš„æ§½ä½å·ã€‚</p></li><li><p>åœºæ™¯äºŒï¼šS1 ä¼šè¿”å› XTerm&#x3D;4ï¼ŒXIndex&#x3D;1ã€‚S2 å‘ç°è‡ªå·±æœ‰ä»»æœŸ4çš„æ—¥å¿—ï¼Œå®ƒä¼šå°† S1 çš„ nextIndex è®¾ç½®ä¸º XIndex+1ã€‚</p></li><li><p>åœºæ™¯ä¸‰ï¼šS1 ä¼šè¿”å› XTerm&#x3D;-1ï¼ŒXLen&#x3D;2ã€‚è¿™è¡¨ç¤º S1 ä¸­æ—¥å¿—å¤ªçŸ­äº†ï¼Œåœ¨å†²çªçš„ä½ç½®æ²¡æœ‰ Log æ¡ç›®ï¼ŒLeader åº”è¯¥å›é€€åˆ° Follower æœ€åä¸€æ¡ Log æ¡ç›®çš„ä¸‹ä¸€æ¡ï¼Œä¹Ÿå°±æ˜¯è¯´ S2 ä¼šå°† S1 çš„ nextIndex è®¾ç½®ä¸º nextIndex-XLenã€‚</p></li></ul><h2 id="LAB-2B-ä¸­é‡åˆ°çš„é—®é¢˜"><a href="#LAB-2B-ä¸­é‡åˆ°çš„é—®é¢˜" class="headerlink" title="LAB 2B ä¸­é‡åˆ°çš„é—®é¢˜"></a>LAB 2B ä¸­é‡åˆ°çš„é—®é¢˜</h2><p>æœ€åè¯´ä¸€è¯´ï¼Œåœ¨å®ç° 6.824 çš„ LAB 2B çš„è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€äº› Bugã€‚</p><h3 id="Bug-1"><a href="#Bug-1" class="headerlink" title="Bug 1"></a>Bug 1</h3><p>åœ¨è¿è¡Œ LAB 2B çš„æµ‹è¯•åï¼Œç¬¬ä¸€ä¸ªæ²¡æœ‰é€šè¿‡çš„æ˜¯æµ‹è¯• <code>TestRPCBytes2B</code>ã€‚é”™è¯¯æ—¥å¿—å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go">S0 starts running                                                                                                                        <br>                                               S1 starts running                                                                         <br>                                                                                            S2 starts running                            <br>                                                                                            S2 starts election                           <br>                                                                                            S2 becomes Candidate                         <br>                                                                                            S2 change term from <span class="hljs-number">0</span> to <span class="hljs-number">1</span>                   <br>                                                                                            S2 votes <span class="hljs-keyword">for</span> S2                              <br>S0 receives VoteRequestRpc from S2                                                                                                       <br>S0 becomes Follower                                                                                                                      <br>S0 changes term from <span class="hljs-number">1</span> to <span class="hljs-number">1</span>                                                                                                              <br>S0 votes <span class="hljs-keyword">for</span> S2                                                                                                                          <br>                                                                                            S2 becomes Leader                            <br>                                               S1 receives VoteRequestRpc from S2                                                        <br>                                               S1 becomes Follower                                                                       <br>                                               S1 changes term from <span class="hljs-number">1</span> to <span class="hljs-number">1</span>                                                               <br>                                               S1 votes <span class="hljs-keyword">for</span> S2                                                                           <br>                                                                                            S2 sends hearbeat                            <br>                                                                                            S2 becomes Leader                            <br>                                                                                            S2 sends hearbeat                                <br></code></pre></td></tr></table></figure><p>åœ¨é”™è¯¯æ—¥å¿—ä¸­ï¼ŒS2 è¿ç»­ä¸¤æ¬¡æˆä¸º Leaderï¼Œå¯¼è‡´ S2 ä¸­è¿è¡Œäº†ä¸¤ä¸ª <code>heartbeat ticker</code>ï¼Œå› æ­¤ S2 å°±ä¼šå‘é€æ¯”æ­£å¸¸çš„ Leader çš„ä¸¤å€å­—èŠ‚æ•°ï¼Œæ‰€ä»¥æ— æ³•é€šè¿‡ <code>TestRPCBytes2B</code> æµ‹è¯•ã€‚</p><p>æ ¹æ®é”™è¯¯åŸå› ï¼Œå¯ä»¥å®šä½é”™è¯¯æ˜¯åœ¨è¯·æ±‚æŠ•ç¥¨çš„å®ç°ä¸­ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> startElection() &#123;<br>    <span class="hljs-comment">// çœç•¥ã€‚ã€‚ã€‚ã€‚</span><br><br>    receivedVotes := <span class="hljs-number">1</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> rf.peers &#123;<br>        <span class="hljs-keyword">if</span> i == rf.me &#123;<br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(peerId <span class="hljs-type">int</span>)</span></span> &#123;<br>            rf.mu.Lock()<br>Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-comment">// å·²ç»ä¸æ˜¯å€™é€‰è€…äº†ï¼Œç›´æ¥è¿”å›</span><br>            <span class="hljs-keyword">if</span> rf.role != CANDIDATE &#123;<br>                rf.mu.Unlock()<br>                <span class="hljs-keyword">return</span><br>            &#125;<br>            args := &amp;RequestVoteArgs&#123;<br>                Term:         rf.currentTerm,<br>                CandidateId:  rf.me,<br>                LastLogIndex: rf.lastLogIndex,<br>                LastLogTerm:  rf.lastLogTerm,<br>            &#125;<br>            reply := &amp;RequestVoteReply&#123;&#125;<br>            rf.mu.Unlock()<br><br>            <span class="hljs-keyword">if</span> !rf.sendRequestVote(peerId, args, reply) &#123;<br>                <span class="hljs-keyword">return</span><br>            &#125;<br><br>            rf.mu.Lock()<br>            <span class="hljs-keyword">if</span> reply.Term &gt; rf.currentTerm &#123;<br>                rf.convertToFollower(reply.Term)<br>                rf.mu.Unlock()<br>                <span class="hljs-keyword">return</span><br>            &#125;<br>            <span class="hljs-keyword">if</span> !reply.VoteGranted &#123;<br>                rf.mu.Unlock()<br>                <span class="hljs-keyword">return</span><br>            &#125;<br>            receivedVotes++<br>            <span class="hljs-keyword">if</span> receivedVotes*<span class="hljs-number">2</span> &gt; <span class="hljs-built_in">len</span>(rf.peers) &#123;<br>                rf.convertToLeader()<br>            &#125;<br>            rf.mu.Unlock()<br>        &#125;(i)<br>    &#125;<br><br>    <span class="hljs-comment">// çœç•¥ã€‚ã€‚ã€‚ã€‚</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æŠŠ Go ç¨‹ä¸­é”çš„ä½¿ç”¨åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†ï¼šç¬¬10è¡Œï¼ˆä¸Šé”ï¼‰â€”â€”ç¬¬23è¡Œï¼ˆè§£é”ï¼‰ï¼Œç¬¬äºŒéƒ¨åˆ†ï¼šç¬¬29è¡Œï¼ˆä¸Šé”ï¼‰â€”â€”ç¬¬43è¡Œï¼ˆè§£é”ï¼‰ã€‚</p><p>å‡è®¾æ‰€æœ‰çš„ Go ç¨‹éƒ½æ‰§è¡Œå®Œç¬¬ä¸€éƒ¨åˆ†åï¼Œå†æ‰§è¡Œç¬¬äºŒéƒ¨åˆ†ã€‚è¿™æ ·æ‰€æœ‰çš„ Go ç¨‹éƒ½èƒ½å‘é€è¯·æ±‚æŠ•ç¥¨RPCï¼Œå› ä¸ºæ­¤æ—¶å½“å‰çš„èŠ‚ç‚¹ä¸€å®šæ˜¯è·Ÿéšè€…ã€‚è¿™æ ·ï¼Œå½“æ‰§è¡Œç¬¬äºŒéƒ¨åˆ†æ—¶ï¼Œåœ¨å¾—åˆ°çš„æŠ•ç¥¨æ•°è¾¾åˆ°åŠæ•°æœåŠ¡å™¨æ•°é‡åï¼Œæ¯å¤šæ”¶åˆ°ä¸€ç¥¨ï¼Œå°±ä¼šè°ƒç”¨ <code>rf.convertToLeader()</code> è½¬åŒ–ä¸ºè·Ÿéšè€…ï¼Œä»è€Œå¯¼è‡´ä¸Šè¿°çš„é”™è¯¯ã€‚</p><p>è§£å†³æ–¹æ³•å¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨ç¬¬äºŒéƒ¨åˆ†çš„å¼€å¤´å¢åŠ ä¸€ä¸ªå¯¹å½“å‰èŠ‚ç‚¹æ˜¯å¦è¿˜æ˜¯å€™é€‰è€…çš„åˆ¤æ–­å³å¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> startElection() &#123;<br>    <span class="hljs-comment">// çœç•¥ã€‚ã€‚ã€‚ã€‚</span><br><br>    receivedVotes := <span class="hljs-number">1</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> rf.peers &#123;<br>        <span class="hljs-keyword">if</span> i == rf.me &#123;<br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(peerId <span class="hljs-type">int</span>)</span></span> &#123;<br>            rf.mu.Lock()<br>Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-comment">// å·²ç»ä¸æ˜¯å€™é€‰è€…äº†ï¼Œç›´æ¥è¿”å›</span><br>            <span class="hljs-keyword">if</span> rf.role != CANDIDATE &#123;<br>                rf.mu.Unlock()<br>                <span class="hljs-keyword">return</span><br>            &#125;<br>            args := &amp;RequestVoteArgs&#123;<br>                Term:         rf.currentTerm,<br>                CandidateId:  rf.me,<br>                LastLogIndex: rf.lastLogIndex,<br>                LastLogTerm:  rf.lastLogTerm,<br>            &#125;<br>            reply := &amp;RequestVoteReply&#123;&#125;<br>            rf.mu.Unlock()<br><br>            <span class="hljs-keyword">if</span> !rf.sendRequestVote(peerId, args, reply) &#123;<br>                <span class="hljs-keyword">return</span><br>            &#125;<br><br>            rf.mu.Lock()<br>            <span class="hljs-comment">// å·²ç»ä¸æ˜¯å€™é€‰è€…äº†ï¼Œç›´æ¥è¿”å›</span><br>            <span class="hljs-keyword">if</span> rf.role != CANDIDATE &#123;<br>                rf.mu.Unlock()<br>                <span class="hljs-keyword">return</span><br>            &#125;<br>            <span class="hljs-keyword">if</span> reply.Term &gt; rf.currentTerm &#123;<br>                rf.convertToFollower(reply.Term)<br>                rf.mu.Unlock()<br>                <span class="hljs-keyword">return</span><br>            &#125;<br>            <span class="hljs-keyword">if</span> !reply.VoteGranted &#123;<br>                rf.mu.Unlock()<br>                <span class="hljs-keyword">return</span><br>            &#125;<br>            receivedVotes++<br>            <span class="hljs-keyword">if</span> receivedVotes*<span class="hljs-number">2</span> &gt; <span class="hljs-built_in">len</span>(rf.peers) &#123;<br>                rf.convertToLeader()<br>            &#125;<br>            rf.mu.Unlock()<br>        &#125;(i)<br>    &#125;<br><br>    <span class="hljs-comment">// çœç•¥ã€‚ã€‚ã€‚ã€‚</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Bug-2"><a href="#Bug-2" class="headerlink" title="Bug 2"></a>Bug 2</h3><p>é‡åˆ°çš„ç¬¬äºŒä¸ª Bug æ˜¯ç”±äºä½¿ç”¨è´Ÿæ•°ç´¢å¼•å¯¼è‡´çš„è¿è¡Œæ—¶å´©æºƒï¼ŒæŠ¥é”™å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go">Test (<span class="hljs-number">2</span>A): initial election ...<br>  ... Passed --   <span class="hljs-number">3.1</span>  <span class="hljs-number">3</span>   <span class="hljs-number">56</span>   <span class="hljs-number">16914</span>    <span class="hljs-number">0</span><br>Test (<span class="hljs-number">2</span>A): election after network failure ...<br><span class="hljs-number">2022</span>/<span class="hljs-number">07</span>/<span class="hljs-number">30</span> <span class="hljs-number">18</span>:<span class="hljs-number">00</span>:<span class="hljs-number">11</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span><br><span class="hljs-built_in">panic</span>: runtime <span class="hljs-type">error</span>: index out of <span class="hljs-keyword">range</span> [<span class="hljs-number">-1</span>]<br><br>goroutine <span class="hljs-number">230</span> [running]:<br><span class="hljs-number">6.824</span>/raft.(*Raft).sendHearbeat.func1(<span class="hljs-number">0xc0000c81e0</span>, <span class="hljs-number">0x1</span>)<br>    /mnt/d/code/projects/distributed-system/<span class="hljs-number">6.824</span>/src/raft/raft.<span class="hljs-keyword">go</span>:<span class="hljs-number">613</span> +<span class="hljs-number">0x66f</span><br>created by <span class="hljs-number">6.824</span>/raft.(*Raft).sendHearbeat<br>    /mnt/d/code/projects/distributed-system/<span class="hljs-number">6.824</span>/src/raft/raft.<span class="hljs-keyword">go</span>:<span class="hljs-number">571</span> +<span class="hljs-number">0x64</span><br>exit status <span class="hljs-number">2</span><br>FAIL    <span class="hljs-number">6.824</span>/raft    <span class="hljs-number">3.157</span>s<br></code></pre></td></tr></table></figure><p>ç´¢å¼•è¶Šç•Œå…·ä½“å‘ç”Ÿåœ¨ä»£ç çš„613è¡Œï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> reply.XTerm == rf.log[reply.XIndex<span class="hljs-number">-1</span>].Term<br></code></pre></td></tr></table></figure><p>é€šè¿‡æ—¥å¿—å¯ä»¥çŸ¥é“ï¼Œå‘ç”Ÿé”™è¯¯æ—¶å¿ƒè·³ RPC å¾—åˆ°çš„è¿”å›æ¶ˆæ¯æ˜¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">Reply &#123;<br>    Term: <span class="hljs-number">0</span><br>    Success: <span class="hljs-literal">false</span><br>    XTerm: <span class="hljs-number">0</span><br>    XIndex: <span class="hljs-number">0</span><br>    XLen: <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ ¹æ® Term&#x3D;0 å’Œ Success&#x3D;false å¯ä»¥çœ‹å‡ºè·Ÿéšè€…ä¼¼ä¹æ²¡æœ‰æ‰§è¡Œä»»ä½•å¯¹å¿ƒè·³æ¶ˆæ¯çš„å¤„ç†å°±ç›´æ¥è¿”å›äº†ã€‚å¯ä»¥æ¨æ–­å‡ºï¼Œè·Ÿéšè€…åº”è¯¥æ˜¯å·²ç»â€æ­»æ‰â€œäº†ï¼Œå› æ­¤æ‰æ²¡æœ‰æ‰§è¡Œå¯¹å¿ƒè·³æ¶ˆæ¯çš„å¤„ç†ã€‚</p><p>è§£å†³æ–¹æ³•æ˜¯ï¼Œåœ¨å‘é€å¿ƒè·³çš„å‡½æ•°ä¸­å¢åŠ å¯¹è·Ÿéšè€…èŠ‚ç‚¹çŠ¶æ€çš„åˆ¤æ–­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> reply.Term &lt; rf.currentTerm &#123;<br>    rf.mu.Unlock()<br>    <span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åªè¦ <code>reply.Term</code> å°äº Leader çš„ä»»æœŸå·ï¼Œå°±å¯ä»¥çŸ¥é“è·Ÿéšè€…æ²¡æœ‰å¯¹ Leader å‘é€çš„å¿ƒè·³è¿›è¡Œå¤„ç†ï¼Œé‚£ä¹ˆè·Ÿéšè€…è‡ªç„¶å°±å·²ç»â€æ­»æ‰äº†â€œã€‚</p><h3 id="Bug-3"><a href="#Bug-3" class="headerlink" title="Bug 3"></a>Bug 3</h3><p>ç¬¬ä¸‰ä¸ªé‡åˆ°çš„é—®é¢˜æ˜¯ <code>TestRejoin2B</code> æµ‹è¯•å¤±è´¥ï¼Œå¤±è´¥çš„æ—¥å¿—å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs go">S0 sends hearbeat                                                                                                                                                           <br>S0 sends hearbeat to <span class="hljs-number">2</span>: &amp;&#123;Term:<span class="hljs-number">3</span>                                                                                                                                            <br>LeaderId:<span class="hljs-number">0</span> PrevLogIndex:<span class="hljs-number">3</span>                                                                                                                                                   <br>PrevLogTerm:<span class="hljs-number">3</span> Entries:[]                                                                                                                                                    <br>LeaderCommit:<span class="hljs-number">3</span>&#125;                                                                                                                                                             <br>S0 sends hearbeat to <span class="hljs-number">1</span>: &amp;&#123;Term:<span class="hljs-number">3</span>                                                                                                                                            <br>LeaderId:<span class="hljs-number">0</span> PrevLogIndex:<span class="hljs-number">2</span>                                                                                                                                                   <br>PrevLogTerm:<span class="hljs-number">2</span> Entries:[&#123;Command:<span class="hljs-number">104</span>                                                                                                                                         <br>Term:<span class="hljs-number">3</span> CommandIndex:<span class="hljs-number">3</span>&#125;]                                                                                                                                                     <br>LeaderCommit:<span class="hljs-number">3</span>&#125;                                                                                                                                                             <br>                                                                      S2 receives AppendEntriesRpc from                                                                     <br>                                                                      S0                                                                                                    <br>                                                                      S2 appends logs: []                                                                                   <br>                                                                      S2 changes commitIndex from <span class="hljs-number">2</span> to                                                                      <br>                                                                      <span class="hljs-number">3</span>                                                                                                     <br>                                                                      S2 reply AppendEntriesRpc from                                                                        <br>                                                                      S0: &amp;&#123;Term:<span class="hljs-number">3</span> Success:<span class="hljs-literal">true</span> XTerm:<span class="hljs-number">0</span>                                                                     <br>                                                                      XIndex:<span class="hljs-number">0</span> XLen:<span class="hljs-number">0</span>&#125;                                                                                      <br>                                                                      S2 applies msg&#123;Command:                                                                               <br>                                                                      %!s(<span class="hljs-type">int</span>=<span class="hljs-number">104</span>), Index: <span class="hljs-number">3</span>&#125;                                                                               <br>                                                                      S2 change lastApplied from <span class="hljs-number">2</span> to <span class="hljs-number">3</span>                                                                     <br>                                    S1 appends a log: &#123;Command:<span class="hljs-number">105</span>                                                                                                          <br>                                    Term:<span class="hljs-number">2</span> CommandIndex:<span class="hljs-number">3</span>&#125;                                                                                                                  <br>                                    S1 sends hearbeat                                                                                                                       <br>                                    S1 sends hearbeat to <span class="hljs-number">2</span>: &amp;&#123;Term:<span class="hljs-number">2</span>                                                                                                        <br>                                    LeaderId:<span class="hljs-number">1</span> PrevLogIndex:<span class="hljs-number">1</span>                                                                                                               <br>                                    PrevLogTerm:<span class="hljs-number">1</span>                                                                                                                           <br>                                    Entries:[&#123;Command:<span class="hljs-number">103</span> Term:<span class="hljs-number">2</span>                                                                                                            <br>                                    CommandIndex:<span class="hljs-number">2</span>&#125; &#123;Command:<span class="hljs-number">105</span>                                                                                                            <br>                                    Term:<span class="hljs-number">2</span> CommandIndex:<span class="hljs-number">3</span>&#125;]                                                                                                                 <br>                                    LeaderCommit:<span class="hljs-number">2</span>&#125;                                                                                                                         <br>                                                                      S2 receives AppendEntriesRpc from                                                                     <br>                                                                      S1                                                                                                    <br>                                                                      S2 reply AppendEntriesRpc from                                                                        <br>                                                                      S1: &amp;Reply&#123;Term: <span class="hljs-number">3</span>, Success:                                                                          <br>                                                                      <span class="hljs-literal">false</span>&#125;                                                                                                <br>                                    S1 becomes Follower                                                                                                                     <br>                                    S1 changes term from <span class="hljs-number">3</span> to <span class="hljs-number">3</span>                                                                                                             <br>                                    S1 sends hearbeat to <span class="hljs-number">0</span>: &amp;&#123;Term:<span class="hljs-number">3</span>                                                                                                        <br>                                    LeaderId:<span class="hljs-number">1</span> PrevLogIndex:<span class="hljs-number">2</span>                                                                                                               <br>                                    PrevLogTerm:<span class="hljs-number">2</span>                                                                                                                           <br>                                    Entries:[&#123;Command:<span class="hljs-number">105</span> Term:<span class="hljs-number">2</span>                                                                                                            <br>                                    CommandIndex:<span class="hljs-number">3</span>&#125;] LeaderCommit:<span class="hljs-number">2</span>&#125;                                                                                                        <br>S0 receives AppendEntriesRpc from                                                                                                                                           <br>S1                                                                                                                                                                          <br>S0 becomes Follower                                                                                                                                                         <br>S0 appends logs: [&#123;Command:<span class="hljs-number">105</span>                                                                                                                                              <br>Term:<span class="hljs-number">2</span> CommandIndex:<span class="hljs-number">3</span>&#125;]                                                                                                                                                     <br>S0 reply AppendEntriesRpc from S1:                                                                                                                                          <br>&amp;&#123;Term:<span class="hljs-number">3</span> Success:<span class="hljs-literal">true</span> XTerm:<span class="hljs-number">0</span>                                                                                                                                               <br>XIndex:<span class="hljs-number">0</span> XLen:<span class="hljs-number">0</span>&#125;                  <br></code></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„æ—¥å¿—ä¸­ï¼ŒS0 æ˜¯ Leader å¹¶ä¸”å’Œ S2 å¯ä»¥æ­£å¸¸é€šä¿¡ï¼ŒS1 è¢«å›°åœ¨ä¸€ä¸ªå•ç‹¬çš„ç½‘ç»œåˆ†åŒºä¸­ï¼Œå¹¶ä¸”è‡ªè®¤ä¸ºè‡ªå·±æ˜¯ Leaderã€‚</p><p>å½“ S1 æ¢å¤æ­£å¸¸åï¼ŒS1 å‘ S2 å‘é€ AppendEntriesï¼Œç„¶åæ”¶åˆ°äº†æ‹’ç»å›å¤ï¼Œå¹¶æ ¹æ®å›å¤ä¸­çš„ä»»æœŸå·é‡ç½®è‡ªå·±çš„ä»»æœŸå·ï¼Œå°†è‡ªå·±è½¬åŒ–ä¸ºè·Ÿéšè€…ã€‚åˆ°è¿™é‡Œä¸€åˆ‡éƒ½è¿˜æ­£å¸¸ï¼Œä½†æ˜¯æ¥ç€ S1 ç»§ç»­å‘ S0 å‘é€äº† AppendEntriesï¼Œå¯¼è‡´ S0 é€€åŒ–æˆäº†è·Ÿéšè€…ï¼Œå¹¶ä¸”è¢«è¿½åŠ äº†ä¸€æ¡æ¥è‡ªè·Ÿéšè€…çš„æ—¥å¿—ï¼Œä»è€Œå¯¼è‡´é”™è¯¯ã€‚</p><p>é”™è¯¯åŸå› å¾ˆæ˜æ˜¾ï¼ŒS1 åœ¨å‘é€ AppendEntries ä¹‹å‰æ²¡æœ‰åˆ¤æ–­è‡ªå·±æ˜¯å¦è¿˜æ˜¯ Leaderï¼Œå› æ­¤åœ¨ S1 è½¬å˜ä¸ºè·Ÿéšè€…ä¹‹åï¼ŒS1 ä»ç„¶å‘ S0 å‘é€äº†RPCæ¶ˆæ¯ã€‚</p><p>é‚£ä¹ˆï¼Œåªéœ€è¦åœ¨å‘é€ AppendEntries ä¹‹å‰åŠ ä¸€ä¸ªå°çš„æ¡ä»¶åˆ¤æ–­å³å¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å·²ç»ä¸æ˜¯é¢†å¯¼äººäº†ï¼Œç›´æ¥è¿”å›</span><br><span class="hljs-keyword">if</span> rf.role != LEADER &#123;<br>    rf.mu.Unlock()<br>    <span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Bug-4"><a href="#Bug-4" class="headerlink" title="Bug 4"></a>Bug 4</h3><p>æœ€åé‡åˆ°çš„ Bug æ˜¯æ²¡æœ‰é€šè¿‡ <code>TestFailNoAgree2B</code> æµ‹è¯•ï¼Œé”™è¯¯æ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><code class="hljs go">S0 starts running                                                                                                                                                           <br>                                    S1 starts running                                                                                                                       <br>                                                                      S2 starts running                                                                                     <br>                                                                                                        S3 starts running                                                   <br>                                                                                                                                          S4 starts running                 <br>S0 starts election                                                                                                                                                          <br>S0 becomes Candidate                                                                                                                                                        <br>S0 change term from <span class="hljs-number">0</span> to <span class="hljs-number">1</span>                                                                                                                                                  <br>S0 votes <span class="hljs-keyword">for</span> S0                                                                                                                                                             <br>                                    S1 receives VoteRequestRpc from                                                                                                         <br>                                    S0                                                                                                                                      <br>                                    S1 changes term from <span class="hljs-number">0</span> to <span class="hljs-number">1</span>                                                                                                             <br>                                    S1 votes <span class="hljs-keyword">for</span> S0                                                                                                                         <br>                                                                      S2 receives VoteRequestRpc from                                                                       <br>                                                                      S0                                                                                                    <br>                                                                      S2 changes term from <span class="hljs-number">0</span> to <span class="hljs-number">1</span>                                                                           <br>                                                                      S2 votes <span class="hljs-keyword">for</span> S0                                                                                       <br>S0 becomes Leader                                                                                                                                                           <br>S0 sends hearbeat                                                                                                                                                           <br>S0 sends hearbeat to S4: &amp;&#123;Term:<span class="hljs-number">1</span>                                                                                                                                           <br>LeaderId:<span class="hljs-number">0</span> PrevLogIndex:<span class="hljs-number">0</span>                                                                                                                                                   <br>PrevLogTerm:<span class="hljs-number">0</span> Entries:[]                                                                                                                                                    <br>LeaderCommit:<span class="hljs-number">0</span>&#125;                                                                                                                                                             <br>                                                                                                                                          S4 receives AppendEntriesRpc from <br>                                                                                                                                          S0                                <br>                                                                                                                                          S4 changes term from <span class="hljs-number">0</span> to <span class="hljs-number">1</span>       <br>                                                                                                                                          S4 appends logs: []               <br>                                                                                                                                          S4 reply AppendEntriesRpc from S0:<br>                                                                                                                                          &amp;&#123;Term:<span class="hljs-number">1</span> Success:<span class="hljs-literal">true</span> XTerm:<span class="hljs-number">0</span>     <br>                                                                                                                                          XIndex:<span class="hljs-number">0</span> XLen:<span class="hljs-number">0</span>&#125;                  <br>S0 sends hearbeat to S1: &amp;&#123;Term:<span class="hljs-number">1</span>                                                                                                                                           <br>LeaderId:<span class="hljs-number">0</span> PrevLogIndex:<span class="hljs-number">0</span>                                                                                                                                                   <br>PrevLogTerm:<span class="hljs-number">0</span> Entries:[]                                                                                                                                                    <br>LeaderCommit:<span class="hljs-number">0</span>&#125;                                                                                                                                                             <br>                                    S1 receives AppendEntriesRpc from                                                                                                       <br>                                    S0                                                                                                                                      <br>                                    S1 appends logs: []                                                                                                                     <br>                                    S1 reply AppendEntriesRpc from                                                                                                          <br>                                    S0: &amp;&#123;Term:<span class="hljs-number">1</span> Success:<span class="hljs-literal">true</span> XTerm:<span class="hljs-number">0</span>                                                                                                       <br>                                    XIndex:<span class="hljs-number">0</span> XLen:<span class="hljs-number">0</span>&#125;                                                                                                                        <br>S0 sends hearbeat to S3: &amp;&#123;Term:<span class="hljs-number">1</span>                                                                                                                                           <br>LeaderId:<span class="hljs-number">0</span> PrevLogIndex:<span class="hljs-number">0</span>                                                                                                                                                   <br>PrevLogTerm:<span class="hljs-number">0</span> Entries:[]                                                                                                                                                    <br>LeaderCommit:<span class="hljs-number">0</span>&#125;                                                                                                                                                             <br>                                                                                                        S3 starts election                                                  <br>                                                                                                        S3 becomes Candidate                                                <br>                                                                                                        S3 change term from <span class="hljs-number">0</span> to <span class="hljs-number">1</span>                                          <br>                                                                                                        S3 votes <span class="hljs-keyword">for</span> S3                                                     <br>S0 appends a log: &#123;Command:<span class="hljs-number">10</span>                                                                                                                                               <br>Term:<span class="hljs-number">1</span> CommandIndex:<span class="hljs-number">1</span>&#125;                                                                                                                                                      <br>S0 sends hearbeat                                                                                                                                                           <br>S0 sends hearbeat to S4: &amp;&#123;Term:<span class="hljs-number">1</span>                                                                                                                                           <br>LeaderId:<span class="hljs-number">0</span> PrevLogIndex:<span class="hljs-number">0</span>                                                                                                                                                   <br>PrevLogTerm:<span class="hljs-number">0</span> Entries:[&#123;Command:<span class="hljs-number">10</span>                                                                                                                                          <br>Term:<span class="hljs-number">1</span> CommandIndex:<span class="hljs-number">1</span>&#125;]                                                                                                                                                     <br>LeaderCommit:<span class="hljs-number">0</span>&#125;                                                                                                                                                             <br>                                                                                                                                          S4 receives AppendEntriesRpc from <br>                                                                                                                                          S0                                <br>                                                                                                                                          S4 appends logs: [&#123;Command:<span class="hljs-number">10</span>     <br>                                                                                                                                          Term:<span class="hljs-number">1</span> CommandIndex:<span class="hljs-number">1</span>&#125;]           <br>                                                                                                                                          S4 reply AppendEntriesRpc from S0:<br>                                                                                                                                          &amp;&#123;Term:<span class="hljs-number">1</span> Success:<span class="hljs-literal">true</span> XTerm:<span class="hljs-number">0</span>     <br>                                                                                                                                          XIndex:<span class="hljs-number">0</span> XLen:<span class="hljs-number">0</span>&#125;                  <br>S0 sends hearbeat to S2: &amp;&#123;Term:<span class="hljs-number">1</span>                                                                                                                                           <br>LeaderId:<span class="hljs-number">0</span> PrevLogIndex:<span class="hljs-number">0</span>                                                                                                                                                   <br>PrevLogTerm:<span class="hljs-number">0</span> Entries:[]                                                                                                                                                    <br>LeaderCommit:<span class="hljs-number">0</span>&#125;                                                                                                                                                             <br>                                                                      S2 receives AppendEntriesRpc from                                                                     <br>                                                                      S0                                                                                                    <br>                                                                      S2 appends logs: []                                                                                   <br>                                                                      S2 reply AppendEntriesRpc from                                                                        <br>                                                                      S0: &amp;&#123;Term:<span class="hljs-number">1</span> Success:<span class="hljs-literal">true</span> XTerm:<span class="hljs-number">0</span>                                                                     <br>                                                                      XIndex:<span class="hljs-number">0</span> XLen:<span class="hljs-number">0</span>&#125;                                                                                      <br>S0 receives VoteRequestRpc from S3                                                                                                                                          <br>                                    S1 receives VoteRequestRpc from                                                                                                         <br>                                    S3                                                                                                                                      <br>                                                                      S2 receives VoteRequestRpc from                                                                       <br>                                                                      S3                                                                                                    <br>                                                                                                                                          S4 receives VoteRequestRpc from S3<br>S0 sends hearbeat to S1: &amp;&#123;Term:<span class="hljs-number">1</span>                                                                                                                                           <br>LeaderId:<span class="hljs-number">0</span> PrevLogIndex:<span class="hljs-number">0</span>                                                                                                                                                   <br>PrevLogTerm:<span class="hljs-number">0</span> Entries:[&#123;Command:<span class="hljs-number">10</span>                                                                                                                                          <br>Term:<span class="hljs-number">1</span> CommandIndex:<span class="hljs-number">1</span>&#125;]                                                                                                                                                     <br>LeaderCommit:<span class="hljs-number">0</span>&#125;                                                                                                                                                             <br>                                    S1 receives AppendEntriesRpc from                                                                                                       <br>                                    S0                                                                                                                                      <br>                                    S1 appends logs: [&#123;Command:<span class="hljs-number">10</span>                                                                                                           <br>                                    Term:<span class="hljs-number">1</span> CommandIndex:<span class="hljs-number">1</span>&#125;]                                                                                                                 <br>                                    S1 reply AppendEntriesRpc from                                                                                                          <br>                                    S0: &amp;&#123;Term:<span class="hljs-number">1</span> Success:<span class="hljs-literal">true</span> XTerm:<span class="hljs-number">0</span>                                                                                                       <br>                                    XIndex:<span class="hljs-number">0</span> XLen:<span class="hljs-number">0</span>&#125;                                                                                                                        <br>S0 changes commitIndex from <span class="hljs-number">0</span> to <span class="hljs-number">1</span>                                                                                                                                          <br>S0 sends hearbeat to S2: &amp;&#123;Term:<span class="hljs-number">1</span>                                                                                                                                           <br>LeaderId:<span class="hljs-number">0</span> PrevLogIndex:<span class="hljs-number">0</span>                                                                                                                                                   <br>PrevLogTerm:<span class="hljs-number">0</span> Entries:[&#123;Command:<span class="hljs-number">10</span>                                                                                                                                          <br>Term:<span class="hljs-number">1</span> CommandIndex:<span class="hljs-number">1</span>&#125;]                                                                                                                                                     <br>LeaderCommit:<span class="hljs-number">1</span>&#125;                                                                                                                                                             <br>                                                                      S2 receives AppendEntriesRpc from                                                                     <br>                                                                      S0                                                                                                    <br>                                                                      S2 appends logs: [&#123;Command:<span class="hljs-number">10</span>                                                                         <br>                                                                      Term:<span class="hljs-number">1</span> CommandIndex:<span class="hljs-number">1</span>&#125;]                                                                               <br>                                                                      S2 changes commitIndex from <span class="hljs-number">0</span> to                                                                      <br>                                                                      <span class="hljs-number">1</span>                                                                                                     <br>                                                                      S2 reply AppendEntriesRpc from                                                                        <br>                                                                      S0: &amp;&#123;Term:<span class="hljs-number">1</span> Success:<span class="hljs-literal">true</span> XTerm:<span class="hljs-number">0</span>                                                                     <br>                                                                      XIndex:<span class="hljs-number">0</span> XLen:<span class="hljs-number">0</span>&#125;                                                                                      <br>S0 sends hearbeat to S3: &amp;&#123;Term:<span class="hljs-number">1</span>                                                                                                                                           <br>LeaderId:<span class="hljs-number">0</span> PrevLogIndex:<span class="hljs-number">0</span>                                                                                                                                                   <br>PrevLogTerm:<span class="hljs-number">0</span> Entries:[&#123;Command:<span class="hljs-number">10</span>                                                                                                                                          <br>Term:<span class="hljs-number">1</span> CommandIndex:<span class="hljs-number">1</span>&#125;]                                                                                                                                                     <br>LeaderCommit:<span class="hljs-number">1</span>&#125;                                                                                                                                                             <br>                                                                                                        S3 receives AppendEntriesRpc from                                   <br>                                                                                                        S0                                                                  <br>                                                                                                        S3 becomes Follower                                                 <br>                                                                                                        S3 appends logs: [&#123;Command:<span class="hljs-number">10</span>                                       <br>                                                                                                        Term:<span class="hljs-number">1</span> CommandIndex:<span class="hljs-number">1</span>&#125;]                                             <br>                                                                                                        S3 changes commitIndex from <span class="hljs-number">0</span> to                                    <br>                                                                                                        <span class="hljs-number">1</span>                                                                   <br>                                                                                                        S3 reply AppendEntriesRpc from                                      <br>                                                                                                        S0: &amp;&#123;Term:<span class="hljs-number">1</span> Success:<span class="hljs-literal">true</span> XTerm:<span class="hljs-number">0</span>                                   <br>                                                                                                        XIndex:<span class="hljs-number">0</span> XLen:<span class="hljs-number">0</span>&#125;                                                    <br>                                                                                                        S3 receives AppendEntriesRpc from                                   <br>                                                                                                        S0                                                                  <br>                                                                                                        S3 appends logs: []                                                 <br>                                                                                                        S3 reply AppendEntriesRpc from                                      <br>                                                                                                        S0: &amp;&#123;Term:<span class="hljs-number">1</span> Success:<span class="hljs-literal">true</span> XTerm:<span class="hljs-number">0</span>                                   <br>                                                                                                        XIndex:<span class="hljs-number">0</span> XLen:<span class="hljs-number">0</span>&#125;                                                    <br>                                                                      S2 applies msg&#123;Command:                                                                               <br>                                                                      %!s(<span class="hljs-type">int</span>=<span class="hljs-number">10</span>), Index: <span class="hljs-number">1</span>&#125;                                                                                <br>                                                                      S2 change lastApplied from <span class="hljs-number">0</span> to <span class="hljs-number">1</span>                                                                     <br>S0 applies msg&#123;Command:                                                                                                                                                     <br>%!s(<span class="hljs-type">int</span>=<span class="hljs-number">10</span>), Index: <span class="hljs-number">1</span>&#125;                                                                                                                                                      <br>S0 change lastApplied from <span class="hljs-number">0</span> to <span class="hljs-number">1</span>                                                                                                                                           <br><br><br><br><span class="hljs-number">6.824</span>/raft.(*Raft).applyMsgToStateMachine(<span class="hljs-number">0xc0000e02d0</span>)<br><br>FAIL    <span class="hljs-number">6.824</span>/raft      <span class="hljs-number">0.767</span>s<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼ŒS0 æ”¶åˆ°äº† S1 å’Œ S2 çš„æŠ•ç¥¨ï¼Œåœ¨ç¬¬20è¡Œæˆä¸ºäº† Leaderã€‚ä¹‹å S0 åœ¨43è¡Œå‘é€é™„åŠ æ—¥å¿—ç»™ S3ï¼Œé™„åŠ æ—¥å¿—çš„è¯·æ±‚å†…å®¹ä¸ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">S0 sends hearbeat to S1: &amp;&#123;Term:<span class="hljs-number">1</span> LeaderId:<span class="hljs-number">0</span> PrevLogIndex:<span class="hljs-number">0</span> <br>PrevLogTerm:<span class="hljs-number">0</span> Entries:[] LeaderCommit:<span class="hljs-number">0</span>&#125; <br></code></pre></td></tr></table></figure><p>ä¹‹åï¼ŒS0åœ¨51è¡Œæ”¶åˆ°äº†å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¹¶æ·»åŠ äº†ä¸€æ¡æ—¥å¿—ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">S0 appends a log: &#123;Command:<span class="hljs-number">10</span> Term:<span class="hljs-number">1</span> CommandIndex:<span class="hljs-number">1</span>&#125;    <br></code></pre></td></tr></table></figure><p>æ¥ç€ï¼ŒS0 åœ¨ç¬¬109è¡Œå°†è¿½åŠ çš„æ—¥å¿—å‘é€ç»™ S3ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go">S0 sends hearbeat to S3: &amp;&#123;<br>    Term:<span class="hljs-number">1</span> LeaderId:<span class="hljs-number">0</span> PrevLogIndex:<span class="hljs-number">0</span>                                                                                                                                                   <br>    PrevLogTerm:<span class="hljs-number">0</span> Entries:[&#123;Command:<span class="hljs-number">10</span> Term:<span class="hljs-number">1</span> CommandIndex:<span class="hljs-number">1</span>&#125;]                                                                                                                                                     <br>Â Â Â Â LeaderCommit:<span class="hljs-number">1</span>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯ S3 åœ¨ç¬¬118è¡Œé¦–å…ˆæ”¶åˆ°äº†ç¬¬äºŒæ¡é™„åŠ æ—¥å¿—RPCï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go">S3 receives AppendEntriesRpc from S0                                                                  <br>S3 becomes Follower                                                 <br>S3 appends logs: [&#123;Command:<span class="hljs-number">10</span> Term:<span class="hljs-number">1</span> CommandIndex:<span class="hljs-number">1</span>&#125;]                                             <br>S3 changes commitIndex from <span class="hljs-number">0</span> to <span class="hljs-number">1</span> <br></code></pre></td></tr></table></figure><p>S3 åœ¨125è¡Œæ‰æ”¶åˆ°ç¬¬ä¸€æ¡é™„åŠ æ—¥å¿—RPCï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">S3 receives AppendEntriesRpc from S0                                                                                                       <br>S3 appends logs: []<br></code></pre></td></tr></table></figure><p>ç”±äºRPCè¯·æ±‚çš„ä¹±åºåˆ°è¾¾ï¼ŒS3 é¦–å…ˆä¼šæ”¶åˆ°ç¬¬äºŒæ¡é™„åŠ æ—¥å¿—RPCï¼Œå®ƒä¼šè¿½åŠ ä¸€æ¡æ—¥å¿—ã€‚ä¹‹åæ‰ä¼šæ”¶åˆ°ä¸€æ¡é™„åŠ æ—¥å¿—RPCï¼Œè¿™è¿™ä¸ªRPCçš„ Entries æ˜¯ç©ºçš„ï¼Œè¿™å›å¯¼è‡´ S3 è¦†ç›–æ‰ä¹‹å‰è¿½åŠ çš„æ—¥å¿—ã€‚</p><p>ä½†æ˜¯ S3 æ­¤æ—¶å·²ç»å°† CommitIndex ä¿®æ”¹ä¸º1ï¼Œä¹‹å S3 ä¼šåº”ç”¨ ComminIndex ä½ç½®çš„æ—¥å¿—åˆ°çŠ¶æ€æœºä¸­ï¼Œä½†æ˜¯å¯¹åº”ä½ç½®çš„æ—¥å¿—æ˜¯ç©ºçš„ï¼Œè¿™å°±å¯¼è‡´äº†é”™è¯¯ã€‚</p><p>å¾ˆæ˜æ˜¾ï¼Œåœ¨æ”¶åˆ°ç¬¬ä¸€æ¡é™„åŠ æ—¥å¿—RPCåï¼Œæˆ‘ä»¬ä¸èƒ½è¦†ç›–æ‰ä¹‹å‰çš„è¿½åŠ çš„æ—¥å¿—ï¼Œå› æ­¤åœ¨è¿½åŠ æ—¥å¿—çš„å®ç°ä¸­åº”è¯¥åŠ ä¸€äº›åˆ¤æ–­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go">logIndex, entriesIndex := args.PrevLogIndex+<span class="hljs-number">1</span>, <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> logIndex &lt;= rf.lastLogIndex &amp;&amp; entriesIndex &lt; <span class="hljs-built_in">len</span>(args.Entries) &amp;&amp; rf.log[logIndex<span class="hljs-number">-1</span>] == args.Entries[entriesIndex] &#123;<br>    logIndex++<br>    entriesIndex++<br>&#125;<br><span class="hljs-keyword">if</span> !(entriesIndex == <span class="hljs-built_in">len</span>(args.Entries) &amp;&amp; logIndex &lt;= rf.lastLogIndex &amp;&amp; rf.log[logIndex<span class="hljs-number">-1</span>].Term == args.Term) &#123;<br>    rf.log = <span class="hljs-built_in">append</span>(rf.log[:logIndex<span class="hljs-number">-1</span>], args.Entries[entriesIndex:]...)<br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ‰«æå‘é€è¿‡æ¥çš„æ—¥å¿—å’Œæœ¬åœ°çš„æ—¥å¿—ï¼Œæ‰¾åˆ°ç¬¬ä¸€æ¡ä¸åŒ¹é…çš„æ—¥å¿—çš„ä½ç½®Xã€‚åœ¨ä¹‹å‰çš„å®ç°ä¸­ï¼Œæ²¡æœ‰ç¬¬6è¡Œçš„åˆ¤æ–­ï¼Œç›´æ¥æ‰§è¡Œç¬¬7è¡Œçš„è¿½åŠ æ—¥å¿—æ“ä½œï¼Œè¿™å¯èƒ½å¯¼è‡´å·²æœ‰çš„æ—¥å¿—è¢«è¦†ç›–ã€‚</p><p>å¦‚æœå‰©ä¸‹çš„éœ€è¦è¿½åŠ çš„æ—¥å¿—ä¸ºç©ºï¼Œå¹¶ä¸”Xå¯¹åº”çš„ä½ç½®å­˜åœ¨æ—¥å¿—ï¼Œå¦‚æœXå¯¹åº”çš„æ—¥å¿—çš„ä»»æœŸä¸å½“å‰çš„ Leader çš„ä»»æœŸå·ç›¸ç­‰ï¼Œè¯´æ˜Xå¯¹åº”çš„æ—¥å¿—æ˜¯å½“å‰Leaderå‘é€è¿‡æ¥çš„ï¼Œé‚£ä¹ˆå°±ä¸åº”è¯¥è¦†ç›–æ‰å®ƒã€‚</p><p>é™¤äº†ä¸Šè¿°æƒ…å†µï¼Œéƒ½å¯ä»¥ç›´æ¥æ‰§è¡Œ <code>rf.log = append(rf.log[:logIndex-1], args.Entries[entriesIndex:]...)</code> æŠŠå‰©ä¸‹çš„æ—¥å¿—å¤åˆ¶è¿‡å»ã€‚</p><p>åœ¨è§£å†³å®Œæ‰€æœ‰ Bug åå¹¶å‘è·‘500æ¬¡æµ‹è¯•ï¼Œå…¨éƒ¨é¡ºåˆ©é€šè¿‡ï¼š</p><img src="/2022/07/31/Raft-3/Raft-%E5%9B%BE5.png" class=""><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><p><a href="https://pdos.csail.mit.edu/6.824/">MIT 6.824</a></p></li><li><p><a href="https://raft.github.io/raft.pdf">Raft paper</a></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>distributed system</category>
      
    </categories>
    
    
    <tags>
      
      <tag>distributed</tag>
      
      <tag>consistency</tag>
      
      <tag>paper</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Raftï¼ˆäºŒï¼‰ï¼šLeaderé€‰ä¸¾</title>
    <link href="/2022/07/25/Raft-2/"/>
    <url>/2022/07/25/Raft-2/</url>
    
    <content type="html"><![CDATA[<h2 id="è„‘è£‚"><a href="#è„‘è£‚" class="headerlink" title="è„‘è£‚"></a>è„‘è£‚</h2><p>åœ¨å¤šå‰¯æœ¬çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œé€šå¸¸ä¼šå­˜åœ¨ä¸€ä¸ª Primary èŠ‚ç‚¹ï¼Œç”±å®ƒæ¥å†³å®šæ•´ä¸ªç³»ç»Ÿçš„å†³ç­–ï¼Œè¿™æ ·å¯ä»¥ç®€åŒ–ä¸€è‡´æ€§çš„å®ç°ï¼Œå› ä¸º Priamry åªéœ€è¦å¼ºè¿«å…¶ä»–èŠ‚ç‚¹ä¸å®ƒä¿æŒä¸€è‡´å³å¯ã€‚</p><p>ä½†æ˜¯ Primary èŠ‚ç‚¹æœ¬èº«ä¼šå‘ç”Ÿæ•…éšœï¼Œä¹‹åæˆ‘ä»¬éœ€è¦é€‰å‡ºä¸€ä¸ªæ–°çš„ Primary èŠ‚ç‚¹ï¼Œè¿™æ ·å°±å¯èƒ½ä¼šé¢ä¸´<strong>è„‘è£‚</strong>çš„åœºæ™¯ã€‚</p><p>ç°åœ¨æˆ‘ä»¬ä»¥ VMware FT ä¸ºä¾‹ï¼Œæ¥è¯´æ˜ä¸ºä»€ä¹ˆä¼šå‡ºç°è„‘è£‚ã€‚å‡è®¾åœ¨ä¸€ä¸ªç½‘ç»œä¸­æœ‰ä¸¤å°æœåŠ¡å™¨ S1 å’Œ S2 ï¼Œè¿™ä¸¤å°æœåŠ¡å™¨æ˜¯ Test-and-Set æœåŠ¡çš„å‰¯æœ¬ï¼Œè¿™ä¸ªç½‘ç»œä¸­è¿˜æœ‰ä¸¤ä¸ªå®¢æˆ·ç«¯ C1 å’Œ C2 ï¼Œç°åœ¨å®ƒä»¬éœ€è¦é€šè¿‡ Test-and-Set æœåŠ¡ç¡®å®šè°æ˜¯ Primaryã€‚</p><img src="/2022/07/25/Raft-2/Raft-%E5%9B%BE1.png" class=""><p>åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼ŒTest-and-Set æœåŠ¡ä¸­çš„æ•°æ®è®°å½•ä»0å¼€å§‹ã€‚ä¸€ä¸ªå®¢æˆ·ç«¯ä¼šå‘ä¸¤å°æœåŠ¡å™¨å‘é€ Test-and-Set æŒ‡ä»¤ï¼Œè¿™ä¸ªæŒ‡ä»¤ä¼šæŠŠä¸¤å°æœåŠ¡å™¨ä¸­çš„æ•°æ®è®°å½•è®¾ç½®ä¸º1ï¼Œä¹‹åè¿”å› Success å“åº”ã€‚å¦‚æœæœåŠ¡å™¨ä¸­çš„æ•°æ®è®°å½•å·²ç»è¢«è®¾ç½®ï¼Œé‚£ä¹ˆå¦ä¸€ä¸ªå®¢æˆ·ç«¯å‘é€ Test-and-Set æŒ‡ä»¤åï¼Œåˆ™ä¼šæ”¶åˆ°ä¸€ä¸ª Fail å“åº”ã€‚å› æ­¤ï¼Œå…¶æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªäº’æ–¥é”æœåŠ¡ã€‚</p><p>æˆ‘ä»¬å¸Œæœ› Test-and-Set å…·æœ‰å®¹é”™ç‰¹æ€§ï¼Œå½“ä¸€ä¸ªå®¢æˆ·ç«¯åªèƒ½ä¸ä¸€ä¸ª Test-and-Set æœåŠ¡å™¨é€šä¿¡æ—¶ï¼Œä¹Ÿå¯ä»¥æ­£å¸¸å·¥ä½œã€‚ä¾‹å¦‚ C1 å¯ä»¥å’Œ S1 é€šä¿¡ï¼Œä½†ä¸èƒ½å’Œ S2 é€šä¿¡ï¼ŒC1 ä¹Ÿå¯ä»¥æ­£å¸¸å·¥ä½œã€‚åä¹‹ï¼Œå¦‚æœ C1 å¿…é¡»å’Œ S2 é€šä¿¡ï¼Œè€Œæ°å¥½ C1 å’Œ S2 ä¹‹é—´çš„ç½‘ç»œå‡ºç°äº†æ•…éšœï¼Œè¿™å°±å¯¼è‡´ C1 ä¸ºäº†ç­‰å¾… S2 çš„å“åº”å°†æ°¸è¿œæ— æ³•ç»§ç»­å·¥ä½œï¼Œè¿™å°±å¤±å»äº†å¤šå‰¯æœ¬çš„æ„ä¹‰ã€‚</p><p>å› æ­¤ä¸ºäº†å…·å¤‡å®¹é”™ç‰¹æ€§ï¼Œæˆ‘ä»¬å…è®¸ä¸€ä¸ªå®¢æˆ·ç«¯åªä¸å®ƒèƒ½è¿é€šçš„æœåŠ¡å™¨äº¤äº’ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœå‘ç”Ÿäº†ç½‘ç»œåˆ†åŒºï¼Œä¾‹å¦‚ C1 åªèƒ½ä¸ S1 é€šä¿¡ï¼ŒC2 åªèƒ½ä¸ S2 é€šä¿¡ï¼Œåˆ™ä¼šå¯¼è‡´è„‘è£‚ï¼š</p><img src="/2022/07/25/Raft-2/Raft-%E5%9B%BE2.png" class=""><p>C1 å‘é€ Test-and-Set æŒ‡ä»¤ç»™ S1ï¼ŒS1å°†è‡ªå·±çš„æ•°æ®è®°å½•è®¾ç½®ä¸º1ï¼Œå¹¶è¿”å› Success ç»™ C1ã€‚åŒæ—¶ï¼ŒC2 å‘é€ Test-and-Set æŒ‡ä»¤ç»™ S2ï¼ŒS2 å°†è‡ªå·±çš„æ•°æ®è®°å½•ä¸º1ï¼Œå¹¶è¿”å› Success ç»™ C2ã€‚å› æ­¤ï¼ŒC1 å’Œ C2 éƒ½è·å¾—äº† Success å“åº”ï¼ŒC1 å’Œ C2 éƒ½ä¼šè®¤ä¸ºè‡ªå·±æ˜¯ Primaryï¼Œè€Œä¸éœ€è¦ä¸å¦ä¸€ä¸ªè™šæ‹Ÿæœºè¿›è¡Œåè°ƒï¼Œä»è€Œè¿›å…¥é”™è¯¯çš„åœºæ™¯ã€‚</p><p>å› æ­¤ï¼Œåœ¨è¿™ç§æœ‰ä¸¤ä¸ªå‰¯æœ¬çš„æœåŠ¡ä¸­ï¼Œæˆ‘ä»¬ä¼¼ä¹åªæœ‰ä¸¤ç§é€‰æ‹©ï¼šè¦ä¹ˆç­‰å¾…ä¸¤ä¸ªæœåŠ¡å™¨å“åº”ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±æ²¡æœ‰å®¹é”™èƒ½åŠ›ï¼›è¦ä¹ˆåªç­‰å¾…ä¸€ä¸ªæœåŠ¡å™¨å“åº”ï¼Œé‚£ä¹ˆå°±ä¼šè¿›å…¥é”™è¯¯çš„åœºæ™¯ï¼Œè€Œè¿™ç§é”™è¯¯çš„åœºæ™¯ï¼Œé€šå¸¸è¢«ç§°ä¸ºè„‘è£‚ã€‚</p><p>åœ¨ä¸Šä¸–çºªå…«åå¹´ä»£ï¼Œå¯¹äºè„‘è£‚å¹¶æ²¡æœ‰ä»€ä¹ˆå¥½çš„è§£å†³åŠæ³•ã€‚ä½†æ˜¯ï¼Œå½“æ—¶åˆçš„ç¡®æœ‰å¤šå‰¯æœ¬ç³»ç»Ÿçš„éœ€è¦ï¼Œä¸ºäº†è§£å†³è„‘è£‚é—®é¢˜ï¼Œæœ‰ä¸¤ç§æŠ€æœ¯ï¼š</p><ul><li><p>æ„å»ºä¸å¯èƒ½å‡ºç°æ•…éšœçš„ç½‘ç»œã€‚</p></li><li><p>äººå·¥è§£å†³é—®é¢˜ï¼Œå½“ä¸€ä¸ªæœåŠ¡å™¨å‡ºç°äº†æ•…éšœï¼Œè®©è¿ç»´äººå‘˜å»æ£€æŸ¥è¿™å°æœåŠ¡å™¨æ˜¯å¦çœŸçš„å…³æœºäº†ï¼Œè¿˜æ˜¯å‡ºç°äº†ç½‘ç»œæ–¹é¢çš„æ•…éšœã€‚</p></li></ul><h2 id="è¿‡åŠæŠ•ç¥¨"><a href="#è¿‡åŠæŠ•ç¥¨" class="headerlink" title="è¿‡åŠæŠ•ç¥¨"></a>è¿‡åŠæŠ•ç¥¨</h2><p>å½“ç½‘ç»œå‡ºç°æ•…éšœï¼Œå°†ç½‘ç»œåˆ†å‰²æˆä¸¤åŠï¼Œç½‘ç»œçš„ä¸¤è¾¹ç‹¬è‡ªè¿è¡Œï¼Œä¸”ä¸èƒ½è®¿é—®å¯¹æ–¹ï¼Œè¿™é€šå¸¸è¢«ç§°ä¸ºç½‘ç»œåˆ†åŒºã€‚è€Œç½‘ç»œåˆ†åŒºå¯èƒ½ä¼šå¯¼è‡´è¿›å…¥ä¸Šé¢æåˆ°çš„è„‘è£‚åœºæ™¯ï¼Œä»è€Œå¯¼è‡´å¤šå‰¯æœ¬æœåŠ¡å‡ºç°ä¸ä¸€è‡´ã€‚</p><p>éšç€æŠ€æœ¯çš„å‘å±•ï¼Œäººä»¬å‘ç°å³ä½¿å‡ºç°åˆ†åŒºï¼Œä¹Ÿèƒ½æ­£ç¡®åœ°å®ç°èƒ½å¤Ÿè‡ªåŠ¨å®Œæˆæ•…éšœåˆ‡æ¢çš„ç³»ç»Ÿã€‚åœ¨æ„å»ºèƒ½è‡ªåŠ¨æ¢å¤ï¼ŒåŒæ—¶åˆé¿å…è„‘è£‚çš„å¤šå‰¯æœ¬ç³»ç»Ÿæ—¶ï¼Œå…³é”®ç‚¹åœ¨äº<strong>è¿‡åŠæŠ•ç¥¨</strong>ã€‚</p><p>é¦–å…ˆæœåŠ¡å™¨çš„æ•°é‡å¿…é¡»æ˜¯å¥‡æ•°ï¼Œé‚£ä¹ˆå½“å‡ºç°ç½‘ç»œåˆ†åŒºæ—¶ï¼Œå¿…ç„¶åªå¯èƒ½æœ€å¤šæœ‰ä¸€ä¸ªåˆ†åŒºæ‹¥æœ‰åŠæ•°ä»¥ä¸Šçš„æœåŠ¡å™¨ã€‚æˆ‘ä»¬å¯ä»¥è§„å®šï¼Œå¦‚æœè¦å®Œæˆä»»ä½•æ“ä½œï¼Œå¿…é¡»è¦å‡‘å¤ŸåŠæ•°ä»¥ä¸Šçš„æœåŠ¡å™¨çš„æŠ•ç¥¨ã€‚è¿™æ ·ï¼Œåœ¨ä»»ä½•æƒ…å†µä¸‹åªå¯èƒ½æœ‰ä¸€ä¸ªåˆ†åŒºèƒ½å¤Ÿå®Œæˆæ“ä½œï¼Œè¿™ä¹Ÿå°±é¿å…äº†è„‘è£‚çš„åœºæ™¯ã€‚</p><p>åœ¨è¿™ç§è¿‡åŠæŠ•ç¥¨çš„æ€æƒ³çš„æ”¯æŒä¸‹ï¼Œåœ¨ä¸Šä¸–çºªä¹åå¹´ä»£ï¼Œæœ‰ä¸¤ä¸ªç³»ç»Ÿè¢«åŒæ—¶æå‡ºï¼šPaxos å’Œ ViewStamped Replicationï¼Œè¿™ä¸¤ä¸ªç³»ç»Ÿéƒ½ä½¿ç”¨è¿‡åŠè´­ç¥¨çš„åŸç†æ¥é¿å…è„‘è£‚çš„é—®é¢˜ã€‚</p><h2 id="Raft-é¢†å¯¼äººé€‰ä¸¾"><a href="#Raft-é¢†å¯¼äººé€‰ä¸¾" class="headerlink" title="Raft é¢†å¯¼äººé€‰ä¸¾"></a>Raft é¢†å¯¼äººé€‰ä¸¾</h2><p>Raft ä¹Ÿåº”ç”¨äº†è¿‡åŠæŠ•ç¥¨çš„æ€æƒ³æ¥è§£å†³è„‘è£‚é—®é¢˜ã€‚Raft ä¼šé€šè¿‡è¿‡åŠæŠ•ç¥¨é€‰ä¸¾å‡ºä¸€ä¸ªé¢†å¯¼äººï¼Œç„¶åç»™äºˆä»–å…¨éƒ¨çš„ç®¡ç†å¤åˆ¶æ—¥å¿—çš„è´£ä»»æ¥å®ç°ä¸€è‡´æ€§ã€‚</p><p>é¢†å¯¼äººä»å®¢æˆ·ç«¯æ¥æ”¶æ—¥å¿—æ¡ç›®ï¼ŒæŠŠæ—¥å¿—æ¡ç›®å¤åˆ¶åˆ°å…¶ä»–æœåŠ¡å™¨ä¸Šï¼Œå¹¶å‘Šè¯‰å…¶ä»–çš„æœåŠ¡å™¨ä»€ä¹ˆæ—¶å€™å¯ä»¥å®‰å…¨åœ°å°†æ—¥å¿—æ¡ç›®åº”ç”¨åˆ°ä»–ä»¬çš„çŠ¶æ€æœºä¸­ã€‚æ‹¥æœ‰ä¸€ä¸ªé¢†å¯¼äººå¤§å¤§ç®€åŒ–äº†å¯¹å¤åˆ¶æ—¥å¿—çš„ç®¡ç†ã€‚ä¾‹å¦‚ï¼Œé¢†å¯¼äººå¯ä»¥å†³å®šæ–°çš„æ—¥å¿—æ¡ç›®éœ€è¦æ”¾åœ¨æ—¥å¿—ä¸­çš„ä»€ä¹ˆä½ç½®è€Œä¸éœ€è¦å’Œå…¶ä»–æœåŠ¡å™¨å•†è®®ï¼Œå¹¶ä¸”æ•°æ®éƒ½ä»é¢†å¯¼äººæµå‘å…¶ä»–æœåŠ¡å™¨ã€‚ä¸€ä¸ªé¢†å¯¼äººå¯èƒ½ä¼šå‘ç”Ÿæ•…éšœï¼Œæˆ–è€…å’Œå…¶ä»–æœåŠ¡å™¨å¤±å»è¿æ¥ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ä¸€ä¸ªæ–°çš„é¢†å¯¼äººä¼šè¢«é€‰ä¸¾å‡ºæ¥ã€‚</p><p>å…·ä½“çš„é¢†å¯¼äººé€‰ä¸¾ç®—æ³•ï¼Œåœ¨ Raft è®ºæ–‡ä¸­è¯´çš„éå¸¸è¯¦ç»†ï¼š<a href="https://raft.github.io/raft.pdf">Raft paper</a>ï¼ˆç¬¬5èŠ‚å’Œ5.2èŠ‚ï¼‰ã€‚</p><h2 id="Lab-2A-ä¸­é‡åˆ°çš„é—®é¢˜"><a href="#Lab-2A-ä¸­é‡åˆ°çš„é—®é¢˜" class="headerlink" title="Lab 2A ä¸­é‡åˆ°çš„é—®é¢˜"></a>Lab 2A ä¸­é‡åˆ°çš„é—®é¢˜</h2><p>æœ€åè¯´ä¸€è¯´ï¼Œåœ¨å®ç° 6.824 çš„ LAB 2A æ—¶é‡åˆ°ä¸€ä¸ªæ­»é” Bugã€‚</p><p>åœ¨ 6.824 çš„ LAB 2A ä¸­ï¼Œæ˜¯éœ€è¦å¤§é‡ä½¿ç”¨äº’æ–¥é”çš„ï¼Œè¿™éå¸¸å®¹æ˜“å‡ºé”™ã€‚åœ¨æˆ‘ç¬¬ä¸€æ¬¡å®ç°å®Œ LAB 2A å¹¶è¿è¡Œæµ‹è¯•çš„æ—¶å€™ï¼ŒæŠ¥äº†å¤§é‡çš„æ•°æ®ç«äº‰é”™è¯¯ï¼ŒæŠŠè¿™ä¸ªé”™è¯¯æ”¹å®Œå°±èŠ±äº†åå‡ åˆ†é’Ÿ~~ã€‚</p><p>ä¹‹åç»§ç»­è¿è¡Œæµ‹è¯•çš„æ—¶å€™ï¼Œåˆå¡åœ¨äº† â€œelection after network failureâ€ çš„æµ‹è¯•ä¸­ï¼Œä½†å¥‡æ€ªçš„æ˜¯æ•´ä¸ªæµ‹è¯•å¹¶æ²¡æœ‰æŠ¥é”™ï¼Œåªæ˜¯â€œå¡ä½äº†â€ï¼Œæˆ‘å°±çŒœåˆ°å¯èƒ½å‡ºç°äº†æ­»é”ã€‚ä½¿ç”¨åšå®¢ <a href="https://blog.josejg.com/debugging-pretty/">Debugging by Pretty Printing</a> ä¸­çš„æµ‹è¯•æ¡†æ¶ï¼Œå¾—åˆ°äº†å¦‚ä¸‹çš„æ—¥å¿—è®°å½•ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs go">S0 starts running                                                                                                                                                         <br>                                                          S1 starts running                                                                                               <br>                                                                                                                  S2 starts running                                       <br>S0 starts election                                                                                                                                                        <br>S0 becomes Candidate                                                                                                                                                      <br>S0 change term from <span class="hljs-number">0</span> to <span class="hljs-number">1</span>                                                                                                                                                <br>S0 votes <span class="hljs-keyword">for</span> S0                                                                                                                                                           <br>                                                          S1 receives VoteRequestRpc from S0                                                                              <br>                                                          S1 becomes Follower                                                                                             <br>                                                          S1 changes term from <span class="hljs-number">1</span> to <span class="hljs-number">1</span>                                                                                     <br>                                                          S1 votes <span class="hljs-keyword">for</span> S0                                                                                                 <br>S0 becomes Leader                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>                                                          S1 receives AppendEntriesRpc from S0                                                                            <br>                                                          S1 reply AppendEntriesRpc from S0: &amp;&#123;Term:<span class="hljs-number">1</span>&#125;                                                                    <br>                                                                                                                  S2 receives AppendEntriesRpc from S0                    <br>                                                                                                                  S2 becomes Follower                                     <br>                                                                                                                  S2 changes term from <span class="hljs-number">1</span> to <span class="hljs-number">1</span>                             <br>                                                                                                                  S2 reply AppendEntriesRpc from S0: &amp;&#123;Term:<span class="hljs-number">1</span>&#125;            <br>S0 sends hearbeat                                                                                                                                                         <br>                                                          S1 receives AppendEntriesRpc from S0                                                                            <br>                                                          S1 reply AppendEntriesRpc from S0: &amp;&#123;Term:<span class="hljs-number">1</span>&#125;                                                                    <br>                                                                                                                  S2 receives AppendEntriesRpc from S0                    <br>                                                                                                                  S2 reply AppendEntriesRpc from S0: &amp;&#123;Term:<span class="hljs-number">1</span>&#125;            <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>                                                                                                                  S2 starts election                                      <br>                                                                                                                  S2 becomes Candidate                                    <br>                                                                                                                  S2 change term from <span class="hljs-number">1</span> to <span class="hljs-number">2</span>                              <br>                                                                                                                  S2 votes <span class="hljs-keyword">for</span> S2                                         <br>                                                          S1 starts election                                                                                              <br>                                                          S1 becomes Candidate                                                                                            <br>                                                          S1 change term from <span class="hljs-number">1</span> to <span class="hljs-number">2</span>                                                                                      <br>                                                          S1 votes <span class="hljs-keyword">for</span> S1                                                                                                 <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>                                                                                                                  S2 receives VoteRequestRpc from S1                      <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>S0 sends hearbeat                                                                                                                                                         <br>                                                          S1 receives VoteRequestRpc from S2                                                                              <br>S0 sends hearbeat   <br>S0 sends hearbeat<br>S0 sends hearbeat<br>S0 sends hearbeat<br>S0 sends hearbeat<br>S0 sends hearbeat                                                                                                                                                                                          <br></code></pre></td></tr></table></figure><p>åœ¨ç¬¬25åˆ°28è¡Œçš„è®°å½•ä¸­ï¼Œå¯ä»¥çœ‹åˆ° S0 å‘é€äº†å››æ¬¡å¿ƒè·³ï¼Œä½†æ˜¯éƒ½æ²¡æœ‰æ”¶åˆ° S1 å’Œ S2 çš„ç­”å¤ï¼Œå¯ä»¥æ¨æµ‹å‡ºå‘ç”Ÿäº†ç½‘ç»œåˆ†åŒºï¼Œè¿™æ—¶å€™ S1 å’Œ S2 æ— æ³•ä¸ S0 é€šä¿¡ã€‚</p><p>ä¹‹å S1 å’Œ S2 è§¦å‘é€‰ä¸¾è¶…æ—¶ï¼Œå‘èµ·é€‰ä¸¾æŠ•ç¥¨ï¼Œå®ƒä»¬é¦–å…ˆéƒ½ä¸ºè‡ªå·±æŠ•ç¥¨ï¼Œå› æ­¤ S1 å’Œ S2 éƒ½ä¸ä¼šå¾—åˆ°è¿‡åŠæŠ•ç¥¨ã€‚æŒ‰ç…§ç†è®ºæ¥è¯´ï¼Œè¿‡ä¸€ä¼šä¹‹ååˆä¼šè§¦å‘é€‰ä¸¾è¶…æ—¶ï¼ŒS1 æˆ– S2 ä¼šå†æ¬¡å‘èµ·é€‰ä¸¾æŠ•ç¥¨ï¼Œä½†æ˜¯æ•´ä¸ªç³»ç»Ÿå¡ä½äº†ï¼Œåªæœ‰ S0 è¿˜åœ¨æ‰“å°æ¶ˆæ¯ã€‚</p><p>æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œå¯åˆæ­¥å®šä½æ˜¯åœ¨é€‰ä¸¾æŠ•ç¥¨çš„å®ç°ä¸­å‡ºäº†é—®é¢˜ï¼Œä¹‹å‰çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> startElection() &#123;<br>    <span class="hljs-comment">// ...........</span><br>    <span class="hljs-comment">// ...........</span><br>    <span class="hljs-comment">// ...........</span><br><br>    receivedVotes := <span class="hljs-number">1</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> rf.peers &#123;<br>        <span class="hljs-keyword">if</span> i == rf.me &#123;<br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(peerId <span class="hljs-type">int</span>)</span></span> &#123;<br>            rf.mu.Lock()<br>            <span class="hljs-keyword">defer</span> rf.mu.Unlock()    <br>            <span class="hljs-comment">// å·²ç»è¢«é€‰ä¸¾æˆäº†é¢†å¯¼äººï¼Œæˆ–é€€åŒ–æˆäº†è·Ÿéšè€…ï¼Œç›´æ¥è¿”å›</span><br>            <span class="hljs-keyword">if</span> rf.role != CANDIDATE &#123;<br>                <span class="hljs-keyword">return</span><br>            &#125;<br>            <span class="hljs-comment">// é€‰ä¸¾è¶…æ—¶ï¼Œå½“å‰èŠ‚ç‚¹å‘èµ·æ–°ä¸€è½®é€‰ä¸¾ï¼Œå› æ­¤ä»»æœŸå·æ”¹å˜äº†ï¼Œç›´æ¥è¿”å›</span><br>            <span class="hljs-keyword">if</span> electionStartTerm != rf.currentTerm &#123;<br>                <span class="hljs-keyword">return</span><br>            &#125;<br>            args := &amp;RequestVoteArgs&#123;<br>                Term:        electionStartTerm,<br>                CandidateId: rf.me,<br>            &#125;<br>            reply := &amp;RequestVoteReply&#123;&#125;<br>            <span class="hljs-keyword">if</span> !rf.sendRequestVote(peerId, args, reply) &#123;<br>                <span class="hljs-keyword">return</span><br>            &#125;<br>            <span class="hljs-comment">// ...........</span><br>    Â Â Â Â Â Â Â Â <span class="hljs-comment">// ...........</span><br>    Â Â Â Â Â Â Â Â <span class="hljs-comment">// ...........</span><br>        &#125;(i)<br>    &#125;<br><br>    <span class="hljs-comment">// é‡ç½®é€‰ä¸¾è¶…æ—¶è®¡æ—¶å™¨</span><br>    rf.electionStart = time.Now()<br>    rf.electionTimeout = rf.randomElectionTimeout()<br>    <span class="hljs-keyword">go</span> rf.ticker()<br>&#125;    <br></code></pre></td></tr></table></figure><p>åœ¨å¾ªç¯ä¸­ï¼Œå¯¹æ¯ä¸ªèŠ‚ç‚¹æˆ‘ä»¬éƒ½ä¼šå¼€ä¸€ä¸ª Go ç¨‹å»â€œæ‹‰ç¥¨â€ï¼Œåœ¨ Go ç¨‹æœ€å¼€å¤´çš„æ—¶å€™æˆ‘ä»¬ç”³è¯·äº†é”ï¼Œç„¶åä½¿ç”¨ <code>defer rf.mu.Unlock()</code> åœ¨ Go ç¨‹è¿”å›çš„æ—¶å€™é‡Šæ”¾é”ï¼Œè€Œè¿™æ°æ°å°±å¯¼è‡´äº†æ­»é”ã€‚</p><p>åœ¨è¿™ä¸ªå®ç°ä¸­ï¼ŒS1 å’Œ S2 åœ¨å‘èµ·æŠ•ç¥¨ RPC çš„æ—¶å€™æ˜¯æŒæœ‰è‡ªå·±çš„é”çš„ï¼ˆå‡è®¾ S1 çš„é”ä¸ºé”Aï¼ŒS2 çš„é”ä¸ºé”Bï¼‰ã€‚è€Œ S1 å’Œ S2 åœ¨æ”¶åˆ°æŠ•ç¥¨ RPC åéœ€è¦è¯»å–è‡ªå·±çš„ä¸€äº›çŠ¶æ€ï¼Œå› æ­¤ S1 ä¼šç”³è¯·é”Aï¼ŒS2 ä¼šç”³è¯·é”Bï¼Œä½†æ˜¯æ­¤æ—¶é”Aå’Œé”Bå·²ç»è¢« S1 å’Œ S2 æŒæœ‰äº†ï¼Œè¿™æ ·æ•´ä¸ªç³»ç»Ÿå°±å¡ä½äº†ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œä¸‹å»ï¼Œå› æ­¤ S1 å’Œ S2 è‡ªç„¶å°±ä¸å¯èƒ½å†æ¬¡å‘èµ·é€‰ä¸¾ï¼Œå¾ˆæ˜¾ç„¶è¿™å°±æ˜¯ä¸€ä¸ªæ­»é”Bugã€‚</p><p>è§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œåªè¦ S1 å’Œ S2 åœ¨å‘èµ·æŠ•ç¥¨ RPC ä¹‹å‰æ˜¯å¦é‡Šæ”¾æ‰æŒæœ‰çš„é”å³å¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> startElection() &#123;<br>    <span class="hljs-comment">// ...........</span><br>    <span class="hljs-comment">// ...........</span><br>    <span class="hljs-comment">// ...........</span><br><br>    receivedVotes := <span class="hljs-number">1</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> rf.peers &#123;<br>        <span class="hljs-keyword">if</span> i == rf.me &#123;<br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(peerId <span class="hljs-type">int</span>)</span></span> &#123;<br>            rf.mu.Lock()<br>            <span class="hljs-comment">// å·²ç»è¢«é€‰ä¸¾æˆäº†é¢†å¯¼äººï¼Œæˆ–é€€åŒ–æˆäº†è·Ÿéšè€…ï¼Œç›´æ¥è¿”å›</span><br>            <span class="hljs-keyword">if</span> rf.role != CANDIDATE &#123;<br>                rf.mu.Unlock()<br>                <span class="hljs-keyword">return</span><br>            &#125;<br>            <span class="hljs-comment">// é€‰ä¸¾è¶…æ—¶ï¼Œå½“å‰èŠ‚ç‚¹å‘èµ·æ–°ä¸€è½®é€‰ä¸¾ï¼Œå› æ­¤ä»»æœŸå·æ”¹å˜äº†ï¼Œç›´æ¥è¿”å›</span><br>            <span class="hljs-keyword">if</span> electionStartTerm != rf.currentTerm &#123;<br>                rf.mu.Unlock()<br>                <span class="hljs-keyword">return</span><br>            &#125;<br>            rf.mu.Unlock()    <span class="hljs-comment">// åœ¨æŠ•ç¥¨å‰é‡Šæ”¾</span><br>            args := &amp;RequestVoteArgs&#123;<br>                Term:        electionStartTerm,<br>                CandidateId: rf.me,<br>            &#125;<br>            reply := &amp;RequestVoteReply&#123;&#125;<br>            <span class="hljs-keyword">if</span> !rf.sendRequestVote(peerId, args, reply) &#123;<br>                <span class="hljs-keyword">return</span><br>            &#125;<br>            <span class="hljs-comment">// ...........</span><br>            <span class="hljs-comment">// ...........</span><br>            <span class="hljs-comment">// ...........</span><br>        &#125;(i)<br>    &#125;<br><br>    <span class="hljs-comment">// é‡ç½®é€‰ä¸¾è¶…æ—¶è®¡æ—¶å™¨</span><br>    rf.electionStart = time.Now()<br>    rf.electionTimeout = rf.randomElectionTimeout()<br>    <span class="hljs-keyword">go</span> rf.ticker()<br>&#125;<br></code></pre></td></tr></table></figure><p>å†æ¬¡è¿è¡Œ Lab 2A çš„æµ‹è¯•ï¼Œå°±èƒ½å®Œç¾é€šè¿‡äº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go">Test (<span class="hljs-number">2</span>A): initial election ...<br>  ... Passed --   <span class="hljs-number">3.0</span>  <span class="hljs-number">3</span>  <span class="hljs-number">110</span>   <span class="hljs-number">11914</span>    <span class="hljs-number">0</span><br>Test (<span class="hljs-number">2</span>A): election after network failure ...<br>  ... Passed --   <span class="hljs-number">4.5</span>  <span class="hljs-number">3</span>  <span class="hljs-number">130</span>    <span class="hljs-number">9694</span>    <span class="hljs-number">0</span><br>Test (<span class="hljs-number">2</span>A): multiple elections ...<br>  ... Passed --   <span class="hljs-number">5.6</span>  <span class="hljs-number">7</span>  <span class="hljs-number">852</span>   <span class="hljs-number">69742</span>    <span class="hljs-number">0</span><br>PASS<br>ok      <span class="hljs-number">6.824</span>/raft      <span class="hljs-number">14.129</span>s<br></code></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><p><a href="https://pdos.csail.mit.edu/6.824/">MIT 6.824</a></p></li><li><p><a href="https://raft.github.io/raft.pdf">Raft paper</a></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>distributed system</category>
      
    </categories>
    
    
    <tags>
      
      <tag>distributed</tag>
      
      <tag>consistency</tag>
      
      <tag>paper</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Raftï¼ˆä¸€ï¼‰ï¼šä¸€è‡´æ€§ç®—æ³•</title>
    <link href="/2022/07/24/Raft-1/"/>
    <url>/2022/07/24/Raft-1/</url>
    
    <content type="html"><![CDATA[<h2 id="ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦åˆ†å¸ƒå¼ç³»ç»Ÿï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦åˆ†å¸ƒå¼ç³»ç»Ÿï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦åˆ†å¸ƒå¼ç³»ç»Ÿï¼Ÿ"></a>ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦åˆ†å¸ƒå¼ç³»ç»Ÿï¼Ÿ</h2><p>åˆ†å¸ƒå¼ç³»ç»Ÿæ˜¯ç”±ä¸€ç»„é€šè¿‡ç½‘ç»œè¿›è¡Œé€šä¿¡ã€ä¸ºäº†å®Œæˆå…±åŒçš„ä»»åŠ¡è€Œåè°ƒå·¥ä½œçš„è®¡ç®—æœºèŠ‚ç‚¹ç»„æˆçš„ç³»ç»Ÿã€‚</p><p>äº‹å®ä¸Šåˆ†å¸ƒå¼ç³»ç»Ÿçš„å¤æ‚ç¨‹åº¦é€šå¸¸è¿œè¿œè¶…è¿‡å•æœºç³»ç»Ÿï¼Œåœ¨å•æœºç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé‡åˆ°ç£ç›˜æ•…éšœã€å¹¶å‘æ­»é”ã€ç³»ç»Ÿå´©æºƒç­‰é—®é¢˜ï¼Œè€Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œé™¤äº†è¿™äº›é—®é¢˜å¤–ï¼Œæˆ‘ä»¬è¿˜å¯èƒ½é‡åˆ°ç½‘ç»œå»¶è¿Ÿã€åˆ†åŒºã€ç³»ç»ŸçŠ¶æ€ä¸ä¸€è‡´ç­‰åƒå¥‡ç™¾æ€ªçš„é—®é¢˜ã€‚</p><p>ä½†æ˜¯ï¼Œåˆ†å¸ƒå¼ç³»ç»ŸåŒæ ·å…·æœ‰ä¸€äº›å¥½å¤„æ¥å¸å¼•äººä»¬ä½¿ç”¨å®ƒï¼š</p><ul><li><p>åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å­˜åœ¨å¤§é‡çš„è®¡ç®—æœºå¹¶è¡Œè¿è¡Œï¼Œå¯ä»¥è·å–<strong>æ›´é«˜çš„æ€§èƒ½</strong>ã€‚æ¯”å¦‚å¤§é‡çš„è®¡ç®—çš„CPUã€å†…å­˜ã€ç£ç›˜å¯ä»¥å¹¶è¡Œè¿è¡Œã€‚</p></li><li><p>åˆ†å¸ƒå¼ç³»ç»Ÿå¯ä»¥æä¾›<strong>å®¹é”™</strong>ã€‚æ¯”å¦‚ä¸¤å°è®¡ç®—æœºè¿è¡Œå®Œå…¨ç›¸åŒçš„ä»»åŠ¡ï¼Œå…¶ä¸­ä¸€å°å‘ç”Ÿæ•…éšœï¼Œå¯ä»¥åˆ‡æ¢åˆ°å¦ä¸€å°ã€‚</p></li><li><p>ç”±äºç‰©ç†åŸå› ï¼Œæœ‰äº›ç³»ç»Ÿå¤©ç„¶åœ¨<strong>ç©ºé—´ä¸Šæ˜¯åˆ†å¸ƒå¼</strong>çš„ã€‚ä¾‹å¦‚é“¶è¡Œè½¬è´¦ï¼Œå‡è®¾é“¶è¡Œåœ¨ç›¸è·å¾ˆè¿œçš„åœ°æ–¹åˆ†åˆ«ç”±ä¸¤å°æœåŠ¡å™¨ï¼Œå¦‚æœè¦åœ¨è¿™ä¸¤å°æœåŠ¡å™¨ä¹‹å‰è¿›è¡Œäº¤æ˜“è½¬è´¦ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€ç§åœ¨ä¸¤è€…ä¹‹é—´è¿›è¡Œåè°ƒçš„æ–¹æ³•ã€‚</p></li><li><p>å®ç°ä¸€äº›<strong>å®‰å…¨</strong>ç›®æ ‡ã€‚æ¯”å¦‚æœ‰ä¸€äº›ä»£ç ä¸è¢«ä¿¡ä»»ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦å’Œå®ƒäº¤äº’ï¼Œè¿™äº›ä»£ç ä¸ä¼šç«‹å³è¡¨ç°å‡ºæ¶æ„æˆ–å‡ºç°bugã€‚æˆ‘ä»¬å¯ä»¥æŠŠä»£ç åˆ†æ•£åœ¨å¤šå¤„è¿è¡Œï¼Œè¿™æ ·ä¸è¢«ä¿¡ä»»çš„ä»£ç åœ¨ä¸€å°è®¡ç®—æœºè¿è¡Œï¼Œæˆ‘ä»¬çš„ä»£ç åœ¨è‡ªå·±çš„è®¡ç®—æœºä¸Šè¿è¡Œï¼Œç„¶åå†é€šè¿‡ä¸€äº›ç‰¹å®šçš„ç½‘ç»œåè®®é€šä¿¡ã€‚è¿™æ ·å°±æŠŠç³»ç»Ÿåˆ†æˆäº†å¤šä¸ªè®¡ç®—æœºï¼Œå¯ä»¥é™åˆ¶æ¶æ„ä»£ç çš„å‡ºé”™åŸŸã€‚</p></li></ul><h2 id="é€šè¿‡å¤åˆ¶å®ç°å®¹é”™"><a href="#é€šè¿‡å¤åˆ¶å®ç°å®¹é”™" class="headerlink" title="é€šè¿‡å¤åˆ¶å®ç°å®¹é”™"></a>é€šè¿‡å¤åˆ¶å®ç°å®¹é”™</h2><p>ä¸Šé¢æåˆ°ï¼Œäººä»¬ä½¿ç”¨åˆ†å¸ƒå¼ç³»ç»Ÿçš„å…¶ä¸­ä¸€ä¸ªåŸå› å°±æ˜¯å®¹é”™ï¼Œè€Œå¤åˆ¶æ˜¯å®ç°å®¹é”™çš„ä¸€ä¸ªé‡è¦çš„å·¥å…·ã€‚é€šè¿‡å¤åˆ¶ï¼Œå¯ä»¥è®©åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„èŠ‚ç‚¹è¿è¡Œç›¸åŒå‰¯æœ¬ï¼Œä»åœ¨å¯ä»¥åœ¨ä¸€ä¸ªèŠ‚ç‚¹å‡ºç°æ•…éšœçš„æƒ…å†µä¸‹ï¼Œå…¶ä»–çš„èŠ‚ç‚¹å¯ä»¥ç»§ç»­æä¾›æœåŠ¡ã€‚</p><p>æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥å®ç°å¤åˆ¶ï¼Œä¸€ç§æ˜¯çŠ¶æ€è½¬ç§»ï¼ˆState Transferï¼‰ï¼Œå¦ä¸€ç§æ˜¯å¤åˆ¶çŠ¶æ€æœºï¼ˆReplicated State Machineï¼‰ã€‚</p><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæœåŠ¡çš„ä¸¤ä¸ªå‰¯æœ¬ï¼Œä¸€ä¸ªæ˜¯ Primaryï¼Œå¦ä¸€ä¸ªæ˜¯ Backupã€‚æˆ‘ä»¬éœ€è¦è®©å®ƒä»¬ä¿æŒåŒæ­¥ï¼Œåœ¨å®é™…ä¸Šäº’ä¸ºå‰¯æœ¬ï¼Œè¿™æ ·ä¸€æ—¦ Primary å‡ºç°æ•…éšœï¼Œå› ä¸º Backup çš„çŠ¶æ€ä¸ Primary ä¸€è‡´ï¼Œå°±å¯ä»¥æ¥ç®¡æ•´ä¸ªæœåŠ¡ã€‚</p><p>çŠ¶æ€è½¬ç§»èƒŒåçš„æ€æƒ³æ˜¯ï¼ŒPrimary å°†è‡ªå·±å®Œæ•´çŠ¶æ€ï¼Œæ¯”å¦‚è¯´å†…å­˜ä¸­çš„å†…å®¹ï¼Œæ‹·è´å¹¶å‘é€ç»™Backupã€‚Backup ä¼šä¿å­˜æ”¶åˆ°çš„æœ€è¿‘ä¸€æ¬¡çŠ¶æ€ï¼Œæ‰€ä»¥ Backup ä¼šæœ‰æ‰€æœ‰çš„æ•°æ®ã€‚å½“ Primary æ•…éšœäº†ï¼ŒBackup å°±å¯ä»¥ä»å®ƒæ‰€ä¿å­˜çš„æœ€æ–°çŠ¶æ€å¼€å§‹è¿è¡Œã€‚æ‰€ä»¥ï¼ŒçŠ¶æ€è½¬ç§»å°±æ˜¯å‘é€ Primaryçš„çŠ¶æ€ã€‚</p><p>å¤åˆ¶çŠ¶æ€æœºåŸºäºä¸€ä¸ªäº‹å®ï¼šæˆ‘ä»¬æƒ³è¦å¤åˆ¶çš„å¤§éƒ¨åˆ†æœåŠ¡éƒ½æœ‰ä¸€äº›ç¡®å®šçš„å†…éƒ¨æ“ä½œï¼Œè€Œå¤–éƒ¨è¾“å…¥æ˜¯ä¸ç¡®å®šçš„ã€‚å¦‚æœä¸€å°è®¡ç®—æœºæ²¡æœ‰å¤–éƒ¨è¾“å…¥ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªæ¥ä¸€ä¸ªçš„æ‰§è¡ŒæŒ‡ä»¤ï¼Œè¿™æ ·è¿è¡Œç€ç›¸åŒæœåŠ¡çš„å¤šä¸ªè®¡ç®—æœºçš„çŠ¶æ€å°±ä¼šä¿æŒä¸€è‡´ã€‚åªæœ‰å½“å­˜åœ¨å¤–éƒ¨è¾“å…¥æ—¶ï¼Œæ‰å¯èƒ½ä¼šç ´åä¸€è‡´æ€§ã€‚ä¾‹å¦‚ï¼Œä¸€å°æœåŠ¡å™¨åœ¨æŸä¸ªæ—¶é—´æ”¶åˆ°äº†ä¸€ä¸ªç½‘ç»œæ•°æ®åŒ…ï¼Œå¯¼è‡´æœåŠ¡å™¨åšä¸€äº›ä¸åŒçš„äº‹æƒ…ã€‚</p><p>æ‰€ä»¥ï¼Œå¤åˆ¶çŠ¶æ€æœºä¸ä¼šåœ¨ä¸åŒçš„å‰¯æœ¬ä¹‹é—´å‘é€çŠ¶æ€ï¼Œç›¸åº”çš„ï¼Œå®ƒåªä¼šä» Primary å°†è¿™äº›å¤–éƒ¨è¾“å…¥å‘é€ç»™ Backupã€‚å‡è®¾æœ‰å¤šå°è®¡ç®—æœºï¼Œå¦‚æœå®ƒä»¬ä»ç›¸åŒçš„çŠ¶æ€å¯åŠ¨ï¼Œå¹¶ä¸”ä»¥ç›¸åŒçš„é¡ºåºæ‰§è¡Œç›¸åŒçš„å¤–éƒ¨è¾“å…¥ï¼Œé‚£ä¹ˆå®ƒä»¬ä¼šä¸€ç›´äº’ä¸ºå‰¯æœ¬ï¼Œä¿æŒä¸€è‡´ã€‚</p><p>å› æ­¤ï¼ŒçŠ¶æ€è½¬ç§»ä¼ è¾“çš„æ˜¯å¯èƒ½æ˜¯å†…å­˜çŠ¶æ€ï¼Œè€Œå¤åˆ¶çŠ¶æ€æœºä¼šå°†æ¥è‡ªå®¢æˆ·ç«¯çš„æ“ä½œæˆ–è€…å…¶ä»–å¤–éƒ¨è¾“å…¥ï¼Œä» Primary ä¼ è¾“åˆ° Backupã€‚</p><h2 id="Raft-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#Raft-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="Raft æ˜¯ä»€ä¹ˆï¼Ÿ"></a>Raft æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>ä¸Šé¢æˆ‘ä»¬æåˆ°å¤åˆ¶çŠ¶æ€æœºæ˜¯å¤åˆ¶çš„ä¸€ç§å®ç°æ–¹æ³•ï¼Œè€Œå¤åˆ¶çŠ¶æ€æœºåˆé€šå¸¸æ˜¯åŸºäºå¤åˆ¶æ—¥å¿—å®ç°çš„ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p><img src="/2022/07/24/Raft-1/raft-%E5%9B%BE1.png" class=""><p>æ¯ä¸ªæœåŠ¡å™¨å­˜å‚¨ä¸€ä¸ªåŒ…å«ä¸€ç³»åˆ—æŒ‡ä»¤çš„æ—¥å¿—ï¼Œå¹¶ä¸”æŒ‰ç…§æ—¥å¿—çš„é¡ºåºæ‰§è¡ŒæŒ‡ä»¤ã€‚å¦‚æœæ¯ä¸ªæ—¥å¿—éƒ½æŒ‰ç…§ç›¸åŒçš„é¡ºåºåŒ…å«ç›¸åŒçš„æŒ‡ä»¤ï¼Œé‚£ä¹ˆæ¯ä¸ªæœåŠ¡å™¨éƒ½å°†æ‰§è¡Œç›¸åŒçš„æŒ‡ä»¤åºåˆ—ï¼Œæœ€ç»ˆæ‰€æœ‰çš„æœåŠ¡å…¶éƒ½å°†ä¿æŒä¸€è‡´çš„çŠ¶æ€ã€‚åè¿‡æ¥è¯´ï¼Œå¦‚æœæœåŠ¡å™¨ä¸Šçš„æ—¥å¿—å‡ºç°äº†ä¸ä¸€è‡´ï¼Œæ¯”å¦‚æŸäº›æœåŠ¡å™¨ä¸Šç¼ºå¤±äº†ä¸€æ¡æŒ‡ä»¤ï¼Œæˆ–è€…æŒ‡ä»¤é¡ºåºä¸å…¶ä»–çš„æœåŠ¡å™¨ä¸ä¸€æ ·ï¼Œé‚£ä¹ˆæ¯ä¸ªæœåŠ¡å™¨å°†ä¼šæ‰§è¡Œä¸ä¸€æ ·çš„æŒ‡ä»¤åºåˆ—ï¼Œå¯¼è‡´å‡ºç°çŠ¶æ€ä¸åŒæ­¥çš„é—®é¢˜ã€‚</p><p>è€Œ Raft å°±æ˜¯ä¸€ç§ä¸€è‡´æ€§ç®—æ³•ï¼Œå…¶ä»»åŠ¡æ˜¯ä¿è¯å¤åˆ¶æ—¥å¿—çš„ä¸€è‡´æ€§ã€‚æœåŠ¡å™¨ä¸Šçš„ä¸€è‡´æ€§æ¨¡å—æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æŒ‡ä»¤ç„¶åæ·»åŠ åˆ°è‡ªå·±çš„æ—¥å¿—ä¸­ã€‚å®ƒå’Œå…¶ä»–æœåŠ¡å™¨ä¸Šçš„ä¸€è‡´æ€§æ¨¡å—è¿›è¡Œé€šä¿¡æ¥ä¿è¯æ¯ä¸€ä¸ªæœåŠ¡å™¨ä¸Šçš„æ—¥å¿—æœ€ç»ˆéƒ½ä»¥ç›¸åŒçš„é¡ºåºåŒ…å«ç›¸åŒçš„è¯·æ±‚ï¼Œå³ä½¿æœ‰äº›æœåŠ¡å™¨å‘ç”Ÿæ•…éšœã€‚ä¸€æ—¦æŒ‡ä»¤è¢«æ­£ç¡®å¤åˆ¶ï¼Œæ¯ä¸€ä¸ªæœåŠ¡å™¨çš„çŠ¶æ€æœºæŒ‰ç…§æ—¥å¿—é¡ºåºå¤„ç†ä»–ä»¬ï¼Œç„¶åè¾“å‡ºç»“æœè¢«è¿”å›ç»™å®¢æˆ·ç«¯ã€‚å› æ­¤ï¼ŒæœåŠ¡å™¨é›†ç¾¤çœ‹èµ·æ¥å½¢æˆäº†ä¸€ä¸ªé«˜å¯é çš„çŠ¶æ€æœºã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><p><a href="https://pdos.csail.mit.edu/6.824/">MIT 6.824</a></p></li><li><p><a href="https://raft.github.io/raft.pdf">Raft paper</a></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>distributed system</category>
      
    </categories>
    
    
    <tags>
      
      <tag>distributed</tag>
      
      <tag>consistency</tag>
      
      <tag>paper</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>lock-free hashtable</title>
    <link href="/2022/05/22/lock-free-hashtable/"/>
    <url>/2022/05/22/lock-free-hashtable/</url>
    
    <content type="html"><![CDATA[<h2 id="lock-free-linked-list"><a href="#lock-free-linked-list" class="headerlink" title="lock-free linked list"></a>lock-free linked list</h2><p>æ–½å·¥ä¸­ã€‚ã€‚ã€‚ã€‚</p><h2 id="lock-free-hashtable"><a href="#lock-free-hashtable" class="headerlink" title="lock-free hashtable"></a>lock-free hashtable</h2><p>æ–½å·¥ä¸­ã€‚ã€‚ã€‚ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>concurrent</category>
      
    </categories>
    
    
    <tags>
      
      <tag>rust</tag>
      
      <tag>concurrent</tag>
      
      <tag>parallel</tag>
      
      <tag>lock-free</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>drop check</title>
    <link href="/2022/05/22/drop-check/"/>
    <url>/2022/05/22/drop-check/</url>
    
    <content type="html"><![CDATA[<h2 id="drop-check-x2F-may-dangle"><a href="#drop-check-x2F-may-dangle" class="headerlink" title="drop check&#x2F;may_dangle"></a>drop check&#x2F;may_dangle</h2><p>Drop checkerä¼šæ£€æŸ¥ä¸€ä¸ªç±»å‹æ˜¯å¦èƒ½å¤Ÿå®‰å…¨åœ°å®ç°Drop Taritã€‚<strong>å¦‚æœä¸€ä¸ªèƒ½å¤Ÿå®‰å…¨å®ç°Dropçš„ç±»å‹ï¼Œé‚£ä¹ˆå®ƒçš„æ³›å‹å‚æ•°çš„ç”Ÿå‘½å‘¨æœŸå¿…é¡»ä¸¥æ ¼é•¿äºå®ƒæœ¬èº«</strong>ã€‚ä¸€ä¸ªè¿åDrop checkçš„ä¾‹å­ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#![allow(unused)]</span><br><span class="hljs-keyword">use</span> std::alloc::&#123;GlobalAlloc, Layout, System&#125;;<br><span class="hljs-keyword">use</span> std::fmt;<br><span class="hljs-keyword">use</span> std::mem;<br><span class="hljs-keyword">use</span> std::ptr;<br><br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> (y, x);<br>    x = String::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;Hello World&quot;</span>);<br>    y = MyBox::<span class="hljs-title function_ invoke__">new</span>(&amp;x);<br>&#125;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyBox</span>&lt;T&gt; &#123;<br>    v: *<span class="hljs-keyword">mut</span> T,<br>&#125;<br><br><span class="hljs-keyword">impl</span>&lt;T&gt; MyBox&lt;T&gt; &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(t: T) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">unsafe</span> &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">p</span> = System.<span class="hljs-title function_ invoke__">alloc</span>(Layout::array::&lt;T&gt;(<span class="hljs-number">1</span>).<span class="hljs-title function_ invoke__">unwrap</span>());<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">p</span> = p <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> T;<br>            ptr::<span class="hljs-title function_ invoke__">write</span>(p, t);<br>            MyBox &#123;<br>                v: p,<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span>&lt;T&gt; <span class="hljs-built_in">Drop</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">MyBox</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">drop</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">unsafe</span> &#123;<br>            ptr::<span class="hljs-title function_ invoke__">drop_in_place</span>(<span class="hljs-keyword">self</span>.v);<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">p</span> = <span class="hljs-keyword">self</span>.v <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> _;<br>            System.<span class="hljs-title function_ invoke__">dealloc</span>(p, Layout::array::&lt;T&gt;(<span class="hljs-number">1</span>).<span class="hljs-title function_ invoke__">unwrap</span>());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘å°†ä¼šå‘ç”ŸæŠ¥é”™ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust">error[E0597]: `x` does not live long enough<br>  -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">13</span>:<span class="hljs-number">20</span><br>   |<br><span class="hljs-number">13</span> |     y = MyBox::<span class="hljs-title function_ invoke__">new</span>(&amp;x);<br>   |                    ^^ borrowed value does not live long enough<br><span class="hljs-number">14</span> | &#125;<br>   | -<br>   | |<br>   | `x` dropped here <span class="hljs-keyword">while</span> still borrowed<br>   | borrow might be used here, when `y` is dropped and runs the `<span class="hljs-built_in">Drop</span>` code <span class="hljs-keyword">for</span> <span class="hljs-title class_">type</span> `MyBox`<br>   |<br>   = note: values <span class="hljs-keyword">in</span> a scope are dropped <span class="hljs-keyword">in</span> the opposite order they are defined<br></code></pre></td></tr></table></figure><p>ä»è¡¨é¢ä¸Šçœ‹ï¼Œ<code>x</code>ä¸<code>y</code>çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸€æ ·é•¿çš„ã€‚ä½†æ˜¯<code>x</code>æ¯”<code>y</code>å…ˆå®šä¹‰ï¼Œå› æ­¤å˜é‡<code>x</code>ä¼šé¦–å…ˆå‘ç”Ÿææ„ï¼Œå› æ­¤<code>x</code>çš„ç”Ÿå‘½å‘¨æœŸå¹¶ä¸ä¸¥æ ¼é•¿äº<code>y</code>çš„ç”Ÿå‘½å‘¨æœŸï¼Œè¿™æ˜¾ç„¶ä¸æ»¡è¶³Drop checkerçš„æ¡ä»¶ï¼Œå› æ­¤å‘ç”ŸæŠ¥é”™ï¼šç¼–è¯‘å™¨è®¤ä¸ºåœ¨è°ƒç”¨<code>y</code>çš„ææ„å‡½æ•°æ—¶ï¼Œå¯èƒ½ä¼šä½¿ç”¨<code>x</code>çš„å¼•ç”¨ï¼Œè¿™ä¼šå¯¼è‡´UBï¼Œå› æ­¤ç¼–è¯‘å™¨æ‹’ç»è¿™æ®µä»£ç ã€‚</p><p>ä½†æ˜¯ï¼Œå®é™…ä¸Šæˆ‘ä»¬å¹¶æ²¡æœ‰åœ¨<code>y</code>çš„ææ„å‡½æ•°ä½¿ç”¨<code>x</code>çš„å¼•ç”¨ï¼Œä¸ä¼šå‡ºç°UBè¡Œä¸ºã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥å¼€å¯ç‰¹æ€§<code>#![feature(dropck_eyepatch)]</code>ï¼Œå¹¶ä½¿ç”¨å±æ€§<code>#[may_dangle]</code>æ³¨è§£<code>T</code>ï¼Œæ˜ç¡®è¡¨ç¤ºä¸ä¼šåœ¨<code>y</code>çš„ææ„å‡½æ•°ä¸­ä½¿ç”¨<code>x</code>çš„å¼•ç”¨ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#![allow(unused)]</span><br><span class="hljs-meta">#![feature(dropck_eyepatch)]</span><br><span class="hljs-keyword">use</span> std::alloc::&#123;GlobalAlloc, Layout, System&#125;;<br><span class="hljs-keyword">use</span> std::fmt;<br><span class="hljs-keyword">use</span> std::mem;<br><span class="hljs-keyword">use</span> std::ptr;<br><br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> (y, x);<br>    x = String::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;Hello World&quot;</span>);<br>    y = MyBox::<span class="hljs-title function_ invoke__">new</span>(&amp;x);<br>&#125;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyBox</span>&lt;T&gt; &#123;<br>    v: *<span class="hljs-keyword">mut</span> T,<br>&#125;<br><br><span class="hljs-keyword">impl</span>&lt;T&gt; MyBox&lt;T&gt; &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(t: T) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">unsafe</span> &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">p</span> = System.<span class="hljs-title function_ invoke__">alloc</span>(Layout::array::&lt;T&gt;(<span class="hljs-number">1</span>).<span class="hljs-title function_ invoke__">unwrap</span>());<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">p</span> = p <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> T;<br>            ptr::<span class="hljs-title function_ invoke__">write</span>(p, t);<br>            MyBox &#123;<br>                v: p,<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">impl</span>&lt;<span class="hljs-meta">#[may_dangle]</span> T&gt; <span class="hljs-built_in">Drop</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">MyBox</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">drop</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">unsafe</span> &#123;<br>            ptr::<span class="hljs-title function_ invoke__">drop_in_place</span>(<span class="hljs-keyword">self</span>.v);<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">p</span> = <span class="hljs-keyword">self</span>.v <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> _;<br>            System.<span class="hljs-title function_ invoke__">dealloc</span>(p, Layout::array::&lt;T&gt;(<span class="hljs-number">1</span>).<span class="hljs-title function_ invoke__">unwrap</span>());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘å°†ä¼šé¡ºåˆ©é€šè¿‡ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust">Compiling playground v0.<span class="hljs-number">0.1</span> (/playground)<br>    Finished dev [unoptimized + debuginfo] <span class="hljs-title function_ invoke__">target</span>(s) <span class="hljs-keyword">in</span> <span class="hljs-number">7.20</span>s<br>     Running `target/debug/playground`<br></code></pre></td></tr></table></figure><h2 id="phantomData"><a href="#phantomData" class="headerlink" title="phantomData"></a>phantomData</h2><p>ä½¿ç”¨<code>may_dangle</code>åç¼–è¯‘å™¨å°†ä¸ä¼šè¿›è¡ŒDrop checkæ£€æŸ¥ï¼Œä½†æ˜¯åœ¨ä¸‹é¢çš„ä»£ç ä¸­å°†ä¼šå‡ºç°UBï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#![allow(unused)]</span><br><span class="hljs-meta">#![feature(dropck_eyepatch)]</span><br><span class="hljs-keyword">use</span> std::alloc::&#123;GlobalAlloc, Layout, System&#125;;<br><span class="hljs-keyword">use</span> std::fmt;<br><span class="hljs-keyword">use</span> std::mem;<br><span class="hljs-keyword">use</span> std::ptr;<br><br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> (y, x);<br>    x = Hello::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-number">13</span>);<br>    y = MyBox::<span class="hljs-title function_ invoke__">new</span>(Hello::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;y&quot;</span>, &amp;x));<br>&#125;<br><br><span class="hljs-meta">#[derive(Copy, Clone, Debug)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">State</span> &#123;<br>    Invalid,<br>    Valid,<br>&#125;<br><br><span class="hljs-meta">#[derive(Debug)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Hello</span>&lt;T: fmt::<span class="hljs-built_in">Debug</span>&gt;(&amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-type">str</span>, T, State);<br><br><span class="hljs-keyword">impl</span>&lt;T: fmt::<span class="hljs-built_in">Debug</span>&gt; Hello&lt;T&gt; &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(name: &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-type">str</span>, t: T) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-title function_ invoke__">Hello</span>(name, t, State::Valid)<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span>&lt;T: fmt::<span class="hljs-built_in">Debug</span>&gt; <span class="hljs-built_in">Drop</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Hello</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">drop</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Drop hello(&#123;&#125;, &#123;:?&#125;, &#123;:?&#125;)&quot;</span>, <span class="hljs-keyword">self</span>.<span class="hljs-number">0</span>, <span class="hljs-keyword">self</span>.<span class="hljs-number">1</span>, <span class="hljs-keyword">self</span>.<span class="hljs-number">2</span>);<br>        <span class="hljs-keyword">self</span>.<span class="hljs-number">2</span> = State::Invalid;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyBox</span>&lt;T&gt; &#123;<br>    v: *<span class="hljs-keyword">mut</span> T,<br>    <span class="hljs-comment">// _pd: PhantomData&lt;T&gt;</span><br>&#125;<br><br><span class="hljs-keyword">impl</span>&lt;T&gt; MyBox&lt;T&gt; &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(t: T) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">unsafe</span> &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">p</span> = System.<span class="hljs-title function_ invoke__">alloc</span>(Layout::array::&lt;T&gt;(<span class="hljs-number">1</span>).<span class="hljs-title function_ invoke__">unwrap</span>());<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">p</span> = p <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> T;<br>            ptr::<span class="hljs-title function_ invoke__">write</span>(p, t);<br>            MyBox &#123;<br>                v: p,<br>                <span class="hljs-comment">// _pd: PhantomData</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">impl</span>&lt;<span class="hljs-meta">#[may_dangle]</span> T&gt; <span class="hljs-built_in">Drop</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">MyBox</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">drop</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">unsafe</span> &#123;<br>            ptr::<span class="hljs-title function_ invoke__">drop_in_place</span>(<span class="hljs-keyword">self</span>.v);<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">p</span> = <span class="hljs-keyword">self</span>.v <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> _;<br>            System.<span class="hljs-title function_ invoke__">dealloc</span>(p, Layout::array::&lt;T&gt;(<span class="hljs-number">1</span>).<span class="hljs-title function_ invoke__">unwrap</span>());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘ç»“æœï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-built_in">Drop</span> <span class="hljs-title function_ invoke__">hello</span>(x, <span class="hljs-number">13</span>, Valid)<br><span class="hljs-built_in">Drop</span> <span class="hljs-title function_ invoke__">hello</span>(y, <span class="hljs-title function_ invoke__">Hello</span>(<span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-number">13</span>, Invalid), Valid)<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨MIRIæ£€æŸ¥æ˜¯å¦å­˜åœ¨UBï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs rust">error: Undefined Behavior: pointer to alloc999 was dereferenced after this allocation got freed<br>    -<span class="hljs-punctuation">-&gt;</span> /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/fmt/<span class="hljs-keyword">mod</span>.rs:<span class="hljs-number">2116</span>:<span class="hljs-number">1</span><br>     |<br><span class="hljs-number">2116</span> | fmt_refs! &#123; <span class="hljs-built_in">Debug</span>, Display, Octal, Binary, LowerHex, UpperHex, LowerExp, UpperExp &#125;<br>     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ pointer to alloc999 was dereferenced after this allocation got freed<br>     |<br>     = help: this indicates a bug <span class="hljs-keyword">in</span> the program: it performed an invalid operation, and caused Undefined Behavior<br>     = help: see https:<span class="hljs-comment">//doc.rust-lang.org/nightly/reference/behavior-considered-undefined.html for further information</span><br><br>     = note: inside `&lt;&amp;Hello&lt;<span class="hljs-type">i32</span>&gt; <span class="hljs-keyword">as</span> std::fmt::<span class="hljs-built_in">Debug</span>&gt;::fmt` at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/fmt/<span class="hljs-keyword">mod</span>.rs:<span class="hljs-number">2106</span>:<span class="hljs-number">71</span><br>     = note: inside `std::fmt::write` at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/fmt/<span class="hljs-keyword">mod</span>.rs:<span class="hljs-number">1168</span>:<span class="hljs-number">17</span><br>     = note: inside `&lt;std::io::StdoutLock <span class="hljs-keyword">as</span> std::io::Write&gt;::write_fmt` at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/io/<span class="hljs-keyword">mod</span>.rs:<span class="hljs-number">1653</span>:<span class="hljs-number">15</span><br>     = note: inside `&lt;&amp;std::io::Stdout <span class="hljs-keyword">as</span> std::io::Write&gt;::write_fmt` at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/io/stdio.rs:<span class="hljs-number">844</span>:<span class="hljs-number">9</span><br>     = note: inside `&lt;std::io::Stdout <span class="hljs-keyword">as</span> std::io::Write&gt;::write_fmt` at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/io/stdio.rs:<span class="hljs-number">818</span>:<span class="hljs-number">9</span><br>     = note: inside `std::io::stdio::print_to::&lt;std::io::Stdout&gt;` at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/io/stdio.rs:<span class="hljs-number">1186</span>:<span class="hljs-number">21</span><br>     = note: inside `std::io::_print` at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/io/stdio.rs:<span class="hljs-number">1199</span>:<span class="hljs-number">5</span><br>note: inside `&lt;Hello&lt;&amp;Hello&lt;<span class="hljs-type">i32</span>&gt;&gt; <span class="hljs-keyword">as</span> std::ops::<span class="hljs-built_in">Drop</span>&gt;::drop` at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/macros.rs:<span class="hljs-number">99</span>:<span class="hljs-number">9</span><br>    -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">32</span>:<span class="hljs-number">9</span><br>     |<br><span class="hljs-number">32</span>   |         <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Drop hello(&#123;&#125;, &#123;:?&#125;, &#123;:?&#125;)&quot;</span>, <span class="hljs-keyword">self</span>.<span class="hljs-number">0</span>, <span class="hljs-keyword">self</span>.<span class="hljs-number">1</span>, <span class="hljs-keyword">self</span>.<span class="hljs-number">2</span>);<br>     |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^<br>     = note: inside `std::ptr::drop_in_place::&lt;Hello&lt;&amp;Hello&lt;<span class="hljs-type">i32</span>&gt;&gt;&gt; - <span class="hljs-title function_ invoke__">shim</span>(<span class="hljs-title function_ invoke__">Some</span>(Hello&lt;&amp;Hello&lt;<span class="hljs-type">i32</span>&gt;&gt;))` at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ptr/<span class="hljs-keyword">mod</span>.rs:<span class="hljs-number">188</span>:<span class="hljs-number">1</span><br>note: inside `&lt;MyBox&lt;Hello&lt;&amp;Hello&lt;<span class="hljs-type">i32</span>&gt;&gt;&gt; <span class="hljs-keyword">as</span> std::ops::<span class="hljs-built_in">Drop</span>&gt;::drop` at src/main.rs:<span class="hljs-number">59</span>:<span class="hljs-number">13</span><br>    -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">59</span>:<span class="hljs-number">13</span><br>     |<br><span class="hljs-number">59</span>   |             ptr::<span class="hljs-title function_ invoke__">drop_in_place</span>(<span class="hljs-keyword">self</span>.v);<br>     |             ^^^^^^^^^^^^^^^^^^^^^^^^^^<br>     = note: inside `std::ptr::drop_in_place::&lt;MyBox&lt;Hello&lt;&amp;Hello&lt;<span class="hljs-type">i32</span>&gt;&gt;&gt;&gt; - <span class="hljs-title function_ invoke__">shim</span>(<span class="hljs-title function_ invoke__">Some</span>(MyBox&lt;Hello&lt;&amp;Hello&lt;<span class="hljs-type">i32</span>&gt;&gt;&gt;))` at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ptr/<span class="hljs-keyword">mod</span>.rs:<span class="hljs-number">188</span>:<span class="hljs-number">1</span><br>note: inside `main` at src/main.rs:<span class="hljs-number">13</span>:<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>ä¹‹æ‰€ä»¥ä¼šå‡ºç°ä¸Šè¿°ç»“æœï¼Œæ˜¯å› ä¸ºåœ¨<code>y</code>çš„ææ„å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨äº†<code>T: Hello::new(&quot;y&quot;, &amp;x)</code>çš„ææ„å‡½æ•°ï¼Œåœ¨<code>T</code>çš„ææ„å‡½æ•°ä¸­ä¼šæ‰“å°<code>&amp;x</code>çš„å€¼ï¼Œè€Œ<code>x</code>åœ¨æ­¤æ—¶å·²ç»è¢«ææ„äº†ï¼Œå®ƒçš„å€¼å˜æˆäº†<code>Hello(x,13,Invalid)</code>ã€‚å› æ­¤<code>y</code>ä¸­çš„<code>&amp;x</code>å˜æˆäº†æ‚¬å‚å¼•ç”¨ï¼Œå¹¶ä¸”åœ¨<code>T</code>çš„ææ„å‡½æ•°ä¸­ä½¿ç”¨äº†<code>&amp;x</code>ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸€ç§UBã€‚</p><p>ä¸ºäº†é˜²æ­¢UBï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<code>MyBox</code>ä¸­æ·»åŠ <code>PhantomData</code>å­—æ®µï¼Œè¡¨ç¤º<code>MyBox</code>æ‹¥æœ‰<code>T</code>ï¼Œä¼šåœ¨<code>MyBox</code>çš„ææ„å‡½æ•°ä¸­ææ„<code>T</code>ï¼ˆå½“ç„¶<code>MyBox</code>å¹¶ä¸æ‹¥æœ‰<code>T</code>ï¼Œä¹Ÿä¸ä¸€å®šä¼šææ„<code>T</code>ï¼‰ï¼Œå‘Šè¯‰ç¼–è¯‘å™¨å¯¹<code>MyBox</code>è¿›è¡ŒDrop checkæ£€æŸ¥ã€‚</p><p>ä¿®æ”¹ä¸Šè¿°ä»£ç ï¼Œæ·»åŠ <code>PhantomData</code>å­—æ®µï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#![allow(unused)]</span><br><span class="hljs-meta">#![feature(dropck_eyepatch)]</span><br><span class="hljs-keyword">use</span> std::alloc::&#123;GlobalAlloc, Layout, System&#125;;<br><span class="hljs-keyword">use</span> std::fmt;<br><span class="hljs-keyword">use</span> std::mem;<br><span class="hljs-keyword">use</span> std::ptr;<br><span class="hljs-keyword">use</span> std::marker::PhantomData;<br><br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> (y, x);<br>    x = Hello::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-number">13</span>);<br>    y = MyBox::<span class="hljs-title function_ invoke__">new</span>(Hello::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;y&quot;</span>, &amp;x));<br>&#125;<br><br><span class="hljs-meta">#[derive(Copy, Clone, Debug)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">State</span> &#123;<br>    Invalid,<br>    Valid,<br>&#125;<br><br><span class="hljs-meta">#[derive(Debug)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Hello</span>&lt;T: fmt::<span class="hljs-built_in">Debug</span>&gt;(&amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-type">str</span>, T, State);<br><br><span class="hljs-keyword">impl</span>&lt;T: fmt::<span class="hljs-built_in">Debug</span>&gt; Hello&lt;T&gt; &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(name: &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-type">str</span>, t: T) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-title function_ invoke__">Hello</span>(name, t, State::Valid)<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span>&lt;T: fmt::<span class="hljs-built_in">Debug</span>&gt; <span class="hljs-built_in">Drop</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Hello</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">drop</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Drop hello(&#123;&#125;, &#123;:?&#125;, &#123;:?&#125;)&quot;</span>, <span class="hljs-keyword">self</span>.<span class="hljs-number">0</span>, <span class="hljs-keyword">self</span>.<span class="hljs-number">1</span>, <span class="hljs-keyword">self</span>.<span class="hljs-number">2</span>);<br>        <span class="hljs-keyword">self</span>.<span class="hljs-number">2</span> = State::Invalid;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyBox</span>&lt;T&gt; &#123;<br>    v: *<span class="hljs-keyword">mut</span> T,<br>    _pd: PhantomData&lt;T&gt;<br>&#125;<br><br><span class="hljs-keyword">impl</span>&lt;T&gt; MyBox&lt;T&gt; &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(t: T) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">unsafe</span> &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">p</span> = System.<span class="hljs-title function_ invoke__">alloc</span>(Layout::array::&lt;T&gt;(<span class="hljs-number">1</span>).<span class="hljs-title function_ invoke__">unwrap</span>());<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">p</span> = p <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> T;<br>            ptr::<span class="hljs-title function_ invoke__">write</span>(p, t);<br>            MyBox &#123;<br>                v: p,<br>                _pd: PhantomData<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">impl</span>&lt;<span class="hljs-meta">#[may_dangle]</span> T&gt; <span class="hljs-built_in">Drop</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">MyBox</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">drop</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">unsafe</span> &#123;<br>            ptr::<span class="hljs-title function_ invoke__">drop_in_place</span>(<span class="hljs-keyword">self</span>.v);<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">p</span> = <span class="hljs-keyword">self</span>.v <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> _;<br>            System.<span class="hljs-title function_ invoke__">dealloc</span>(p, Layout::array::&lt;T&gt;(<span class="hljs-number">1</span>).<span class="hljs-title function_ invoke__">unwrap</span>());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘å°†ä¼šæŠ¥é”™ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust">error[E0597]: `x` does not live long enough<br>  -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">13</span>:<span class="hljs-number">36</span><br>   |<br><span class="hljs-number">13</span> |     y = MyBox::<span class="hljs-title function_ invoke__">new</span>(Hello::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;y&quot;</span>, &amp;x));<br>   |                                    ^^ borrowed value does not live long enough<br><span class="hljs-number">14</span> | &#125;<br>   | -<br>   | |<br>   | `x` dropped here <span class="hljs-keyword">while</span> still borrowed<br>   | borrow might be used here, when `y` is dropped and runs the `<span class="hljs-built_in">Drop</span>` code <span class="hljs-keyword">for</span> <span class="hljs-title class_">type</span> `MyBox`<br>   |<br>   = note: values <span class="hljs-keyword">in</span> a scope are dropped <span class="hljs-keyword">in</span> the opposite order they are defined<br></code></pre></td></tr></table></figure><p>è¿™è¡¨æ˜Drop checkerèµ·äº†ä½œç”¨ï¼Œæœ‰æ•ˆé˜²æ­¢å‡ºç°UBã€‚</p><p>ä½†æ˜¯ï¼Œè¿™ä¼¼ä¹ä¸æœ€åˆç‰ˆçš„ä»£ç çš„ç¼–è¯‘æ˜¯ä¸€æ ·çš„ï¼Œé‚£è¦<code>PhantomData</code>å’Œ<code>may_dangle</code>æœ‰ä»€ä¹ˆç”¨ï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯æœ‰ç”¨çš„ï¼Œå¦‚æœ<code>MyBox&lt;T&gt;</code>ä¸­çš„<code>T</code>æ²¡æœ‰å®ç°Drop traitï¼Œé‚£ä¹ˆä¸Šè¿°ä»£ç å°†ä¼šç¼–è¯‘é€šè¿‡ã€‚</p><p>åˆ é™¤<code>Hello</code>çš„ææ„å‡½æ•°ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#![allow(unused)]</span><br><span class="hljs-meta">#![feature(dropck_eyepatch)]</span><br><span class="hljs-keyword">use</span> std::alloc::&#123;GlobalAlloc, Layout, System&#125;;<br><span class="hljs-keyword">use</span> std::fmt;<br><span class="hljs-keyword">use</span> std::mem;<br><span class="hljs-keyword">use</span> std::ptr;<br><span class="hljs-keyword">use</span> std::marker::PhantomData;<br><br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> (y, x);<br>    x = Hello::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-number">13</span>);<br>    y = MyBox::<span class="hljs-title function_ invoke__">new</span>(Hello::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">&quot;y&quot;</span>, &amp;x));<br>&#125;<br><br><span class="hljs-meta">#[derive(Copy, Clone, Debug)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">State</span> &#123;<br>    Invalid,<br>    Valid,<br>&#125;<br><br><span class="hljs-meta">#[derive(Debug)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Hello</span>&lt;T: fmt::<span class="hljs-built_in">Debug</span>&gt;(&amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-type">str</span>, T, State);<br><br><span class="hljs-keyword">impl</span>&lt;T: fmt::<span class="hljs-built_in">Debug</span>&gt; Hello&lt;T&gt; &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(name: &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-type">str</span>, t: T) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-title function_ invoke__">Hello</span>(name, t, State::Valid)<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyBox</span>&lt;T&gt; &#123;<br>    v: *<span class="hljs-keyword">mut</span> T,<br>    _pd: PhantomData&lt;T&gt;<br>&#125;<br><br><span class="hljs-keyword">impl</span>&lt;T&gt; MyBox&lt;T&gt; &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(t: T) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">unsafe</span> &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">p</span> = System.<span class="hljs-title function_ invoke__">alloc</span>(Layout::array::&lt;T&gt;(<span class="hljs-number">1</span>).<span class="hljs-title function_ invoke__">unwrap</span>());<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">p</span> = p <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> T;<br>            ptr::<span class="hljs-title function_ invoke__">write</span>(p, t);<br>            MyBox &#123;<br>                v: p,<br>                _pd: PhantomData<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">impl</span>&lt;<span class="hljs-meta">#[may_dangle]</span> T&gt; <span class="hljs-built_in">Drop</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">MyBox</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">drop</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">unsafe</span> &#123;<br>            ptr::<span class="hljs-title function_ invoke__">drop_in_place</span>(<span class="hljs-keyword">self</span>.v);<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">p</span> = <span class="hljs-keyword">self</span>.v <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> _;<br>            System.<span class="hljs-title function_ invoke__">dealloc</span>(p, Layout::array::&lt;T&gt;(<span class="hljs-number">1</span>).<span class="hljs-title function_ invoke__">unwrap</span>());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘å°†ä¼šé€šè¿‡ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust">Compiling playground v0.<span class="hljs-number">0.1</span> (/playground)<br>   Finished dev [unoptimized + debuginfo] <span class="hljs-title function_ invoke__">target</span>(s) <span class="hljs-keyword">in</span> <span class="hljs-number">1.53</span>s<br>    Running `target/debug/playground`<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯å› ä¸ºï¼Œå¦‚æœ<code>MyBox&lt;T&gt;</code>ä¸­çš„<code>T</code>æ²¡æœ‰å®ç°<code>Drop Trait</code>ï¼Œå°±ç®—<code>T</code>ä¸­å­˜åœ¨æ‚¬å‚å¼•ç”¨ï¼Œä¹Ÿä¸å¯èƒ½åœ¨<code>MyBox</code>çš„ææ„å‡½æ•°ä¸­é€šè¿‡<code>T</code>çš„ææ„å‡½æ•°è®¿é—®è¿™ä¸ªæ‚¬å‚å¼•ç”¨ï¼Œå› æ­¤ä¸ä¼šå‡ºç°UBï¼Œ</p><p>å¦‚æœä¸ä½¿ç”¨<code>may_dangle</code>å’Œ<code>PhantomData</code>ï¼Œé‚£ä¹ˆå³ä½¿<code>T</code>æ²¡æœ‰å®ç°Drop traitï¼Œä»£ç ä¹Ÿä¸ä¼šé€šè¿‡ç¼–è¯‘ï¼Œå³ç¼–è¯‘å™¨ä¼šæ‹’ç»æ‰æ­£ç¡®çš„ä»£ç ï¼Œè¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æ‰€æœŸæœ›çš„ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç»¼ä¸Šæ‰€è¿°ï¼Œ<code>may_dangle</code>å’Œ<code>PhantomData</code>ç»“åˆä½¿ç”¨å°†ä¼šæœ‰å¦‚ä¸‹æ•ˆæœï¼š</p><ul><li>å¦‚æœ<code>MyBox&lt;T&gt;</code>ä¸­çš„<code>T</code>å®ç°äº†Drop Traitï¼Œé‚£ä¹ˆDrop Checkerä¼šè¦æ±‚<code>T</code>çš„ç”Ÿå‘½å‘¨æœŸä¸¥æ ¼é•¿äº<code>MyBox</code>ï¼›</li><li>å¦‚æœ<code>MyBox&lt;T&gt;</code>ä¸­çš„<code>T</code>æ²¡æœ‰å®ç°Drop Traitï¼Œé‚£ä¹ˆDrop Checkerä¸ä¼šä¼šè¦æ±‚<code>T</code>çš„ç”Ÿå‘½å‘¨æœŸä¸¥æ ¼é•¿äº<code>MyBox</code>ã€‚</li></ul><p>å¦‚æœæ²¡æœ‰ä½¿ç”¨<code>may_dangle</code>å’Œ<code>PhantomData</code>ï¼Œé‚£ä¹ˆæ— è®º<code>T</code>æœ‰æ²¡æœ‰å®ç°Drop Traitï¼ŒDrop Checkeréƒ½ä¼šè¦æ±‚<code>T</code>çš„ç”Ÿå‘½å‘¨æœŸä¸¥æ ¼é•¿äº<code>MyBox</code>ã€‚</p><p>å‚è€ƒï¼š</p><ul><li><a href="https://zhuanlan.zhihu.com/p/383004091">https://zhuanlan.zhihu.com/p/383004091</a></li><li><a href="https://stackoverflow.com/questions/42708462/why-is-it-useful-to-use-phantomdata-to-inform-the-compiler-that-a-struct-owns-a">https://stackoverflow.com/questions/42708462/why-is-it-useful-to-use-phantomdata-to-inform-the-compiler-that-a-struct-owns-a</a></li><li>æ¥è‡ªç¾¤å‹çš„ç­”ç–‘è§£æƒ‘ğŸ˜€</li></ul>]]></content>
    
    
    <categories>
      
      <category>rust</category>
      
    </categories>
    
    
    <tags>
      
      <tag>rust</tag>
      
      <tag>note</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2022/05/22/hello-world/"/>
    <url>/2022/05/22/hello-world/</url>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo new <span class="hljs-string">&quot;My New Post&quot;</span><br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo server<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo generate<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo deploy<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
